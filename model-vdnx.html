<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <title>VDNX</title>
  </head>

  <body>
    <main class="main">
      <div class="fill">
        <div class="back">
          <img src="assets/logo.svg" alt="–õ–æ–≥–æ—Ç–∏–ø" class="back__logo" />
          <p class="copyright">
            ¬©Ô∏è –í—Å–µ –ø—Ä–∞–≤–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç "MOS.RU" –ø—Ä–∏ –ê–ø–ø–∞—Ä–∞—Ç–µ –ú—ç—Ä–∞ –∏ –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞
            –ú–æ—Å–∫–≤—ã 2023 –≥–æ–¥
          </p>
        </div>

        <div class="scene" id="camera-wrapper">
          <video id="cam" autoplay playsinline muted></video>

          <!-- –£–±–∏—Ä–∞–µ–º camera-controls —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ —Å–≤–æ–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ -->
          <model-viewer
            id="model"
            alt="3D Model"
            src="./assets/model/Horse_animation.gltf"
            ios-src="./assets/ios/hors_anim.usdz"
            ar
            ar-modes="webxr scene-viewer quick-look"
            autoplay
            style="display: none">
            <!-- –°–∫—Ä—ã–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é -->
          </model-viewer>

          <div class="filter-click-area" id="filterClickArea"></div>

          <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –ª—å–¥–∞ -->
          <div class="ice-overlay-container">
            <div class="ice-crack" id="iceCrack"></div>
            <img
              class="ice-overlay active"
              id="filter1"
              src="assets/ice-1.png" />
            <img class="ice-overlay" id="filter2" src="assets/ice-2.png" />
            <img class="ice-overlay" id="filter3" src="assets/ice-4.png" />
          </div>

          <!-- –≠—Ñ—Ñ–µ–∫—Ç —Å–Ω–µ–∂–∏–Ω–æ–∫ -->
          <div class="snowflakes" id="snowflakes"></div>

          <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
          <div class="loading-progress" id="loadingProgress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
          </div>

          <!-- –ù–ê–®–ê –ö–ù–û–ü–ö–ê AR -->
          <button class="ar-button" id="arButton">
            <span class="ar-button-icon">üëÅÔ∏è</span>
            <span class="ar-button-text">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ AR</span>
          </button>
        </div>

        <div class="modal-overlay" id="arExitModal" style="display: none">
          <div class="modal-content">
            <h2 class="modal-title">–°–Ω–∏–º–æ–∫ —Å–¥–µ–ª–∞–Ω!</h2>
            <p class="modal-message">
              –í–∞—à–µ —Ñ–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –≤–∞—à—É –±–∏–±–ª–∏–æ—Ç–µ–∫—É, –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–º –ø–æ
              —Å—Å—ã–ª–∫–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é
            </p>
            <button class="modal-button" id="closeModalBtn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <button class="modal-button modal-button--more" id="moreBtn">
              –ó–∞–ø–∏—Å–∞—Ç—å –µ—â–µ
            </button>
          </div>
        </div>
      </div>
    </main>

    <style>
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100dvh;
        overflow: hidden;
        font-family: sans-serif;
        touch-action: manipulation;
      }

      .fill {
        position: relative;
        width: 100%;
        height: 100dvh;
        display: flex;
        flex-direction: column;
        background: url("assets/background.png");
        background-repeat: repeat;
        background-size: cover;
      }

      .back {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 1;
        padding: 49px 24px 24px 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
      }

      .copyright {
        font-weight: 400;
        font-size: 14px;
        letter-spacing: -0.01em;
        text-align: center;
        color: #8b98aa;
      }

      #camera-wrapper {
        position: absolute;
        z-index: 2;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
      }

      video {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 0;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ç–∞—è–Ω–∏—è –ª—å–¥–∞ */
      .ice-overlay-container {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
        pointer-events: none;
      }

      .ice-overlay {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        mix-blend-mode: screen;
        transition: opacity 2.5s cubic-bezier(0.4, 0, 0.2, 1),
          filter 3s cubic-bezier(0.4, 0, 0.2, 1),
          transform 3s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        filter: brightness(1.2) contrast(1.2);
        transform: scale(1);
      }

      .ice-overlay.active {
        opacity: 1;
        filter: brightness(1) contrast(1);
        animation: iceGlow 3s ease-in-out infinite alternate;
      }

      /* Ice-4 –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∏–¥–∏–º—ã–º */
      .ice-overlay.melting {
        opacity: 1 !important;
        filter: brightness(1.5) contrast(0.8) blur(2px);
        transform: scale(1.02);
        animation: iceMelt 4s forwards;
      }

      @keyframes iceGlow {
        0% {
          filter: brightness(1) contrast(1)
            drop-shadow(0 0 5px rgba(173, 216, 230, 0.3));
        }
        100% {
          filter: brightness(1.1) contrast(1.1)
            drop-shadow(0 0 15px rgba(173, 216, 230, 0.5));
        }
      }

      @keyframes iceMelt {
        0%,
        100% {
          opacity: 1 !important;
        }
      }

      /* –≠—Ñ—Ñ–µ–∫—Ç —Å–Ω–µ–∂–∏–Ω–æ–∫ */
      .snowflakes {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2;
        opacity: 0;
        transition: opacity 1s ease;
      }

      .snowflakes.active {
        opacity: 1;
      }

      .snowflake {
        position: absolute;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        filter: blur(0.5px);
        animation: fall linear infinite;
      }

      @keyframes fall {
        to {
          transform: translateY(100vh);
        }
      }

      /* Model viewer */
      model-viewer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        opacity: 0;
        pointer-events: none;
      }

      model-viewer.visible {
        opacity: 1;
        pointer-events: auto;
        z-index: 3;
        display: block !important;
      }

      /* –ö–ù–û–ü–ö–ê AR */
      .ar-button {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50px;
        padding: 16px 40px;
        border: none;
        color: white;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        z-index: 10;
        min-width: 240px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      .ar-button.visible {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }

      .ar-button:hover {
        transform: translateX(-50%) translateY(-2px);
        box-shadow: 0 15px 35px rgba(102, 126, 234, 0.5);
      }

      .ar-button:active {
        transform: translateX(-50%) translateY(0);
      }

      .ar-button-icon {
        font-size: 22px;
      }

      .ar-button-text {
        font-size: 16px;
      }

      /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
      .loading-progress {
        position: absolute;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        overflow: hidden;
        display: none;
        z-index: 4;
      }

      .loading-progress.active {
        display: block;
      }

      .loading-progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4fc3f7, #81c784);
        transition: width 0.3s ease;
      }

      /* –û–±–ª–∞—Å—Ç—å –∫–ª–∏–∫–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
      .filter-click-area {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 3;
        cursor: pointer;
      }

      .filter-click-area.disabled {
        pointer-events: none;
        cursor: default;
      }

      /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .modal-overlay.show {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 20px;
        max-width: 400px;
        text-align: center;
        margin: 20px;
      }

      .modal-title {
        margin-bottom: 15px;
        color: #333;
      }

      .modal-message {
        margin-bottom: 20px;
        color: #666;
        line-height: 1.5;
      }

      .modal-button {
        background: #4fc3f7;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        margin: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s ease;
      }

      .modal-button:hover {
        background: #29b6f6;
      }

      .modal-button--more {
        background: #81c784;
      }

      .modal-button--more:hover {
        background: #66bb6a;
      }

      /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–Ω–æ–ø–∫—É model-viewer */
      model-viewer::part(default-ar-button),
      model-viewer::part(ar-button) {
        display: none !important;
      }
    </style>

    <script>
      // –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
      const video = document.getElementById("cam");
      const cameraWrapper = document.getElementById("camera-wrapper");
      const filter1 = document.getElementById("filter1");
      const filter2 = document.getElementById("filter2");
      const filter3 = document.getElementById("filter3");
      const snowflakes = document.getElementById("snowflakes");
      const filterClickArea = document.getElementById("filterClickArea");
      const modelViewer = document.getElementById("model");
      const loadingProgress = document.getElementById("loadingProgress");
      const loadingProgressBar = document.getElementById("loadingProgressBar");
      const arExitModal = document.getElementById("arExitModal");
      const closeModalBtn = document.getElementById("closeModalBtn");
      const moreBtn = document.getElementById("moreBtn");
      const arButton = document.getElementById("arButton");

      // –ú–∞—Å—Å–∏–≤—ã –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
      const filters = [filter1, filter2, filter3];
      let currentFilterIndex = 0;
      let isMelting = false;
      let currentStream = null;
      let wasInAR = false;
      let filtersCompleted = false;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã
      async function initCamera() {
        try {
          console.log("–ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã...");

          if (currentStream) {
            currentStream.getTracks().forEach((track) => track.stop());
          }

          const constraints = {
            video: {
              facingMode: "environment",
              width: {ideal: 1280},
              height: {ideal: 720},
            },
            audio: false,
          };

          console.log("–ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...");

          let stream;
          try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            console.log("–ö–∞–º–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω–∞ —Å facingMode: environment");
          } catch (err) {
            console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É, –ø—Ä–æ–±—É–µ–º user...");
            try {
              stream = await navigator.mediaDevices.getUserMedia({
                video: {facingMode: "user"},
                audio: false,
              });
              console.log("–ö–∞–º–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω–∞ —Å facingMode: user");
            } catch (err2) {
              console.log("–ü—Ä–æ–±—É–µ–º –ª—é–±—É—é –∫–∞–º–µ—Ä—É...");
              stream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: false,
              });
              console.log("–ö–∞–º–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω–∞ (–ª—é–±–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è)");
            }
          }

          currentStream = stream;
          video.srcObject = stream;

          video.onloadedmetadata = () => {
            console.log(
              "–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, —Ä–∞–∑–º–µ—Ä—ã:",
              video.videoWidth,
              "x",
              video.videoHeight
            );
          };

          video.onerror = (e) => {
            console.error("–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ:", e);
          };

          console.log("–ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞");
          return true;
        } catch (err) {
          console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã:", err);
          return false;
        }
      }

      // –°–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–µ–∂–∏–Ω–æ–∫
      function createSnowflakes() {
        snowflakes.innerHTML = "";
        for (let i = 0; i < 30; i++) {
          const snowflake = document.createElement("div");
          snowflake.className = "snowflake";

          const size = Math.random() * 4 + 2;
          const left = Math.random() * 100;
          const duration = Math.random() * 10 + 10;
          const delay = Math.random() * 5;

          snowflake.style.width = `${size}px`;
          snowflake.style.height = `${size}px`;
          snowflake.style.left = `${left}%`;
          snowflake.style.animationDuration = `${duration}s`;
          snowflake.style.animationDelay = `${delay}s`;

          snowflakes.appendChild(snowflake);
        }
      }

      // –°–º–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞
      function changeFilter() {
        console.log("–ö–ª–∏–∫! –¢–µ–∫—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä:", currentFilterIndex);

        if (filtersCompleted) {
          console.log("–§–∏–ª—å—Ç—Ä—ã —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã");
          return;
        }

        if (isMelting) {
          console.log("–≠—Ñ—Ñ–µ–∫—Ç —Ç–∞—è–Ω–∏—è —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω");
          return;
        }

        // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä
        if (currentFilterIndex < filters.length) {
          filters[currentFilterIndex].classList.remove("active");
        }

        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É
        currentFilterIndex++;

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Ñ–∏–ª—å—Ç—Ä
        if (currentFilterIndex < filters.length) {
          filters[currentFilterIndex].classList.add("active");
          console.log("–ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏ –Ω–∞ —Ñ–∏–ª—å—Ç—Ä:", currentFilterIndex + 1);

          // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∏–ª—å—Ç—Ä (ice-4)
          if (currentFilterIndex === filters.length - 1) {
            console.log("–î–æ—Å—Ç–∏–≥–Ω—É—Ç ice-4, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç");
            filtersCompleted = true;

            setTimeout(() => {
              startFinalEffect();
            }, 300);
          }
        }
      }

      // –§–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
      function startFinalEffect() {
        console.log("–ó–∞–ø—É—Å–∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞");
        isMelting = true;

        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–Ω–µ–∂–∏–Ω–∫–∏
        snowflakes.classList.add("active");
        createSnowflakes();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        loadingProgress.classList.add("active");

        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 10;
          if (progress > 100) progress = 100;
          loadingProgressBar.style.width = `${progress}%`;

          console.log("–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏:", progress + "%");

          if (progress >= 100) {
            clearInterval(progressInterval);

            console.log("–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω –Ω–∞ 100%");

            // –ó–∞–ø—É—Å–∫–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç "—Ç–∞—è–Ω–∏—è"
            setTimeout(() => {
              console.log("–ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Ç–∞—è–Ω–∏—è –¥–ª—è ice-4");
              // Ice-4 –ø–æ–ª—É—á–∞–µ—Ç melting –Ω–æ –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∏–¥–∏–º—ã–º!
              filters[currentFilterIndex].classList.add("melting");

              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–µ–ª—å
              unlockModel();

              // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
              setTimeout(() => {
                loadingProgress.classList.remove("active");
                snowflakes.classList.remove("active");
                console.log("–≠—Ñ—Ñ–µ–∫—Ç—ã —Å–∫—Ä—ã—Ç—ã, –º–æ–¥–µ–ª—å –≤–∏–¥–Ω–∞");
              }, 2000);
            }, 1000);
          }
        }, 200);
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–µ–ª—å
      function unlockModel() {
        console.log("–ü–æ–∫–∞–∑—ã–≤–∞–µ–º 3D –º–æ–¥–µ–ª—å");

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º model-viewer
        modelViewer.style.display = "block";
        setTimeout(() => {
          modelViewer.classList.add("visible");
        }, 100);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É AR
        setTimeout(() => {
          arButton.classList.add("visible");
          console.log("–ö–Ω–æ–ø–∫–∞ AR –≤–∏–¥–Ω–∞ –∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞");
        }, 800);

        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ –æ–±–ª–∞—Å—Ç–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        filterClickArea.classList.add("disabled");
      }

      // –ó–∞–ø—É—Å–∫ AR
      async function startAR() {
        console.log("–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ AR");

        try {
          // –ü—Ä–æ–±—É–µ–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å AR —á–µ—Ä–µ–∑ API model-viewer
          if (modelViewer.activateAR) {
            console.log("–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º AR —á–µ—Ä–µ–∑ activateAR()");
            await modelViewer.activateAR();
            wasInAR = true;
            return;
          }

          // –ï—Å–ª–∏ activateAR –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã
          console.log("activateAR –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã...");

          // –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ canActivateAR
          if (modelViewer.canActivateAR) {
            console.log("–ü—Ä–æ–≤–µ—Ä—è–µ–º canActivateAR...");
            if (await modelViewer.canActivateAR()) {
              console.log("canActivateAR –≤–µ—Ä–Ω—É–ª true, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º...");
              modelViewer.activateAR();
              wasInAR = true;
              return;
            }
          }

          console.log("AR –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ");
          alert(
            "AR —Ä–µ–∂–∏–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ Safari –Ω–∞ iOS –∏–ª–∏ Chrome –Ω–∞ Android."
          );
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ AR:", error);
          alert(
            "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å AR —Ä–µ–∂–∏–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É AR –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ."
          );
        }
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      function showModal() {
        console.log("–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ AR");
        arExitModal.style.display = "flex";
        arExitModal.classList.add("show");
      }

      // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      function hideModal() {
        console.log("–°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ");
        arExitModal.style.display = "none";
        arExitModal.classList.remove("show");
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      window.addEventListener("load", async () => {
        console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...");

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
        await initCamera();

        // –°–æ–∑–¥–∞–µ–º —Å–Ω–µ–∂–∏–Ω–∫–∏
        createSnowflakes();

        console.log(
          "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ö–ª–∏–∫–∞–π—Ç–µ –ø–æ —ç–∫—Ä–∞–Ω—É –¥–ª—è —Å–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤."
        );
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      filterClickArea.addEventListener("click", changeFilter);
      arButton.addEventListener("click", startAR);
      closeModalBtn.addEventListener("click", hideModal);
      moreBtn.addEventListener("click", hideModal);

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
      arExitModal.addEventListener("click", (e) => {
        if (e.target === arExitModal) {
          hideModal();
        }
      });

      // –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –í–´–•–û–î–ê –ò–ó AR
      document.addEventListener("visibilitychange", () => {
        console.log("Visibility change:", document.visibilityState);

        if (document.visibilityState === "visible") {
          console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞–ª–∞ –≤–∏–¥–∏–º–æ–π");
          if (wasInAR && filtersCompleted) {
            console.log("–ë—ã–ª–∏ –≤ AR –∏ —Ñ–∏–ª—å—Ç—Ä—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É");
            setTimeout(() => {
              showModal();
            }, 500);
            wasInAR = false;
          }
        }

        if (document.visibilityState === "hidden") {
          console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞ - –≤–æ–∑–º–æ–∂–Ω–æ –≤—Ö–æ–¥ –≤ AR");
          wasInAR = true;
        }
      });

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ AR —Å–æ–±—ã—Ç–∏–π model-viewer
      modelViewer.addEventListener("ar-status", (event) => {
        console.log("AR —Å—Ç–∞—Ç—É—Å:", event.detail.status);

        if (event.detail.status === "session-started") {
          console.log("AR —Å–µ—Å—Å–∏—è –Ω–∞—á–∞–ª–∞—Å—å");
          wasInAR = true;
          // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ AR
          arButton.classList.remove("visible");
        }

        if (event.detail.status === "session-ended") {
          console.log("AR —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å");
          if (wasInAR && filtersCompleted) {
            console.log("–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ");
            setTimeout(() => {
              showModal();
            }, 300);
          }
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞
          arButton.classList.add("visible");
          wasInAR = false;
        }
      });

      // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      window.debug = {
        startAR: startAR,
        unlockModel: unlockModel,
        showModal: showModal,
        simulateClicks: () => {
          changeFilter();
          setTimeout(() => changeFilter(), 500);
        },
        getState: () => ({
          currentFilterIndex,
          filtersCompleted,
          isMelting,
          ice4Active: filter3.classList.contains("active"),
          ice4Visible: window.getComputedStyle(filter3).opacity,
          modelVisible: modelViewer.classList.contains("visible"),
          arButtonVisible: arButton.classList.contains("visible"),
          wasInAR,
        }),
      };

      console.log("–¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ window.debug");
      console.log("debug.simulateClicks() - –±—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ");
      console.log("debug.startAR() - –∑–∞–ø—É—Å–∫ AR");
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <title>VDNX</title>
  </head>

  <body>
    <main class="main">
      <div class="fill">
        <div class="back">
          <img src="assets/logo.svg" alt="Логотип" class="back__logo" />
          <p class="copyright">
            ©️ Все права принадлежат "MOS.RU" при Аппарате Мэра и Правительства
            Москвы 2023 год
          </p>
        </div>

        <div class="scene" id="camera-wrapper">
          <video id="cam" autoplay playsinline muted></video>

          <!-- Убираем camera-controls чтобы управлять через свои обработчики -->
          <model-viewer
            id="model"
            alt="3D Model"
            src="./assets/model/Horse_animation.gltf"
            camera-controls
            ar
            ar-modes="webxr scene-viewer quick-look"
            autoplay
            style="display: none">
            <!-- Скрываем по умолчанию -->
          </model-viewer>

          <div class="filter-click-area" id="filterClickArea"></div>

          <!-- Контейнер для эффектов льда -->
          <div class="ice-overlay-container">
            <div class="ice-crack" id="iceCrack"></div>
            <img
              class="ice-overlay active"
              id="filter1"
              src="assets/ice-1.png" />
            <img class="ice-overlay" id="filter2" src="assets/ice-2.png" />
            <img class="ice-overlay" id="filter3" src="assets/ice-4.png" />
          </div>

          <!-- Эффект снежинок -->
          <div class="snowflakes" id="snowflakes"></div>

          <!-- Индикатор загрузки -->
          <div class="loading-progress" id="loadingProgress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
          </div>
        </div>

        <div class="modal-overlay" id="arExitModal" style="display: none">
          <div class="modal-content">
            <h2 class="modal-title">Снимок сделан!</h2>
            <p class="modal-message">
              Ваше фото сохранено в вашу библиотеку, вы можете поделиться им по
              ссылке или отправить напрямую
            </p>
            <button class="modal-button" id="closeModalBtn">Продолжить</button>
            <button class="modal-button modal-button--more" id="moreBtn">
              Записать еще
            </button>
          </div>
        </div>
      </div>
    </main>

    <style>
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100dvh;
        overflow: hidden;
        font-family: sans-serif;
        touch-action: manipulation;
      }

      .fill {
        position: relative;
        width: 100%;
        height: 100dvh;
        display: flex;
        flex-direction: column;
        background: url("assets/background.png");
        background-repeat: repeat;
        background-size: cover;
      }

      .back {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 1;
        padding: 49px 24px 24px 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
      }

      .copyright {
        font-weight: 400;
        font-size: 14px;
        letter-spacing: -0.01em;
        text-align: center;
        color: #8b98aa;
      }

      #camera-wrapper {
        position: absolute;
        z-index: 2;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
      }

      video {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 0;
      }

      /* Стили для эффекта таяния льда */
      .ice-overlay-container {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
        pointer-events: none;
      }

      .ice-overlay {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        mix-blend-mode: screen;
        transition: opacity 2.5s cubic-bezier(0.4, 0, 0.2, 1),
          filter 3s cubic-bezier(0.4, 0, 0.2, 1),
          transform 3s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        filter: brightness(1.2) contrast(1.2);
        transform: scale(1);
      }

      .ice-overlay.active {
        opacity: 1;
        filter: brightness(1) contrast(1);
        animation: iceGlow 3s ease-in-out infinite alternate;
      }

      /* Ice-4 остается видимым */
      .ice-overlay.melting {
        opacity: 1 !important;
        filter: brightness(1.5) contrast(0.8) blur(2px);
        transform: scale(1.02);
        animation: iceMelt 4s forwards;
      }

      @keyframes iceGlow {
        0% {
          filter: brightness(1) contrast(1)
            drop-shadow(0 0 5px rgba(173, 216, 230, 0.3));
        }
        100% {
          filter: brightness(1.1) contrast(1.1)
            drop-shadow(0 0 15px rgba(173, 216, 230, 0.5));
        }
      }

      @keyframes iceMelt {
        0%,
        100% {
          opacity: 1 !important;
        }
      }

      /* Эффект снежинок */
      .snowflakes {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2;
        opacity: 0;
        transition: opacity 1s ease;
      }

      .snowflakes.active {
        opacity: 1;
      }

      .snowflake {
        position: absolute;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        filter: blur(0.5px);
        animation: fall linear infinite;
      }

      @keyframes fall {
        to {
          transform: translateY(100vh);
        }
      }

      /* Model viewer */
      model-viewer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        opacity: 0;
        pointer-events: none;
      }

      model-viewer.visible {
        opacity: 1;
        pointer-events: auto;
        z-index: 3;
        display: block !important;
      }

      model-viewer.interactive {
        pointer-events: auto;
        cursor: grab;
      }

      model-viewer.interactive:active {
        cursor: grabbing;
      }

      model-viewer::part(default-ar-button) {
        pointer-events: auto;
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50px;
        padding: 14px 32px;
        border: none;
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        z-index: 10;
        min-width: 200px;
        text-align: center;
        font-family: inherit;
        transition: opacity 1s ease 2s, visibility 1s ease 2s,
          transform 0.3s ease;
        opacity: 0;
        visibility: hidden;
      }

      model-viewer.visible::part(default-ar-button) {
        opacity: 1;
        visibility: visible;
      }

      model-viewer::part(default-exit-webxr-ar-button) {
        display: none;
      }

      model-viewer::part(default-ar-button):hover {
        transform: translateX(-50%) translateY(-2px);
        box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
      }

      model-viewer::part(default-ar-button):active {
        transform: translateX(-50%) translateY(0);
      }

      model-viewer::part(default-ar-button):focus {
        outline: 2px solid rgba(102, 126, 234, 0.5);
        outline-offset: 2px;
      }

      .ar-button.visible {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }

      .ar-button:hover {
        transform: translateX(-50%) translateY(-2px);
        box-shadow: 0 15px 35px rgba(102, 126, 234, 0.5);
      }

      .ar-button:active {
        transform: translateX(-50%) translateY(0);
      }

      .ar-button-icon {
        font-size: 22px;
      }

      .ar-button-text {
        font-size: 16px;
      }

      /* Индикатор загрузки */
      .loading-progress {
        position: absolute;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        overflow: hidden;
        display: none;
        z-index: 4;
      }

      .loading-progress.active {
        display: block;
      }

      .loading-progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #4fc3f7, #81c784);
        transition: width 0.3s ease;
      }

      /* Область клика для фильтров */
      .filter-click-area {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 3;
        cursor: pointer;
      }

      .filter-click-area.disabled {
        pointer-events: none;
        cursor: default;
      }

      /* Модальное окно */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .modal-overlay.show {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 20px;
        max-width: 400px;
        text-align: center;
        margin: 20px;
      }

      .modal-title {
        margin-bottom: 15px;
        color: #333;
      }

      .modal-message {
        margin-bottom: 20px;
        color: #666;
        line-height: 1.5;
      }

      .modal-button {
        background: #4fc3f7;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        margin: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s ease;
      }

      .modal-button:hover {
        background: #29b6f6;
      }

      .modal-button--more {
        background: #81c784;
      }

      .modal-button--more:hover {
        background: #66bb6a;
      }

      /* Скрываем стандартную кнопку model-viewer */
      model-viewer::part(default-ar-button),
      model-viewer::part(ar-button) {
        display: none !important;
      }
    </style>

    <script>
      // Основные элементы
      const video = document.getElementById("cam");
      const cameraWrapper = document.getElementById("camera-wrapper");
      const filter1 = document.getElementById("filter1");
      const filter2 = document.getElementById("filter2");
      const filter3 = document.getElementById("filter3");
      const snowflakes = document.getElementById("snowflakes");
      const filterClickArea = document.getElementById("filterClickArea");
      const modelViewer = document.getElementById("model");
      const loadingProgress = document.getElementById("loadingProgress");
      const loadingProgressBar = document.getElementById("loadingProgressBar");
      const arExitModal = document.getElementById("arExitModal");
      const closeModalBtn = document.getElementById("closeModalBtn");
      const moreBtn = document.getElementById("moreBtn");
      const arButton = document.getElementById("arButton");

      // Массивы и переменные
      const filters = [filter1, filter2, filter3];
      let currentFilterIndex = 0;
      let isMelting = false;
      let currentStream = null;
      let wasInAR = false;
      let filtersCompleted = false;

      // Инициализация камеры
      async function initCamera() {
        try {
          console.log("Запуск инициализации камеры...");

          if (currentStream) {
            currentStream.getTracks().forEach((track) => track.stop());
          }

          const constraints = {
            video: {
              facingMode: "environment",
              width: {ideal: 1280},
              height: {ideal: 720},
            },
            audio: false,
          };

          console.log("Пытаемся получить доступ к камере...");

          let stream;
          try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            console.log("Камера получена с facingMode: environment");
          } catch (err) {
            console.log("Не удалось получить заднюю камеру, пробуем user...");
            try {
              stream = await navigator.mediaDevices.getUserMedia({
                video: {facingMode: "user"},
                audio: false,
              });
              console.log("Камера получена с facingMode: user");
            } catch (err2) {
              console.log("Пробуем любую камеру...");
              stream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: false,
              });
              console.log("Камера получена (любая доступная)");
            }
          }

          currentStream = stream;
          video.srcObject = stream;

          video.onloadedmetadata = () => {
            console.log(
              "Видео загружено, размеры:",
              video.videoWidth,
              "x",
              video.videoHeight
            );
          };

          video.onerror = (e) => {
            console.error("Ошибка видео:", e);
          };

          console.log("Камера успешно инициализирована");
          return true;
        } catch (err) {
          console.error("Критическая ошибка при инициализации камеры:", err);
          return false;
        }
      }

      // Создание снежинок
      function createSnowflakes() {
        snowflakes.innerHTML = "";
        for (let i = 0; i < 30; i++) {
          const snowflake = document.createElement("div");
          snowflake.className = "snowflake";

          const size = Math.random() * 4 + 2;
          const left = Math.random() * 100;
          const duration = Math.random() * 10 + 10;
          const delay = Math.random() * 5;

          snowflake.style.width = `${size}px`;
          snowflake.style.height = `${size}px`;
          snowflake.style.left = `${left}%`;
          snowflake.style.animationDuration = `${duration}s`;
          snowflake.style.animationDelay = `${delay}s`;

          snowflakes.appendChild(snowflake);
        }
      }

      // Смена фильтра
      function changeFilter() {
        console.log("Клик! Текущий фильтр:", currentFilterIndex);

        if (filtersCompleted) {
          console.log("Фильтры уже завершены");
          return;
        }

        if (isMelting) {
          console.log("Эффект таяния уже активен");
          return;
        }

        // Скрываем предыдущий фильтр
        if (currentFilterIndex < filters.length) {
          filters[currentFilterIndex].classList.remove("active");
        }

        // Переходим к следующему фильтру
        currentFilterIndex++;

        // Активируем следующий фильтр
        if (currentFilterIndex < filters.length) {
          filters[currentFilterIndex].classList.add("active");
          console.log("Переключили на фильтр:", currentFilterIndex + 1);

          // Если это последний фильтр (ice-4)
          if (currentFilterIndex === filters.length - 1) {
            console.log("Достигнут ice-4, активируем финальный эффект");
            filtersCompleted = true;

            setTimeout(() => {
              startFinalEffect();
            }, 300);
          }
        }
      }

      // Финальный эффект
      function startFinalEffect() {
        console.log("Запуск финального эффекта");
        isMelting = true;

        // Активируем снежинки
        snowflakes.classList.add("active");
        createSnowflakes();

        // Показываем индикатор загрузки
        loadingProgress.classList.add("active");

        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 10;
          if (progress > 100) progress = 100;
          loadingProgressBar.style.width = `${progress}%`;

          console.log("Прогресс загрузки:", progress + "%");

          if (progress >= 100) {
            clearInterval(progressInterval);

            console.log("Прогресс завершен на 100%");

            // Запускаем эффект "таяния"
            setTimeout(() => {
              console.log("Запускаем анимацию таяния для ice-4");
              // Ice-4 получает melting но остается видимым!
              filters[currentFilterIndex].classList.add("melting");

              // Показываем модель
              unlockModel();

              // Убираем индикаторы через некоторое время
              setTimeout(() => {
                loadingProgress.classList.remove("active");
                snowflakes.classList.remove("active");
                console.log("Эффекты скрыты, модель видна");
              }, 2000);
            }, 1000);
          }
        }, 200);
      }

      // Показать модель
      function unlockModel() {
        console.log("Показываем 3D модель");

        // Показываем model-viewer
        modelViewer.style.display = "block";
        setTimeout(() => {
          modelViewer.classList.add("visible");
        }, 100);

        // Показываем кнопку AR
        setTimeout(() => {
          arButton.classList.add("visible");
          console.log("Кнопка AR видна и кликабельна");
        }, 800);

        // Отключаем клики по области фильтров
        filterClickArea.classList.add("disabled");
      }

      // Запуск AR
      async function startAR() {
        console.log("Нажата кнопка AR");

        try {
          // Пробуем активировать AR через API model-viewer
          if (modelViewer.activateAR) {
            console.log("Активируем AR через activateAR()");
            await modelViewer.activateAR();
            wasInAR = true;
            return;
          }

          // Если activateAR не доступен, пробуем другие методы
          console.log("activateAR не доступен, пробуем другие методы...");

          // Пробуем через canActivateAR
          if (modelViewer.canActivateAR) {
            console.log("Проверяем canActivateAR...");
            if (await modelViewer.canActivateAR()) {
              console.log("canActivateAR вернул true, активируем...");
              modelViewer.activateAR();
              wasInAR = true;
              return;
            }
          }

          console.log("AR не доступен в этом браузере");
          alert(
            "AR режим недоступен в вашем браузере. Попробуйте Safari на iOS или Chrome на Android."
          );
        } catch (error) {
          console.error("Ошибка при запуске AR:", error);
          alert(
            "Не удалось запустить AR режим. Проверьте поддержку AR в вашем браузере."
          );
        }
      }

      // Показать модальное окно
      function showModal() {
        console.log("Показываем модальное окно после выхода из AR");
        arExitModal.style.display = "flex";
        arExitModal.classList.add("show");
      }

      // Скрыть модальное окно
      function hideModal() {
        console.log("Скрываем модальное окно");
        arExitModal.style.display = "none";
        arExitModal.classList.remove("show");
      }

      // Инициализация при загрузке страницы
      window.addEventListener("load", async () => {
        console.log("Страница загружена, начинаем инициализацию...");

        // Инициализируем камеру
        await initCamera();

        // Создаем снежинки
        createSnowflakes();

        console.log(
          "Инициализация завершена. Кликайте по экрану для смены фильтров."
        );
      });

      // Обработчики событий
      filterClickArea.addEventListener("click", changeFilter);
      arButton.addEventListener("click", startAR);
      closeModalBtn.addEventListener("click", hideModal);
      moreBtn.addEventListener("click", hideModal);

      // Закрытие модального окна при клике на оверлей
      arExitModal.addEventListener("click", (e) => {
        if (e.target === arExitModal) {
          hideModal();
        }
      });

      // ОТСЛЕЖИВАНИЕ ВЫХОДА ИЗ AR
      document.addEventListener("visibilitychange", () => {
        console.log("Visibility change:", document.visibilityState);

        if (document.visibilityState === "visible") {
          console.log("Страница стала видимой");
          if (wasInAR && filtersCompleted) {
            console.log("Были в AR и фильтры завершены - показываем модалку");
            setTimeout(() => {
              showModal();
            }, 500);
            wasInAR = false;
          }
        }

        if (document.visibilityState === "hidden") {
          console.log("Страница скрыта - возможно вход в AR");
          wasInAR = true;
        }
      });

      // Отслеживание AR событий model-viewer
      modelViewer.addEventListener("ar-status", (event) => {
        console.log("AR статус:", event.detail.status);

        if (event.detail.status === "session-started") {
          console.log("AR сессия началась");
          wasInAR = true;
          // Скрываем кнопку при входе в AR
          arButton.classList.remove("visible");
        }

        if (event.detail.status === "session-ended") {
          console.log("AR сессия завершилась");
          if (wasInAR && filtersCompleted) {
            console.log("Показываем модальное окно");
            setTimeout(() => {
              showModal();
            }, 300);
          }
          // Показываем кнопку после выхода
          arButton.classList.add("visible");
          wasInAR = false;
        }
      });

      // Для тестирования
      window.debug = {
        startAR: startAR,
        unlockModel: unlockModel,
        showModal: showModal,
        simulateClicks: () => {
          changeFilter();
          setTimeout(() => changeFilter(), 500);
        },
        getState: () => ({
          currentFilterIndex,
          filtersCompleted,
          isMelting,
          ice4Active: filter3.classList.contains("active"),
          ice4Visible: window.getComputedStyle(filter3).opacity,
          modelVisible: modelViewer.classList.contains("visible"),
          arButtonVisible: arButton.classList.contains("visible"),
          wasInAR,
        }),
      };

      console.log("Тестовые функции доступны в window.debug");
      console.log("debug.simulateClicks() - быстрое тестирование");
      console.log("debug.startAR() - запуск AR");
    </script>
  </body>
</html>

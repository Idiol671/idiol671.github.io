<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

    <title>Модель + AR</title>

    <style>
      :root {
        color-scheme: dark;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system;
        background-color: #050608;
        color: #f4f5f7;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 24px;
        padding: 24px;
      }

      #camera-wrapper {
        position: relative;
        width: min(90vw, 640px);
        aspect-ratio: 3 / 4;
        border-radius: 24px;
        overflow: hidden;
        background: #0d0f14;
        box-shadow: 0 20px 60px rgba(6, 9, 20, 0.55);
      }

      video {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 0;
      }

      model-viewer {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        background: transparent;
      }

      model-viewer::part(ar-button) {
        display: none; /* отключаем стандартную кнопку */
      }

      .custom-ar-btn {
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 999px;
        padding: 10px 24px;
        background: #111;
        color: #fff;
        cursor: pointer;
        font-size: 16px;
      }
    </style>
  </head>

  <body>
    <h1>Живой фильтр + AR</h1>

    <div id="camera-wrapper">
      <video id="cam" autoplay playsinline muted></video>

      <model-viewer
        id="model"
        alt="3D Model"
        src="./assets/model/Horse_animation.gltf"
        ios-src="./assets/model/Horse_animation.usdz"
        camera-controls
        disable-tap
        exposure="1"
        ar
        ar-modes="webxr scene-viewer quick-look"
        quick-look-browsers="safari"
        interaction-prompt="none">
      </model-viewer>
    </div>

    <button class="custom-ar-btn" id="arStart">Открыть AR</button>

    <script>
      /* ---------- Камера ---------- */
      const video = document.getElementById("cam");
      let currentStream;

      async function initCamera() {
        if (currentStream) currentStream.getTracks().forEach((t) => t.stop());

        try {
          let stream;

          try {
            stream = await navigator.mediaDevices.getUserMedia({
              video: {facingMode: {exact: "environment"}},
              audio: false,
            });
          } catch {
            stream = await navigator.mediaDevices.getUserMedia({
              video: {facingMode: "environment"},
              audio: false,
            });
          }

          currentStream = stream;
          video.srcObject = stream;
        } catch (e) {
          console.error("Камера недоступна:", e);
        }
      }

      initCamera();

      /* ---------- AR кнопка ---------- */

      const model = document.getElementById("model");
      const btn = document.getElementById("arStart");

      let modelReady = false;

      model.addEventListener("load", () => {
        modelReady = true;
      });

      btn.addEventListener("click", () => {
        if (!modelReady) {
          console.warn("Модель ещё загружается...");
          return;
        }
        model.enterAR();
      });
    </script>
  </body>
</html>

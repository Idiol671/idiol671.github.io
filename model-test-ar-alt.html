<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>AR –ú–æ–¥–µ–ª—å —Å Three.js</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body,
      html {
        width: 100%;
        height: 100%;
        overflow: hidden;
        touch-action: none;
      }

      body {
        background: #000;
        color: white;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      h1 {
        font-size: 20px;
        margin: 10px 0;
        text-align: center;
        z-index: 100;
      }

      #container {
        position: relative;
        width: 95vw;
        max-width: 400px;
        height: 70vh;
        max-height: 700px;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 0 30px rgba(0, 100, 255, 0.3);
      }

      #camera-video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 1;
      }

      #renderCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
        display: block;
      }

      .filter {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 3;
        mix-blend-mode: screen;
        transition: opacity 0.5s;
        pointer-events: none;
      }

      #filter1 {
        opacity: 1;
      }

      #filter2 {
        opacity: 0;
      }

      .controls {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        z-index: 100;
      }

      button {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 14px;
        cursor: pointer;
        backdrop-filter: blur(10px);
      }

      button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      #ar-button {
        background: #007aff;
        border-color: #007aff;
        font-weight: bold;
      }

      .notification {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        z-index: 1000;
        display: none;
        font-size: 16px;
      }

      #status {
        margin-top: 10px;
        font-size: 14px;
        color: #888;
        text-align: center;
        min-height: 20px;
        z-index: 100;
      }
    </style>
  </head>
  <body>
    <h1>AR –§–∏–ª—å—Ç—Ä —Å 3D –ú–æ–¥–µ–ª—å—é</h1>

    <div id="container">
      <video id="camera-video" autoplay playsinline muted></video>
      <canvas id="renderCanvas"></canvas>
      <img
        class="filter"
        id="filter1"
        src="./assets/ice-1.png"
        alt="–§–∏–ª—å—Ç—Ä 1" />
      <img
        class="filter"
        id="filter2"
        src="./assets/ice-4.png"
        alt="–§–∏–ª—å—Ç—Ä 2" />
    </div>

    <div class="controls">
      <button id="switch-camera">üì∑ –ö–∞–º–µ—Ä–∞</button>
      <button id="ar-button">üöÄ AR –†–µ–∂–∏–º</button>
      <button id="screenshot">üì∏ –°–Ω–∏–º–æ–∫</button>
    </div>

    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="notification" id="notification">–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!</div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Three.js —Å CDN –Ω–∞–ø—Ä—è–º—É—é -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/webxr/ARButton.min.js"></script>

    <script>
      // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
      let scene, camera, renderer, model, mixer, clock;
      let currentStream = null;
      let isARMode = false;
      let filterChanged = false;
      let currentCameraType = "environment";
      let animationFrameId = null;

      // ========== DOM –≠–õ–ï–ú–ï–ù–¢–´ ==========
      const elements = {
        container: document.getElementById("container"),
        video: document.getElementById("camera-video"),
        canvas: document.getElementById("renderCanvas"),
        filter1: document.getElementById("filter1"),
        filter2: document.getElementById("filter2"),
        switchCameraBtn: document.getElementById("switch-camera"),
        arButton: document.getElementById("ar-button"),
        screenshotBtn: document.getElementById("screenshot"),
        status: document.getElementById("status"),
        notification: document.getElementById("notification"),
      };

      // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø THREE.JS ==========
      function initThreeJS() {
        console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Three.js...");

        // 1. –°—Ü–µ–Ω–∞
        scene = new THREE.Scene();

        // 2. –ö–∞–º–µ—Ä–∞ (–º–∞–ª–µ–Ω—å–∫–∏–π —É–≥–æ–ª –æ–±–∑–æ—Ä–∞ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–π –º–æ–¥–µ–ª–∏)
        camera = new THREE.PerspectiveCamera(
          40, // –£–≥–æ–ª –æ–±–∑–æ—Ä–∞
          elements.container.clientWidth / elements.container.clientHeight,
          0.01,
          100
        );
        camera.position.set(0, 0.2, 1.5); // –ë–ª–∏–∑–∫–æ –∏ –Ω–µ–º–Ω–æ–≥–æ –≤—ã—à–µ

        // 3. –†–µ–Ω–¥–µ—Ä–µ—Ä
        renderer = new THREE.WebGLRenderer({
          canvas: elements.canvas,
          alpha: true,
          antialias: true,
          preserveDrawingBuffer: true,
        });
        renderer.setSize(
          elements.container.clientWidth,
          elements.container.clientHeight
        );
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        renderer.setClearColor(0x000000, 0);

        // 4. –í–∫–ª—é—á–∞–µ–º WebXR –µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
        if ("xr" in navigator && renderer.xr) {
          renderer.xr.enabled = true;
          console.log("WebXR –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
        } else {
          console.log("WebXR –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω");
          elements.arButton.style.display = "none";
        }

        // 5. –û—Å–≤–µ—â–µ–Ω–∏–µ
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(0.5, 1, 0.5);
        scene.add(directionalLight);

        // 6. –ß–∞—Å—ã –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        clock = new THREE.Clock();

        elements.status.textContent = "Three.js –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω";
      }

      // ========== –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò ==========
      function loadModel() {
        console.log("–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...");

        const loader = new THREE.GLTFLoader();

        loader.load(
          "./assets/model/Horse_animation.gltf",
          function (gltf) {
            console.log("–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
            model = gltf.scene;

            // –ú–ê–õ–ï–ù–¨–ö–ò–ô –ú–ê–°–®–¢–ê–ë
            model.scale.set(0.1, 0.1, 0.1);
            model.position.set(0, -0.2, 0); // –ù–∏–∑–∫–æ

            // –ü–æ–≤–æ—Ä–æ—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–∏–¥–∞
            model.rotation.y = Math.PI / 6;

            scene.add(model);

            // –ê–Ω–∏–º–∞—Ü–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (gltf.animations && gltf.animations.length > 0) {
              console.log("–ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞");
              mixer = new THREE.AnimationMixer(model);

              // –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
              const action = mixer.clipAction(gltf.animations[0]);
              action.play();

              // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏
              mixer.timeScale = 0.5; // –ú–µ–¥–ª–µ–Ω–Ω–µ–µ
            }

            elements.status.textContent =
              "–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –¥–ª—è —Å–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–∞.";
          },
          function (progress) {
            const percent = ((progress.loaded / progress.total) * 100).toFixed(
              0
            );
            elements.status.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${percent}%`;
          },
          function (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:", error);
            createSimpleModel();
          }
        );
      }

      // –ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–∞—è –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
      function createSimpleModel() {
        console.log("–°–æ–∑–¥–∞—é –ø—Ä–æ—Å—Ç—É—é –º–æ–¥–µ–ª—å");

        const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
        const material = new THREE.MeshBasicMaterial({
          color: 0x00ff00,
          transparent: true,
          opacity: 0.8,
        });

        model = new THREE.Mesh(geometry, material);
        model.position.set(0, 0, 0);
        scene.add(model);

        elements.status.textContent = "–ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞";
      }

      // ========== –ö–ê–ú–ï–†–ê –£–°–¢–†–û–ô–°–¢–í–ê ==========
      async function initCamera() {
        try {
          // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫
          if (currentStream) {
            currentStream.getTracks().forEach((track) => track.stop());
          }

          elements.status.textContent = "–ó–∞–ø—Ä–æ—Å –∫–∞–º–µ—Ä—ã...";

          const constraints = {
            video: {
              facingMode: currentCameraType,
              width: {ideal: 1280},
              height: {ideal: 720},
            },
            audio: false,
          };

          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          currentStream = stream;
          elements.video.srcObject = stream;

          // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ
          await new Promise((resolve) => {
            elements.video.onloadedmetadata = () => {
              elements.video.play().then(resolve).catch(resolve);
            };
          });

          elements.status.textContent = "–ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞";
          console.log("–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", error);
          elements.status.textContent = "–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã";

          // –§–æ–Ω –µ—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
          elements.video.style.display = "none";
          elements.container.style.background =
            "linear-gradient(45deg, #000, #333)";
        }
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
      function switchCamera() {
        currentCameraType =
          currentCameraType === "environment" ? "user" : "environment";
        initCamera();
      }

      // ========== AR –†–ï–ñ–ò–ú ==========
      function initAR() {
        if (!("xr" in navigator)) {
          console.log("WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º");
          elements.arButton.style.display = "none";
          return;
        }

        elements.arButton.addEventListener("click", async () => {
          try {
            console.log("–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ AR...");

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É AR
            const supported = await navigator.xr.isSessionSupported(
              "immersive-ar"
            );
            if (!supported) {
              alert("AR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ");
              return;
            }

            console.log("AR –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, —Å–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é...");

            // –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é AR
            const session = await navigator.xr.requestSession("immersive-ar", {
              requiredFeatures: ["hit-test"],
              optionalFeatures: ["dom-overlay"],
              domOverlay: {root: document.body},
            });

            console.log("AR —Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞");

            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–µ—Å—Å–∏—é –∫ —Ä–µ–Ω–¥–µ—Ä–µ—Ä—É
            await renderer.xr.setSession(session);

            isARMode = true;

            // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ AR —Ä–µ–∂–∏–º–µ
            elements.video.style.display = "none";
            elements.filter1.style.display = "none";
            elements.filter2.style.display = "none";

            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            if (currentStream) {
              currentStream.getTracks().forEach((track) => track.stop());
            }

            // –£–º–µ–Ω—å—à–∞–µ–º –º–æ–¥–µ–ª—å –¥–ª—è AR
            if (model) {
              model.scale.set(0.03, 0.03, 0.03);
              model.position.set(0, 0, 0);
            }

            elements.status.textContent = "AR —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω";

            // –°–æ–±—ã—Ç–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏
            session.addEventListener("end", () => {
              console.log("AR —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
              isARMode = false;

              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ
              elements.video.style.display = "block";
              elements.filter1.style.display = "block";
              elements.filter2.style.display = "block";

              // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–µ–ª—å
              if (model) {
                model.scale.set(0.1, 0.1, 0.1);
                model.position.set(0, -0.2, 0);
              }

              // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
              setTimeout(initCamera, 100);

              elements.status.textContent = "AR —Ä–µ–∂–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω";
            });
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ AR:", error);
            elements.status.textContent = "–û—à–∏–±–∫–∞ AR: " + error.message;
          }
        });
      }

      // ========== –§–ò–õ–¨–¢–†–´ ==========
      function setupFilters() {
        elements.container.addEventListener("click", () => {
          if (filterChanged || isARMode) return;

          filterChanged = true;
          elements.filter1.style.opacity = "0";
          elements.filter2.style.opacity = "1";

          // –ú–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä
          elements.container.style.cursor = "default";

          console.log("–§–∏–ª—å—Ç—Ä –∏–∑–º–µ–Ω–µ–Ω");
        });
      }

      // ========== –°–ù–ò–ú–û–ö –≠–ö–†–ê–ù–ê ==========
      function setupScreenshot() {
        elements.screenshotBtn.addEventListener("click", () => {
          // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
          const buttons = document.querySelectorAll(".controls button");
          buttons.forEach((btn) => (btn.style.visibility = "hidden"));

          setTimeout(() => {
            // –°–æ–∑–¥–∞–µ–º canvas
            const tempCanvas = document.createElement("canvas");
            tempCanvas.width = elements.canvas.width;
            tempCanvas.height = elements.canvas.height;
            const ctx = tempCanvas.getContext("2d");

            // –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

            // –í–∏–¥–µ–æ
            ctx.drawImage(
              elements.video,
              0,
              0,
              tempCanvas.width,
              tempCanvas.height
            );

            // 3D –º–æ–¥–µ–ª—å
            ctx.drawImage(elements.canvas, 0, 0);

            // –ê–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
            const activeFilter =
              elements.filter1.style.opacity === "1"
                ? elements.filter1
                : elements.filter2;
            ctx.globalCompositeOperation = "screen";
            ctx.drawImage(
              activeFilter,
              0,
              0,
              tempCanvas.width,
              tempCanvas.height
            );

            // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
            const link = document.createElement("a");
            link.download = `ar-photo-${Date.now()}.png`;
            link.href = tempCanvas.toDataURL("image/png");
            link.click();

            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification("–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏
            setTimeout(() => {
              buttons.forEach((btn) => (btn.style.visibility = "visible"));
            }, 500);
          }, 100);
        });
      }

      function showNotification(text) {
        elements.notification.textContent = text;
        elements.notification.style.display = "block";
        setTimeout(() => {
          elements.notification.style.display = "none";
        }, 2000);
      }

      // ========== –ê–ù–ò–ú–ê–¶–ò–Ø ==========
      function animate() {
        animationFrameId = requestAnimationFrame(animate);

        // –û–ë–ù–û–í–õ–Ø–ï–ú –ê–ù–ò–ú–ê–¶–ò–Æ –ú–û–î–ï–õ–ò
        if (mixer) {
          // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–µ–ª—å—Ç–∞-—Ç–∞–π–º –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
          const delta = clock.getDelta();
          mixer.update(delta);
        }

        // –ú–ï–î–õ–ï–ù–ù–û–ï –í–†–ê–©–ï–ù–ò–ï –ú–û–î–ï–õ–ò (—Ç–æ–ª—å–∫–æ –Ω–µ –≤ AR)
        if (model && !isARMode) {
          model.rotation.y += 0.003; // –û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ
        }

        // –†–ï–ù–î–ï–†
        renderer.render(scene, camera);
      }

      // ========== –†–ï–°–ê–ô–ó ==========
      function onResize() {
        const width = elements.container.clientWidth;
        const height = elements.container.clientHeight;

        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height);
      }

      // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
      async function initApp() {
        try {
          console.log("=== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===");

          // 1. Three.js
          initThreeJS();

          // 2. –ö–∞–º–µ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
          await initCamera();

          // 3. –ú–æ–¥–µ–ª—å
          loadModel();

          // 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AR
          initAR();

          // 5. –§–∏–ª—å—Ç—Ä—ã
          setupFilters();

          // 6. –°–∫—Ä–∏–Ω—à–æ—Ç
          setupScreenshot();

          // 7. –°–æ–±—ã—Ç–∏—è
          elements.switchCameraBtn.addEventListener("click", switchCamera);
          window.addEventListener("resize", onResize);

          // 8. –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏
          animate();

          console.log("=== –ü–†–ò–õ–û–ñ–ï–ù–ò–ï –ó–ê–ü–£–©–ï–ù–û ===");
          elements.status.textContent =
            "–ì–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –¥–ª—è —Å–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–∞.";
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
          elements.status.textContent = "–û—à–∏–±–∫–∞: " + error.message;
        }
      }

      // ========== –û–ß–ò–°–¢–ö–ê ==========
      function cleanup() {
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
        }
        if (currentStream) {
          currentStream.getTracks().forEach((track) => track.stop());
        }
      }

      window.addEventListener("beforeunload", cleanup);

      // ========== –ó–ê–ü–£–°–ö ==========
      initApp();
    </script>
  </body>
</html>

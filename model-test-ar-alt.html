<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>AR –ú–æ–¥–µ–ª—å —Å Three.js</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body,
      html {
        width: 100%;
        height: 100%;
        overflow: hidden;
        touch-action: none;
      }

      body {
        background: #000;
        color: white;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      h1 {
        font-size: 20px;
        margin: 10px 0;
        text-align: center;
        z-index: 100;
      }

      #container {
        position: relative;
        width: 95vw;
        max-width: 400px;
        height: 70vh;
        max-height: 700px;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 0 30px rgba(0, 100, 255, 0.3);
      }

      #camera-video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 1;
      }

      #renderCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
        display: block;
      }

      .filter {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 3;
        mix-blend-mode: screen;
        transition: opacity 0.5s;
        pointer-events: none;
      }

      #filter1 {
        opacity: 1;
      }

      #filter2 {
        opacity: 0;
      }

      .controls {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        z-index: 100;
      }

      button {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 14px;
        cursor: pointer;
        backdrop-filter: blur(10px);
      }

      button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      #ar-button {
        background: #007aff;
        border-color: #007aff;
        font-weight: bold;
      }

      .notification {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        z-index: 1000;
        display: none;
        font-size: 16px;
      }

      #status {
        margin-top: 10px;
        font-size: 14px;
        color: #888;
        text-align: center;
        min-height: 20px;
        z-index: 100;
      }
    </style>
  </head>
  <body>
    <h1>AR –§–∏–ª—å—Ç—Ä —Å 3D –ú–æ–¥–µ–ª—å—é</h1>

    <div id="container">
      <video id="camera-video" autoplay playsinline muted></video>
      <canvas id="renderCanvas"></canvas>
      <img
        class="filter"
        id="filter1"
        src="./assets/ice-1.png"
        alt="–§–∏–ª—å—Ç—Ä 1" />
      <img
        class="filter"
        id="filter2"
        src="./assets/ice-4.png"
        alt="–§–∏–ª—å—Ç—Ä 2" />
    </div>

    <div class="controls">
      <button id="switch-camera">üì∑ –ö–∞–º–µ—Ä–∞</button>
      <button id="ar-button">üöÄ AR –†–µ–∂–∏–º</button>
      <button id="screenshot">üì∏ –°–Ω–∏–º–æ–∫</button>
    </div>

    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="notification" id="notification">–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!</div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Three.js –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>

    <!-- WebXR polyfill –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–∞ iOS -->
    <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/dist/webxr-polyfill.min.js"></script>

    <!-- AR Button –¥–ª—è Three.js -->
    <script>
      // –ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è ARButton –µ—Å–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
      if (typeof THREE !== "undefined" && !THREE.ARButton) {
        THREE.ARButton = {
          createButton: function (renderer, sessionInit = {}) {
            const button = document.createElement("button");

            function showStartAR() {
              if (sessionInit.requiredFeatures === undefined) {
                sessionInit.requiredFeatures = ["hit-test"];
              }

              let currentSession = null;

              async function onSessionStarted(session) {
                session.addEventListener("end", onSessionEnded);
                await renderer.xr.setSession(session);
                currentSession = session;
                button.textContent = "–í–´–ô–¢–ò –ò–ó AR";
              }

              function onSessionEnded(event) {
                currentSession.removeEventListener("end", onSessionEnded);
                currentSession = null;
                button.textContent = "üöÄ AR –†–µ–∂–∏–º";
              }

              button.addEventListener("click", function () {
                if (currentSession === null) {
                  navigator.xr
                    .requestSession("immersive-ar", sessionInit)
                    .then(onSessionStarted);
                } else {
                  currentSession.end();
                }
              });
            }

            if ("xr" in navigator) {
              button.id = "ARButton";
              button.style.display = "inline-block";
              button.style.padding = "12px 24px";
              button.style.border = "1px solid #fff";
              button.style.borderRadius = "4px";
              button.style.background = "rgba(0, 0, 0, 0.1)";
              button.style.color = "#fff";
              button.style.font = "normal 13px sans-serif";
              button.style.textAlign = "center";
              button.style.opacity = "1";
              button.style.outline = "none";
              button.style.zIndex = "999";
              button.textContent = "üöÄ AR –†–µ–∂–∏–º";

              navigator.xr
                .isSessionSupported("immersive-ar")
                .then(function (supported) {
                  if (supported) {
                    showStartAR();
                  } else {
                    button.style.display = "none";
                  }
                })
                .catch(function () {
                  button.style.display = "none";
                });

              return button;
            } else {
              const message = document.createElement("a");
              message.href = "https://immersiveweb.dev/";
              message.innerHTML = "AR –ù–ï–î–û–°–¢–£–ü–ù–û";
              message.style.color = "#fff";
              message.style.textDecoration = "none";
              return message;
            }
          },
        };
      }
    </script>

    <script>
      // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
      let scene, camera, renderer, model, mixer, clock;
      let currentStream = null;
      let isARMode = false;
      let filterChanged = false;
      let currentCameraType = "environment";
      let animationFrameId = null;

      // ========== DOM –≠–õ–ï–ú–ï–ù–¢–´ ==========
      const elements = {
        container: document.getElementById("container"),
        video: document.getElementById("camera-video"),
        canvas: document.getElementById("renderCanvas"),
        filter1: document.getElementById("filter1"),
        filter2: document.getElementById("filter2"),
        switchCameraBtn: document.getElementById("switch-camera"),
        arButton: document.getElementById("ar-button"),
        screenshotBtn: document.getElementById("screenshot"),
        status: document.getElementById("status"),
        notification: document.getElementById("notification"),
      };

      // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø THREE.JS ==========
      function initThreeJS() {
        console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Three.js...");

        // 1. –°—Ü–µ–Ω–∞
        scene = new THREE.Scene();

        // 2. –ö–∞–º–µ—Ä–∞ (–º–∞–ª–µ–Ω—å–∫–∏–π —É–≥–æ–ª –æ–±–∑–æ—Ä–∞ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–π –º–æ–¥–µ–ª–∏)
        camera = new THREE.PerspectiveCamera(
          40,
          elements.container.clientWidth / elements.container.clientHeight,
          0.01,
          100
        );
        camera.position.set(0, 0.2, 1.5);

        // 3. –†–µ–Ω–¥–µ—Ä–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π WebXR
        renderer = new THREE.WebGLRenderer({
          canvas: elements.canvas,
          alpha: true,
          antialias: true,
          preserveDrawingBuffer: true,
        });
        renderer.setSize(
          elements.container.clientWidth,
          elements.container.clientHeight
        );
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.setClearColor(0x000000, 0);

        // –í–∫–ª—é—á–∞–µ–º WebXR
        renderer.xr.enabled = true;

        // 4. –û—Å–≤–µ—â–µ–Ω–∏–µ
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(0.5, 1, 0.5);
        scene.add(directionalLight);

        // 5. –ß–∞—Å—ã –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        clock = new THREE.Clock();

        elements.status.textContent = "Three.js –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω";
      }

      // ========== –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò ==========
      function loadModel() {
        console.log("–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...");

        const loader = new THREE.GLTFLoader();

        loader.load(
          "./assets/model/Horse_animation.gltf",
          function (gltf) {
            console.log("–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
            model = gltf.scene;

            // –ú–ê–õ–ï–ù–¨–ö–ò–ô –ú–ê–°–®–¢–ê–ë
            model.scale.set(0.1, 0.1, 0.1);
            model.position.set(0, -0.2, 0);

            // –ü–æ–≤–æ—Ä–æ—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–∏–¥–∞
            model.rotation.y = Math.PI / 6;

            scene.add(model);

            // –ê–Ω–∏–º–∞—Ü–∏—è
            if (gltf.animations && gltf.animations.length > 0) {
              console.log("–ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞");
              mixer = new THREE.AnimationMixer(model);
              const action = mixer.clipAction(gltf.animations[0]);
              action.play();
              mixer.timeScale = 0.5;
            }

            elements.status.textContent =
              "–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –¥–ª—è —Å–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–∞.";
          },
          function (progress) {
            const percent = ((progress.loaded / progress.total) * 100).toFixed(
              0
            );
            elements.status.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${percent}%`;
          },
          function (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:", error);
            createSimpleModel();
          }
        );
      }

      function createSimpleModel() {
        console.log("–°–æ–∑–¥–∞—é –ø—Ä–æ—Å—Ç—É—é –º–æ–¥–µ–ª—å");

        const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
        const material = new THREE.MeshBasicMaterial({
          color: 0x00ff00,
          transparent: true,
          opacity: 0.8,
        });

        model = new THREE.Mesh(geometry, material);
        model.position.set(0, 0, 0);
        scene.add(model);

        elements.status.textContent = "–ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞";
      }

      // ========== –ö–ê–ú–ï–†–ê –£–°–¢–†–û–ô–°–¢–í–ê ==========
      async function initCamera() {
        try {
          if (currentStream) {
            currentStream.getTracks().forEach((track) => track.stop());
          }

          elements.status.textContent = "–ó–∞–ø—Ä–æ—Å –∫–∞–º–µ—Ä—ã...";

          const constraints = {
            video: {
              facingMode: currentCameraType,
              width: {ideal: 1280},
              height: {ideal: 720},
            },
            audio: false,
          };

          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          currentStream = stream;
          elements.video.srcObject = stream;

          await new Promise((resolve) => {
            elements.video.onloadedmetadata = () => {
              elements.video.play().then(resolve).catch(resolve);
            };
          });

          elements.status.textContent = "–ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞";
          console.log("–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", error);
          elements.status.textContent = "–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã";
          elements.video.style.display = "none";
          elements.container.style.background =
            "linear-gradient(45deg, #000, #333)";
        }
      }

      function switchCamera() {
        currentCameraType =
          currentCameraType === "environment" ? "user" : "environment";
        initCamera();
      }

      // ========== –ù–ê–°–¢–†–û–ô–ö–ê AR –†–ï–ñ–ò–ú–ê ==========
      function setupAR() {
        console.log("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ AR —Ä–µ–∂–∏–º–∞...");

        // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É AR —Å –ø–æ–º–æ—â—å—é Three.js ARButton
        const arButton = THREE.ARButton.createButton(renderer, {
          requiredFeatures: ["hit-test"],
          optionalFeatures: ["dom-overlay"],
          domOverlay: {root: document.body},
        });

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏
        arButton.id = "ar-button";
        arButton.style.cssText = `
                position: relative;
                background: #007AFF;
                border: 2px solid #007AFF;
                color: white;
                padding: 10px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                backdrop-filter: blur(10px);
                margin: 0;
            `;

        // –ó–∞–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É AR
        const oldButton = document.getElementById("ar-button");
        if (oldButton && oldButton.parentNode) {
          oldButton.parentNode.replaceChild(arButton, oldButton);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É
        elements.arButton = arButton;

        // –°–æ–±—ã—Ç–∏–µ –Ω–∞—á–∞–ª–∞ AR —Å–µ—Å—Å–∏–∏
        renderer.xr.addEventListener("sessionstart", () => {
          console.log("AR —Å–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞");
          isARMode = true;

          // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ AR —Ä–µ–∂–∏–º–µ
          elements.video.style.display = "none";
          elements.filter1.style.display = "none";
          elements.filter2.style.display = "none";

          // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
          if (currentStream) {
            currentStream.getTracks().forEach((track) => track.stop());
            currentStream = null;
          }

          // –£–º–µ–Ω—å—à–∞–µ–º –º–æ–¥–µ–ª—å –¥–ª—è AR
          if (model) {
            model.scale.set(0.03, 0.03, 0.03);
            model.position.set(0, 0, 0);
          }

          elements.status.textContent =
            "AR —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –°–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∫—Ä—É–≥ —á–µ—Ä–µ–∑ –∫–∞–º–µ—Ä—É.";
        });

        // –°–æ–±—ã—Ç–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è AR —Å–µ—Å—Å–∏–∏
        renderer.xr.addEventListener("sessionend", () => {
          console.log("AR —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
          isARMode = false;

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ
          elements.video.style.display = "block";
          elements.filter1.style.display = "block";
          elements.filter2.style.display = "block";

          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–µ–ª—å
          if (model) {
            model.scale.set(0.1, 0.1, 0.1);
            model.position.set(0, -0.2, 0);
          }

          // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
          setTimeout(initCamera, 100);

          elements.status.textContent = "AR —Ä–µ–∂–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω";
        });

        console.log("AR —Ä–µ–∂–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω");
      }

      // ========== –§–ò–õ–¨–¢–†–´ ==========
      function setupFilters() {
        elements.container.addEventListener("click", () => {
          if (filterChanged || isARMode) return;

          filterChanged = true;
          elements.filter1.style.opacity = "0";
          elements.filter2.style.opacity = "1";
          elements.container.style.cursor = "default";
          console.log("–§–∏–ª—å—Ç—Ä –∏–∑–º–µ–Ω–µ–Ω");
        });
      }

      // ========== –°–ù–ò–ú–û–ö –≠–ö–†–ê–ù–ê ==========
      function setupScreenshot() {
        elements.screenshotBtn.addEventListener("click", () => {
          const buttons = document.querySelectorAll(".controls button");
          buttons.forEach((btn) => (btn.style.visibility = "hidden"));

          setTimeout(() => {
            const tempCanvas = document.createElement("canvas");
            tempCanvas.width = elements.canvas.width;
            tempCanvas.height = elements.canvas.height;
            const ctx = tempCanvas.getContext("2d");

            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

            ctx.drawImage(
              elements.video,
              0,
              0,
              tempCanvas.width,
              tempCanvas.height
            );
            ctx.drawImage(elements.canvas, 0, 0);

            const activeFilter =
              elements.filter1.style.opacity === "1"
                ? elements.filter1
                : elements.filter2;
            ctx.globalCompositeOperation = "screen";
            ctx.drawImage(
              activeFilter,
              0,
              0,
              tempCanvas.width,
              tempCanvas.height
            );

            const link = document.createElement("a");
            link.download = `ar-photo-${Date.now()}.png`;
            link.href = tempCanvas.toDataURL("image/png");
            link.click();

            showNotification("–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");

            setTimeout(() => {
              buttons.forEach((btn) => (btn.style.visibility = "visible"));
            }, 500);
          }, 100);
        });
      }

      function showNotification(text) {
        elements.notification.textContent = text;
        elements.notification.style.display = "block";
        setTimeout(() => {
          elements.notification.style.display = "none";
        }, 2000);
      }

      // ========== –ê–ù–ò–ú–ê–¶–ò–Ø ==========
      function animate() {
        animationFrameId = requestAnimationFrame(animate);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –º–æ–¥–µ–ª–∏
        if (mixer) {
          const delta = clock.getDelta();
          mixer.update(delta);
        }

        // –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –Ω–µ –≤ AR)
        if (model && !isARMode) {
          model.rotation.y += 0.003;
        }

        // –†–µ–Ω–¥–µ—Ä
        renderer.render(scene, camera);
      }

      // ========== –†–ï–°–ê–ô–ó ==========
      function onResize() {
        const width = elements.container.clientWidth;
        const height = elements.container.clientHeight;

        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height);
      }

      // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
      async function initApp() {
        try {
          console.log("=== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===");

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º polyfill –¥–ª—è WebXR
          if (!("xr" in navigator)) {
            console.log("–ò—Å–ø–æ–ª—å–∑—É—é WebXR polyfill");
            new WebXRPolyfill();
          }

          // 1. Three.js
          initThreeJS();

          // 2. –ö–∞–º–µ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
          await initCamera();

          // 3. –ú–æ–¥–µ–ª—å
          loadModel();

          // 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AR
          setupAR();

          // 5. –§–∏–ª—å—Ç—Ä—ã
          setupFilters();

          // 6. –°–∫—Ä–∏–Ω—à–æ—Ç
          setupScreenshot();

          // 7. –°–æ–±—ã—Ç–∏—è
          elements.switchCameraBtn.addEventListener("click", switchCamera);
          window.addEventListener("resize", onResize);

          // 8. –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏
          animate();

          console.log("=== –ü–†–ò–õ–û–ñ–ï–ù–ò–ï –ó–ê–ü–£–©–ï–ù–û ===");
          elements.status.textContent =
            "–ì–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –¥–ª—è —Å–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–∞.";
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
          elements.status.textContent = "–û—à–∏–±–∫–∞: " + error.message;
        }
      }

      // ========== –û–ß–ò–°–¢–ö–ê ==========
      function cleanup() {
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
        }
        if (currentStream) {
          currentStream.getTracks().forEach((track) => track.stop());
        }
      }

      window.addEventListener("beforeunload", cleanup);

      // ========== –ó–ê–ü–£–°–ö ==========
      // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initApp);
      } else {
        initApp();
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AR –ú–æ–¥–µ–ª—å —Å –§–∏–ª—å—Ç—Ä–æ–º</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
					sans-serif;
				background: #000;
				color: white;
				height: 100vh;
				display: flex;
				flex-direction: column;
				align-items: center;
				padding: 20px;
				overflow: hidden;
			}

			h1 {
				margin: 10px 0;
				text-align: center;
				font-size: 24px;
				font-weight: 600;
				z-index: 100;
			}

			#container {
				position: relative;
				width: 100%;
				max-width: 450px;
				height: 65vh;
				border-radius: 24px;
				overflow: hidden;
				background: #111;
				box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
			}

			#video-container {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 1;
			}

			#camera-video {
				width: 100%;
				height: 100%;
				object-fit: cover;
				transform: scaleX(
					-1
				); /* –ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–∞ */
			}

			#canvas-container {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 2;
			}

			#renderCanvas {
				width: 100%;
				height: 100%;
				display: block;
			}

			.filter {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: 3;
				mix-blend-mode: screen;
				pointer-events: none;
				opacity: 1;
				transition: opacity 0.5s ease;
			}

			#filter2 {
				opacity: 0;
			}

			.controls {
				margin-top: 20px;
				display: flex;
				gap: 12px;
				flex-wrap: wrap;
				justify-content: center;
				z-index: 100;
			}

			button {
				background: rgba(255, 255, 255, 0.15);
				border: 1px solid rgba(255, 255, 255, 0.3);
				color: white;
				padding: 12px 24px;
				border-radius: 50px;
				cursor: pointer;
				font-size: 15px;
				font-weight: 500;
				transition: all 0.2s ease;
				backdrop-filter: blur(10px);
			}

			button:hover {
				background: rgba(255, 255, 255, 0.25);
				transform: translateY(-1px);
			}

			#ar-button {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				border: none;
				font-weight: 600;
				box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
			}

			#ar-button:hover {
				background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
				transform: translateY(-2px);
				box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
			}

			#status {
				margin-top: 15px;
				text-align: center;
				color: #aaa;
				font-size: 14px;
				min-height: 20px;
				padding: 0 20px;
				z-index: 100;
			}

			.hidden {
				display: none !important;
			}

			.ar-instruction {
				position: absolute;
				top: 20px;
				left: 0;
				right: 0;
				text-align: center;
				background: rgba(0, 0, 0, 0.8);
				color: white;
				padding: 15px;
				font-size: 16px;
				z-index: 1000;
				display: none;
			}

			.ar-controls {
				position: absolute;
				bottom: 100px;
				left: 0;
				right: 0;
				display: flex;
				justify-content: center;
				gap: 20px;
				z-index: 1000;
				display: none;
			}

			.ar-btn {
				background: rgba(0, 0, 0, 0.7);
				border: 2px solid white;
				color: white;
				width: 60px;
				height: 60px;
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 24px;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<h1>AR –§–∏–ª—å—Ç—Ä —Å 3D –ú–æ–¥–µ–ª—å—é</h1>

		<div id="container">
			<div id="video-container">
				<video id="camera-video" autoplay playsinline muted></video>
			</div>
			<div id="canvas-container">
				<canvas id="renderCanvas"></canvas>
			</div>
			<img class="filter" id="filter1" src="./assets/ice-1.png" alt="–§–∏–ª—å—Ç—Ä" />
			<img class="filter" id="filter2" src="./assets/ice-4.png" alt="–§–∏–ª—å—Ç—Ä" />

			<div class="ar-instruction" id="ar-instruction">
				–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –∏ –∫–æ—Å–Ω–∏—Ç–µ—Å—å —ç–∫—Ä–∞–Ω–∞, —á—Ç–æ–±—ã
				—Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –º–æ–¥–µ–ª—å
			</div>

			<div class="ar-controls" id="ar-controls">
				<div class="ar-btn" id="ar-rotate">‚Üª</div>
				<div class="ar-btn" id="ar-scale">‚äï</div>
				<div class="ar-btn" id="ar-exit">‚úï</div>
			</div>
		</div>

		<div class="controls">
			<button id="switch-camera">üì∑ –ö–∞–º–µ—Ä–∞</button>
			<button id="screenshot">üì∏ –°–Ω–∏–º–æ–∫</button>
			<button id="ar-button" class="hidden">üöÄ AR –†–µ–∂–∏–º</button>
		</div>

		<div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

		<!-- Three.js –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏ -->
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

		<script>
			// ===== –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
			let scene, camera, renderer, model, mixer
			let videoStream = null
			let isFilterChanged = false
			let currentCamera = 'environment'
			let arSession = null
			let isARMode = false
			let hitTestSource = null
			let modelPlaced = false
			let modelScale = 1
			let modelRotation = 0

			// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
			const elements = {
				container: document.getElementById('container'),
				video: document.getElementById('camera-video'),
				canvas: document.getElementById('renderCanvas'),
				filter1: document.getElementById('filter1'),
				filter2: document.getElementById('filter2'),
				switchBtn: document.getElementById('switch-camera'),
				screenshotBtn: document.getElementById('screenshot'),
				arButton: document.getElementById('ar-button'),
				status: document.getElementById('status'),
				arInstruction: document.getElementById('ar-instruction'),
				arControls: document.getElementById('ar-controls'),
				arRotateBtn: document.getElementById('ar-rotate'),
				arScaleBtn: document.getElementById('ar-scale'),
				arExitBtn: document.getElementById('ar-exit'),
			}

			// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
			async function init() {
				try {
					console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===')

					// 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É AR
					await checkARSupport()

					// 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Three.js
					initThreeJS()

					// 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
					await startCamera()

					// 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å
					await loadModel()

					// 5. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
					setupEvents()

					// 6. –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–Ω–¥–µ—Ä
					animate()

					elements.status.textContent =
						'–ì–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –¥–ª—è —Å–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–∞.'
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error)
					elements.status.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message
				}
			}

			// ===== –ü–†–û–í–ï–†–ö–ê –ü–û–î–î–ï–†–ñ–ö–ò AR =====
			async function checkARSupport() {
				if (!('xr' in navigator)) {
					console.log('WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º')
					return
				}

				try {
					// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É AR
					const supported = await navigator.xr.isSessionSupported(
						'immersive-ar'
					)

					if (supported) {
						elements.arButton.classList.remove('hidden')
						console.log('AR –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è!')
						elements.status.textContent = 'AR —Ä–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–µ–Ω!'
					} else {
						console.log('AR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ')
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ AR:', error)
				}
			}

			// ===== THREE.JS =====
			function initThreeJS() {
				// –°—Ü–µ–Ω–∞
				scene = new THREE.Scene()

				// –ö–∞–º–µ—Ä–∞
				const aspect =
					elements.container.clientWidth / elements.container.clientHeight
				camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 100)
				camera.position.set(0, 1.5, 3)

				// –†–µ–Ω–¥–µ—Ä–µ—Ä
				renderer = new THREE.WebGLRenderer({
					canvas: elements.canvas,
					alpha: true,
					antialias: true,
					preserveDrawingBuffer: true,
				})
				renderer.setSize(
					elements.container.clientWidth,
					elements.container.clientHeight
				)
				renderer.setPixelRatio(window.devicePixelRatio)
				renderer.setClearColor(0x000000, 0)

				// –í–∫–ª—é—á–∞–µ–º WebXR
				if (renderer.xr) {
					renderer.xr.enabled = true
					console.log('WebXR –≤–∫–ª—é—á–µ–Ω')
				}

				// –û—Å–≤–µ—â–µ–Ω–∏–µ
				const ambientLight = new THREE.AmbientLight(0xffffff, 1.2)
				scene.add(ambientLight)

				const directionalLight = new THREE.DirectionalLight(0xffffff, 1)
				directionalLight.position.set(5, 10, 7)
				scene.add(directionalLight)

				// –ï—â–µ –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–≤–µ—Ç–∞
				const backLight = new THREE.DirectionalLight(0xffffff, 0.5)
				backLight.position.set(-5, -5, -5)
				scene.add(backLight)
			}

			// ===== –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò =====
			async function loadModel() {
				return new Promise((resolve, reject) => {
					elements.status.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...'

					const loader = new THREE.GLTFLoader()

					loader.load(
						'./assets/model/Horse_animation.gltf',
						gltf => {
							console.log('–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ')
							model = gltf.scene

							// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏
							model.scale.set(0.5, 0.5, 0.5)
							model.position.set(0, -1, 0)

							// –ü–æ–≤–æ—Ä–æ—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–∏–¥–∞
							model.rotation.y = Math.PI / 4

							// –í–∫–ª—é—á–∞–µ–º —Ç–µ–Ω–∏ –¥–ª—è –º–æ–¥–µ–ª–∏
							model.traverse(child => {
								if (child.isMesh) {
									child.castShadow = true
									child.receiveShadow = true
								}
							})

							scene.add(model)

							// –ê–Ω–∏–º–∞—Ü–∏—è
							if (gltf.animations && gltf.animations.length > 0) {
								console.log('–ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞')
								mixer = new THREE.AnimationMixer(model)
								const action = mixer.clipAction(gltf.animations[0])
								action.play()
								mixer.timeScale = 0.8
							}

							resolve()
						},
						progress => {
							const percent = Math.round(
								(progress.loaded / progress.total) * 100
							)
							elements.status.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${percent}%`
						},
						error => {
							console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:', error)
							elements.status.textContent =
								'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏. –°–æ–∑–¥–∞—é —Ç–µ—Å—Ç–æ–≤—É—é –º–æ–¥–µ–ª—å...'
							createFallbackModel()
							resolve()
						}
					)
				})
			}

			function createFallbackModel() {
				// –°–æ–∑–¥–∞–µ–º –±–æ–ª–µ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é —Ç–µ—Å—Ç–æ–≤—É—é –º–æ–¥–µ–ª—å
				const group = new THREE.Group()

				// –¢–µ–ª–æ
				const bodyGeometry = new THREE.CylinderGeometry(0.2, 0.3, 0.8, 8)
				const bodyMaterial = new THREE.MeshStandardMaterial({
					color: 0x8b4513,
					roughness: 0.7,
					metalness: 0.2,
				})
				const body = new THREE.Mesh(bodyGeometry, bodyMaterial)
				body.position.y = 0.4
				group.add(body)

				// –ì–æ–ª–æ–≤–∞
				const headGeometry = new THREE.SphereGeometry(0.25, 16, 16)
				const headMaterial = new THREE.MeshStandardMaterial({
					color: 0x8b4513,
					roughness: 0.7,
					metalness: 0.2,
				})
				const head = new THREE.Mesh(headGeometry, headMaterial)
				head.position.set(0, 0.9, 0.4)
				group.add(head)

				// –ù–æ–≥–∏
				const legGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.5, 8)
				const legMaterial = new THREE.MeshStandardMaterial({
					color: 0x8b4513,
					roughness: 0.7,
					metalness: 0.2,
				})

				const legPositions = [
					[-0.15, -0.2, 0.15],
					[0.15, -0.2, 0.15],
					[-0.15, -0.2, -0.15],
					[0.15, -0.2, -0.15],
				]

				legPositions.forEach(pos => {
					const leg = new THREE.Mesh(legGeometry, legMaterial)
					leg.position.set(pos[0], pos[1], pos[2])
					group.add(leg)
				})

				model = group
				model.scale.set(0.8, 0.8, 0.8)
				model.position.set(0, -0.5, 0)
				scene.add(model)

				console.log('–¢–µ—Å—Ç–æ–≤–∞—è –º–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞')
			}

			// ===== –ö–ê–ú–ï–†–ê –£–°–¢–†–û–ô–°–¢–í–ê =====
			async function startCamera() {
				try {
					// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫
					if (videoStream) {
						videoStream.getTracks().forEach(track => track.stop())
					}

					elements.status.textContent = '–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...'

					// –ü—Ä–æ–±—É–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
					let constraints = {
						video: {
							facingMode: currentCamera,
							width: { ideal: 1920 },
							height: { ideal: 1080 },
						},
						audio: false,
					}

					videoStream = await navigator.mediaDevices.getUserMedia(constraints)
					elements.video.srcObject = videoStream

					// –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ
					await new Promise(resolve => {
						elements.video.onloadedmetadata = () => {
							elements.video.play().then(resolve)
						}
					})

					console.log('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error)
					throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.')
				}
			}

			// ===== AR –†–ï–ñ–ò–ú =====
			async function startAR() {
				if (!('xr' in navigator)) {
					alert(
						'–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç AR. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –Ω–∞ Android –∏–ª–∏ Safari –Ω–∞ iOS.'
					)
					return
				}

				try {
					elements.status.textContent = '–ó–∞–ø—É—Å–∫ AR...'

					// –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º AR —Å–µ—Å—Å–∏—é
					arSession = await navigator.xr.requestSession('immersive-ar', {
						requiredFeatures: ['hit-test'],
						optionalFeatures: ['dom-overlay'],
						domOverlay: { root: document.body },
					})

					// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é –≤ —Ä–µ–Ω–¥–µ—Ä–µ—Ä
					await renderer.xr.setSession(arSession)

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º hit-test
					initializeHitTest()

					// –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ AR —Ä–µ–∂–∏–º
					enterARMode()

					// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π AR
					arSession.addEventListener('end', onSessionEnd)

					// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –≤ AR –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–æ–¥–µ–ª–∏
					arSession.addEventListener('select', onSelect)

					console.log('AR —Å–µ—Å—Å–∏—è –∑–∞–ø—É—â–µ–Ω–∞')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ AR:', error)
					elements.status.textContent = '–û—à–∏–±–∫–∞ AR: ' + error.message
					alert(
						'–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å AR. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ HTTPS –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.'
					)
				}
			}

			function initializeHitTest() {
				// –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–æ—á–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
				const session = renderer.xr.getSession()

				session.requestReferenceSpace('viewer').then(referenceSpace => {
					session
						.requestHitTestSource({ space: referenceSpace })
						.then(source => {
							hitTestSource = source
						})
				})
			}

			function enterARMode() {
				isARMode = true
				modelPlaced = false

				// –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
				elements.video.style.display = 'none'
				elements.filter1.style.display = 'none'
				elements.filter2.style.display = 'none'

				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏ –∫–æ–Ω—Ç—Ä–æ–ª—ã
				elements.arInstruction.style.display = 'block'
				elements.arControls.style.display = 'flex'

				// –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
				elements.status.textContent =
					'AR —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω. –ö–æ—Å–Ω–∏—Ç–µ—Å—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–æ–¥–µ–ª–∏.'

				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–æ–¥–µ–ª—å
				if (model) {
					model.visible = false
					model.scale.set(0.3, 0.3, 0.3)
					model.position.set(0, 0, 0)
					modelRotation = 0
					modelScale = 1
				}

				// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
				if (videoStream) {
					videoStream.getTracks().forEach(track => track.stop())
					videoStream = null
				}
			}

			function exitARMode() {
				if (arSession) {
					arSession.end()
				}
			}

			function onSessionEnd() {
				isARMode = false
				arSession = null
				hitTestSource = null
				modelPlaced = false

				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
				elements.video.style.display = 'block'
				elements.filter1.style.display = 'block'
				elements.filter2.style.display = 'block'

				// –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏ –∫–æ–Ω—Ç—Ä–æ–ª—ã
				elements.arInstruction.style.display = 'none'
				elements.arControls.style.display = 'none'

				// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–æ–¥–µ–ª—å
				if (model) {
					model.visible = true
					model.scale.set(0.5, 0.5, 0.5)
					model.position.set(0, -1, 0)
				}

				// –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
				setTimeout(() => {
					startCamera()
				}, 100)

				elements.status.textContent = 'AR —Ä–µ–∂–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω'
			}

			function onSelect(event) {
				if (!modelPlaced && model && hitTestSource) {
					const frame = event.frame
					const hitTestResults = frame.getHitTestResults(hitTestSource)

					if (hitTestResults.length > 0) {
						const hit = hitTestResults[0]
						const pose = hit.getPose(renderer.xr.getReferenceSpace())

						if (pose) {
							// –†–∞–∑–º–µ—â–∞–µ–º –º–æ–¥–µ–ª—å –≤ —Ç–æ—á–∫–µ hit
							model.position.set(
								pose.transform.position.x,
								pose.transform.position.y,
								pose.transform.position.z
							)

							model.visible = true
							modelPlaced = true
							elements.arInstruction.style.display = 'none'
						}
					}
				}
			}

			function updateModelPosition(frame) {
				if (!isARMode || !modelPlaced || !model) return

				// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –∫–∞–º–µ—Ä—ã
				const referenceSpace = renderer.xr.getReferenceSpace()
				const pose = frame.getViewerPose(referenceSpace)

				if (pose) {
					// –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–≤–Ω–æ–µ —Å–ª–µ–∂–µ–Ω–∏–µ –∏–ª–∏ –¥—Ä—É–≥–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
				}
			}

			// ===== –°–û–ë–´–¢–ò–Ø =====
			function setupEvents() {
				// –°–º–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –∫–ª–∏–∫—É
				elements.container.addEventListener('click', () => {
					if (!isFilterChanged && !isARMode) {
						isFilterChanged = true
						elements.filter1.style.opacity = '0'
						elements.filter2.style.opacity = '1'
						elements.container.style.cursor = 'default'
					}
				})

				// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
				elements.switchBtn.addEventListener('click', () => {
					currentCamera =
						currentCamera === 'environment' ? 'user' : 'environment'
					startCamera()
				})

				// –°–∫—Ä–∏–Ω—à–æ—Ç
				elements.screenshotBtn.addEventListener('click', takeScreenshot)

				// AR —Ä–µ–∂–∏–º
				elements.arButton.addEventListener('click', startAR)

				// AR –∫–æ–Ω—Ç—Ä–æ–ª—ã
				elements.arRotateBtn.addEventListener('click', () => {
					if (model && modelPlaced) {
						modelRotation += Math.PI / 4
						model.rotation.y = modelRotation
					}
				})

				elements.arScaleBtn.addEventListener('click', () => {
					if (model && modelPlaced) {
						modelScale = modelScale === 1 ? 1.5 : modelScale === 1.5 ? 0.5 : 1
						model.scale.set(
							0.3 * modelScale,
							0.3 * modelScale,
							0.3 * modelScale
						)
					}
				})

				elements.arExitBtn.addEventListener('click', exitARMode)

				// –†–µ—Å–∞–π–∑ –æ–∫–Ω–∞
				window.addEventListener('resize', onResize)

				// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∂–µ—Å—Ç–æ–≤ –¥–ª—è AR (–Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö)
				let touchStartX, touchStartY

				elements.canvas.addEventListener('touchstart', e => {
					if (isARMode && modelPlaced) {
						touchStartX = e.touches[0].clientX
						touchStartY = e.touches[0].clientY
					}
				})

				elements.canvas.addEventListener('touchend', e => {
					if (isARMode && modelPlaced && e.changedTouches.length === 1) {
						const touchEndX = e.changedTouches[0].clientX
						const touchEndY = e.changedTouches[0].clientY

						// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∂–µ—Å—Ç–∞
						const dx = touchEndX - touchStartX
						const dy = touchEndY - touchStartY

						if (Math.abs(dx) > Math.abs(dy)) {
							// –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø - –≤—Ä–∞—â–µ–Ω–∏–µ
							modelRotation += dx > 0 ? Math.PI / 8 : -Math.PI / 8
							model.rotation.y = modelRotation
						} else {
							// –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø - –º–∞—Å—à—Ç–∞–±
							modelScale = dy > 0 ? modelScale * 1.2 : modelScale * 0.8
							modelScale = Math.max(0.3, Math.min(3, modelScale))
							model.scale.set(
								0.3 * modelScale,
								0.3 * modelScale,
								0.3 * modelScale
							)
						}
					}
				})
			}

			// ===== –°–ö–†–ò–ù–®–û–¢ =====
			function takeScreenshot() {
				if (isARMode) {
					// –í AR —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–Ω–¥–µ—Ä–µ—Ä
					const image = renderer.domElement.toDataURL('image/png')
					downloadImage(image, 'ar-screenshot')
				} else {
					// –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –∫–æ–º–±–∏–Ω–∏—Ä—É–µ–º –≤–∏–¥–µ–æ –∏ 3D
					const tempCanvas = document.createElement('canvas')
					tempCanvas.width = elements.canvas.width
					tempCanvas.height = elements.canvas.height
					const ctx = tempCanvas.getContext('2d')

					// –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω
					ctx.fillStyle = '#000'
					ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height)

					// –í–∏–¥–µ–æ (–∑–µ—Ä–∫–∞–ª—å–Ω–æ –æ—Ç—Ä–∞–∂–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ)
					ctx.save()
					ctx.scale(-1, 1)
					ctx.drawImage(
						elements.video,
						-tempCanvas.width,
						0,
						tempCanvas.width,
						tempCanvas.height
					)
					ctx.restore()

					// 3D –º–æ–¥–µ–ª—å
					ctx.drawImage(elements.canvas, 0, 0)

					// –§–∏–ª—å—Ç—Ä
					const activeFilter =
						elements.filter1.style.opacity === '1'
							? elements.filter1
							: elements.filter2
					ctx.globalCompositeOperation = 'screen'
					ctx.drawImage(activeFilter, 0, 0, tempCanvas.width, tempCanvas.height)

					// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
					const image = tempCanvas.toDataURL('image/png')
					downloadImage(image, '3d-filter-screenshot')
				}

				// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
				elements.status.textContent = '–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!'
				setTimeout(() => {
					elements.status.textContent = isARMode
						? 'AR —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω'
						: '–ì–æ—Ç–æ–≤–æ!'
				}, 2000)
			}

			function downloadImage(dataUrl, filename) {
				const link = document.createElement('a')
				link.download = `${filename}-${Date.now()}.png`
				link.href = dataUrl
				link.click()
			}

			// ===== –ê–ù–ò–ú–ê–¶–ò–Ø =====
			function animate(time) {
				requestAnimationFrame(animate)

				// –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –º–æ–¥–µ–ª–∏
				if (mixer) {
					const delta = time ? time * 0.001 : 0.016
					mixer.update(delta)
				}

				// –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –Ω–µ –≤ AR)
				if (model && !isARMode) {
					model.rotation.y += 0.005
				}

				// –í AR —Ä–µ–∂–∏–º–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
				if (isARMode && renderer.xr.isPresenting) {
					const frame = renderer.xr.getFrame()
					updateModelPosition(frame)
				}

				renderer.render(scene, camera)
			}

			// ===== –†–ï–°–ê–ô–ó =====
			function onResize() {
				const width = elements.container.clientWidth
				const height = elements.container.clientHeight

				camera.aspect = width / height
				camera.updateProjectionMatrix()
				renderer.setSize(width, height)
			}

			// ===== –û–ß–ò–°–¢–ö–ê =====
			function cleanup() {
				if (videoStream) {
					videoStream.getTracks().forEach(track => track.stop())
				}
				if (arSession) {
					arSession.end()
				}
			}

			// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
			window.addEventListener('load', init)
			window.addEventListener('beforeunload', cleanup)
		</script>
	</body>
</html>

<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
		/>
		<title>AR Ð›Ð¾ÑˆÐ°Ð´ÑŒ</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: Arial, sans-serif;
				background: #000;
				color: white;
				width: 100vw;
				height: 100vh;
				overflow: hidden;
			}

			#container {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
			}

			#camera-video {
				position: absolute;
				width: 100%;
				height: 100%;
				object-fit: cover;
				z-index: 1;
				display: none;
			}

			#renderCanvas {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 2;
				display: block;
			}

			.filter {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 3;
				mix-blend-mode: screen;
				opacity: 1;
				transition: opacity 0.5s;
				pointer-events: none;
				display: none;
			}

			.controls {
				position: fixed;
				bottom: 20px;
				left: 0;
				right: 0;
				display: flex;
				justify-content: center;
				gap: 10px;
				z-index: 1000;
			}

			button {
				background: rgba(0, 0, 0, 0.7);
				border: 2px solid white;
				color: white;
				padding: 10px 20px;
				border-radius: 25px;
				font-size: 16px;
				cursor: pointer;
			}

			#ar-button {
				background: #007aff;
			}

			#status {
				position: fixed;
				top: 20px;
				left: 0;
				right: 0;
				text-align: center;
				color: white;
				z-index: 1000;
				font-size: 14px;
				background: rgba(0, 0, 0, 0.5);
				padding: 10px;
			}

			.ar-panel {
				position: fixed;
				bottom: 80px;
				left: 0;
				right: 0;
				display: none;
				justify-content: center;
				gap: 20px;
				z-index: 1000;
			}

			.ar-btn {
				width: 60px;
				height: 60px;
				border-radius: 50%;
				background: rgba(0, 0, 0, 0.7);
				border: 2px solid white;
				color: white;
				font-size: 24px;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<div id="status">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...</div>

		<div id="container">
			<video id="camera-video" autoplay playsinline muted></video>
			<canvas id="renderCanvas"></canvas>
		</div>

		<div class="controls">
			<button id="camera-btn">ðŸ“·</button>
			<button id="screenshot-btn">ðŸ“¸</button>
			<button id="ar-button">ðŸš€ AR</button>
		</div>

		<div class="ar-panel" id="ar-panel">
			<div class="ar-btn" id="rotate-btn">â†»</div>
			<div class="ar-btn" id="scale-btn">âŠ•</div>
			<div class="ar-btn" id="exit-btn">âœ•</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>

		<script>
			// ========== Ð¡ÐžÐ¡Ð¢ÐžÐ¯ÐÐ˜Ð• ÐŸÐ Ð˜Ð›ÐžÐ–Ð•ÐÐ˜Ð¯ ==========
			const state = {
				scene: null,
				camera: null,
				renderer: null,
				model: null,
				mixer: null,
				videoStream: null,
				isARMode: false,
				arSession: null,
				modelPlaced: false,
				currentCamera: 'environment',
				scale: 0.3,
				rotation: 0,
			}

			// ========== Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ ==========
			async function init() {
				try {
					// 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ ÐºÐ°Ð¼ÐµÑ€Ñ‹
					if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
						showError('ÐšÐ°Ð¼ÐµÑ€Ð° Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ')
						return
					}

					// 2. Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Three.js
					initThreeJS()

					// 3. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ°Ð¼ÐµÑ€Ñƒ
					await startCamera()

					// 4. Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
					await loadModel()

					// 5. ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
					setupEvents()

					// 6. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ€ÐµÐ½Ð´ÐµÑ€Ð¸Ð½Ð³
					animate()

					updateStatus('Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ AR Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°.')
				} catch (error) {
					console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸:', error)
					showError('ÐžÑˆÐ¸Ð±ÐºÐ°: ' + error.message)
				}
			}

			// ========== THREE.JS ==========
			function initThreeJS() {
				// Ð¡Ñ†ÐµÐ½Ð°
				state.scene = new THREE.Scene()

				// ÐšÐ°Ð¼ÐµÑ€Ð°
				state.camera = new THREE.PerspectiveCamera(
					60,
					window.innerWidth / window.innerHeight,
					0.1,
					100
				)
				state.camera.position.set(0, 1, 3)

				// Ð ÐµÐ½Ð´ÐµÑ€ÐµÑ€
				state.renderer = new THREE.WebGLRenderer({
					canvas: document.getElementById('renderCanvas'),
					alpha: true,
					antialias: true,
				})
				state.renderer.setSize(window.innerWidth, window.innerHeight)
				state.renderer.setPixelRatio(window.devicePixelRatio)
				state.renderer.setClearColor(0x000000, 0)

				// ÐžÑÐ²ÐµÑ‰ÐµÐ½Ð¸Ðµ
				const light1 = new THREE.AmbientLight(0xffffff, 0.6)
				state.scene.add(light1)

				const light2 = new THREE.DirectionalLight(0xffffff, 0.8)
				light2.position.set(5, 10, 7)
				state.scene.add(light2)
			}

			// ========== ÐšÐÐœÐ•Ð Ð Ð£Ð¡Ð¢Ð ÐžÐ™Ð¡Ð¢Ð’Ð ==========
			async function startCamera() {
				try {
					updateStatus('Ð—Ð°Ð¿Ñ€Ð¾Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹...')

					// ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ð¿Ð¾Ñ‚Ð¾Ðº
					if (state.videoStream) {
						state.videoStream.getTracks().forEach(track => track.stop())
					}

					const constraints = {
						video: {
							facingMode: state.currentCamera,
							width: { ideal: 1280 },
							height: { ideal: 720 },
						},
						audio: false,
					}

					state.videoStream = await navigator.mediaDevices.getUserMedia(
						constraints
					)
					const video = document.getElementById('camera-video')
					video.srcObject = state.videoStream

					await video.play()

					// ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ð¸Ð´ÐµÐ¾ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð² Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ
					if (!state.isARMode) {
						video.style.display = 'block'
					}
				} catch (error) {
					console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ°Ð¼ÐµÑ€Ñ‹:', error)
					throw new Error('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ')
				}
			}

			// ========== Ð—ÐÐ“Ð Ð£Ð—ÐšÐ ÐœÐžÐ”Ð•Ð›Ð˜ ==========
			async function loadModel() {
				return new Promise(resolve => {
					updateStatus('Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¼Ð¾Ð´ÐµÐ»Ð¸...')

					// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ ÑÑ‚Ð°Ñ€Ñ‚Ð°
					createTestModel()
					resolve()

					// ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾ Ð¿Ñ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¾ÑÐ½Ð¾Ð²Ð½ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
					try {
						const loader = new THREE.GLTFLoader()
						loader.load(
							'./assets/model/Horse_animation.gltf',
							gltf => {
								console.log('ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°')

								// Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
								if (state.model) {
									state.scene.remove(state.model)
								}

								// Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
								state.model = gltf.scene
								state.model.scale.set(0.3, 0.3, 0.3)
								state.model.position.set(0, -1, 0)
								state.model.rotation.y = Math.PI / 4
								state.scene.add(state.model)

								// ÐÐ½Ð¸Ð¼Ð°Ñ†Ð¸Ñ
								if (gltf.animations?.length > 0) {
									state.mixer = new THREE.AnimationMixer(state.model)
									state.mixer.clipAction(gltf.animations[0]).play()
								}

								updateStatus('ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°')
							},
							undefined,
							error => {
								console.warn('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¼Ð¾Ð´ÐµÐ»ÑŒ:', error)
								// ÐžÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
							}
						)
					} catch (error) {
						console.warn('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¼Ð¾Ð´ÐµÐ»Ð¸:', error)
					}
				})
			}

			function createTestModel() {
				// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð°
				const geometry = new THREE.ConeGeometry(0.5, 1, 8)
				const material = new THREE.MeshNormalMaterial()
				state.model = new THREE.Mesh(geometry, material)
				state.model.position.set(0, 0, 0)
				state.scene.add(state.model)
			}

			// ========== AR Ð Ð•Ð–Ð˜Ðœ ==========
			async function startAR() {
				if (!('xr' in navigator)) {
					alert(
						'AR Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð² Chrome Ð½Ð° Android Ð¸Ð»Ð¸ Safari Ð½Ð° iOS.'
					)
					return
				}

				try {
					updateStatus('Ð—Ð°Ð¿ÑƒÑÐº AR...')

					// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÑƒ
					const supported = await navigator.xr.isSessionSupported(
						'immersive-ar'
					)
					if (!supported) {
						alert('AR Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð½Ð° ÑÑ‚Ð¾Ð¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ')
						return
					}

					// Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ ÑÐµÑÑÐ¸ÑŽ
					state.arSession = await navigator.xr.requestSession('immersive-ar', {
						requiredFeatures: ['hit-test'],
						optionalFeatures: ['dom-overlay'],
						domOverlay: { root: document.body },
					})

					// ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ñ€ÐµÐ½Ð´ÐµÑ€ÐµÑ€
					await state.renderer.xr.setSession(state.arSession)
					state.renderer.xr.enabled = true

					// Ð’Ñ…Ð¾Ð´Ð¸Ð¼ Ð² AR Ñ€ÐµÐ¶Ð¸Ð¼
					enterARMode()

					// ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸
					state.arSession.addEventListener('end', () => {
						exitARMode()
					})

					// ÐšÐ»Ð¸Ðº Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸
					state.arSession.addEventListener('select', event => {
						if (!state.modelPlaced && state.model) {
							placeModelInAR(event)
						}
					})

					updateStatus('AR Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½. ÐšÐ¾ÑÐ½Ð¸Ñ‚ÐµÑÑŒ Ð¿Ð¾Ð²ÐµÑ€Ñ…Ð½Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ.')
				} catch (error) {
					console.error('ÐžÑˆÐ¸Ð±ÐºÐ° AR:', error)
					alert('ÐžÑˆÐ¸Ð±ÐºÐ° AR: ' + error.message)
					updateStatus('ÐžÑˆÐ¸Ð±ÐºÐ° AR')
				}
			}

			function enterARMode() {
				state.isARMode = true
				state.modelPlaced = false

				// Ð¡ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ð¸Ð´ÐµÐ¾ ÐºÐ°Ð¼ÐµÑ€Ñ‹
				document.getElementById('camera-video').style.display = 'none'

				// ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð°Ð½ÐµÐ»ÑŒ AR
				document.getElementById('ar-panel').style.display = 'flex'

				// ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ°Ð¼ÐµÑ€Ñƒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°
				if (state.videoStream) {
					state.videoStream.getTracks().forEach(track => track.stop())
					state.videoStream = null
				}

				// ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
				if (state.model) {
					state.model.visible = false
					state.model.scale.set(state.scale, state.scale, state.scale)
				}

				updateStatus('ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð° Ð¿Ð¾Ð²ÐµÑ€Ñ…Ð½Ð¾ÑÑ‚ÑŒ Ð¸ ÐºÐ¾ÑÐ½Ð¸Ñ‚ÐµÑÑŒ ÑÐºÑ€Ð°Ð½Ð°')
			}

			function exitARMode() {
				state.isARMode = false
				state.modelPlaced = false

				// ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ð¸Ð´ÐµÐ¾
				document.getElementById('camera-video').style.display = 'block'

				// Ð¡ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð°Ð½ÐµÐ»ÑŒ AR
				document.getElementById('ar-panel').style.display = 'none'

				// Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
				if (state.model) {
					state.model.visible = true
					state.model.position.set(0, -1, 0)
					state.model.scale.set(0.3, 0.3, 0.3)
				}

				// ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ°Ð¼ÐµÑ€Ñƒ
				setTimeout(startCamera, 100)

				updateStatus('AR Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½')
			}

			function placeModelInAR(event) {
				if (!state.arSession || !state.model) return

				const frame = event.frame
				const referenceSpace = state.renderer.xr.getReferenceSpace()

				// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ hit-test
				const hitTestResults = frame.getHitTestResults(window.hitTestSource)

				if (hitTestResults.length > 0) {
					const hit = hitTestResults[0]
					const pose = hit.getPose(referenceSpace)

					if (pose) {
						// Ð Ð°Ð·Ð¼ÐµÑ‰Ð°ÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÑŒ
						state.model.position.set(
							pose.transform.position.x,
							pose.transform.position.y,
							pose.transform.position.z
						)

						state.model.visible = true
						state.modelPlaced = true

						updateStatus('ÐœÐ¾Ð´ÐµÐ»ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð°!')
					}
				}
			}

			// ========== Ð£ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• ==========
			function setupEvents() {
				// ÐšÐ½Ð¾Ð¿ÐºÐ° ÐºÐ°Ð¼ÐµÑ€Ñ‹
				document.getElementById('camera-btn').addEventListener('click', () => {
					state.currentCamera =
						state.currentCamera === 'environment' ? 'user' : 'environment'
					startCamera()
				})

				// Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚
				document
					.getElementById('screenshot-btn')
					.addEventListener('click', () => {
						takeScreenshot()
					})

				// AR ÐºÐ½Ð¾Ð¿ÐºÐ°
				document.getElementById('ar-button').addEventListener('click', startAR)

				// AR ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ñ‹
				document.getElementById('rotate-btn').addEventListener('click', () => {
					if (state.model && state.modelPlaced) {
						state.rotation += Math.PI / 4
						state.model.rotation.y = state.rotation
					}
				})

				document.getElementById('scale-btn').addEventListener('click', () => {
					if (state.model && state.modelPlaced) {
						state.scale =
							state.scale === 0.3 ? 0.5 : state.scale === 0.5 ? 0.1 : 0.3
						state.model.scale.set(state.scale, state.scale, state.scale)
					}
				})

				document
					.getElementById('exit-btn')
					.addEventListener('click', exitARMode)

				// Ð ÐµÑÐ°Ð¹Ð· Ð¾ÐºÐ½Ð°
				window.addEventListener('resize', () => {
					state.camera.aspect = window.innerWidth / window.innerHeight
					state.camera.updateProjectionMatrix()
					state.renderer.setSize(window.innerWidth, window.innerHeight)
				})

				// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
				window.addEventListener('error', e => {
					console.error('Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°:', e.error)
					updateStatus('ÐžÑˆÐ¸Ð±ÐºÐ°: ' + e.error.message)
				})
			}

			// ========== Ð¡ÐšÐ Ð˜ÐÐ¨ÐžÐ¢ ==========
			function takeScreenshot() {
				const canvas = document.getElementById('renderCanvas')
				const link = document.createElement('a')
				link.download = `ar-${Date.now()}.png`
				link.href = canvas.toDataURL('image/png')
				link.click()
				updateStatus('Ð¡Ð½Ð¸Ð¼Ð¾Ðº ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½!')
			}

			// ========== ÐÐÐ˜ÐœÐÐ¦Ð˜Ð¯ ==========
			function animate() {
				requestAnimationFrame(animate)

				// ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸ÑŽ Ð¼Ð¾Ð´ÐµÐ»Ð¸
				if (state.mixer && !state.isARMode) {
					state.mixer.update(0.016) // 60 FPS
				}

				// Ð’Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ
				if (state.model && !state.isARMode) {
					state.model.rotation.y += 0.01
				}

				// Ð ÐµÐ½Ð´ÐµÑ€
				state.renderer.render(state.scene, state.camera)
			}

			// ========== Ð’Ð¡ÐŸÐžÐœÐžÐ“ÐÐ¢Ð•Ð›Ð¬ÐÐ«Ð• Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ ==========
			function updateStatus(text) {
				document.getElementById('status').textContent = text
				console.log('Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:', text)
			}

			function showError(message) {
				updateStatus('ÐžÑˆÐ¸Ð±ÐºÐ°: ' + message)
				alert(message)
			}

			// ========== Ð—ÐÐŸÐ£Ð¡Ðš ==========
			// Ð–Ð´ÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', init)
			} else {
				init()
			}

			// ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸
			window.addEventListener('beforeunload', () => {
				if (state.videoStream) {
					state.videoStream.getTracks().forEach(track => track.stop())
				}
				if (state.arSession) {
					state.arSession.end()
				}
			})
		</script>
	</body>
</html>

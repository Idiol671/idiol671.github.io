<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AR –ú–æ–¥–µ–ª—å —Å –§–∏–ª—å—Ç—Ä–æ–º</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: sans-serif;
				background: #000;
				color: white;
				width: 100vw;
				height: 100vh;
				overflow: hidden;
				display: flex;
				flex-direction: column;
				align-items: center;
			}

			h1 {
				margin: 20px 0 10px;
				text-align: center;
				font-size: 22px;
			}

			#container {
				position: relative;
				width: 90vw;
				height: 60vh;
				max-width: 400px;
				border-radius: 20px;
				overflow: hidden;
				background: #111;
			}

			#video-container {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 1;
			}

			#camera-video {
				width: 100%;
				height: 100%;
				object-fit: cover;
				transform: scaleX(-1);
			}

			#renderCanvas {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 2;
				display: block;
			}

			.filter-overlay {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: 3;
				mix-blend-mode: screen;
				pointer-events: none;
				opacity: 1;
				transition: opacity 0.5s;
			}

			#filter2 {
				opacity: 0;
			}

			.controls {
				margin-top: 20px;
				display: flex;
				gap: 10px;
			}

			button {
				background: rgba(255, 255, 255, 0.1);
				border: 1px solid rgba(255, 255, 255, 0.3);
				color: white;
				padding: 10px 20px;
				border-radius: 25px;
				cursor: pointer;
				font-size: 14px;
			}

			#ar-button {
				background: #007aff;
				border-color: #007aff;
				font-weight: bold;
			}

			#status {
				margin-top: 10px;
				text-align: center;
				color: #aaa;
				font-size: 14px;
				min-height: 20px;
				padding: 0 20px;
			}

			.ar-instruction {
				position: absolute;
				top: 20px;
				left: 20px;
				right: 20px;
				background: rgba(0, 0, 0, 0.8);
				color: white;
				padding: 15px;
				border-radius: 10px;
				text-align: center;
				z-index: 1000;
				display: none;
			}

			.ar-controls {
				position: absolute;
				bottom: 20px;
				left: 0;
				right: 0;
				display: flex;
				justify-content: center;
				gap: 20px;
				z-index: 1000;
				display: none;
			}

			.ar-btn {
				background: rgba(0, 0, 0, 0.7);
				border: 2px solid white;
				color: white;
				width: 50px;
				height: 50px;
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 20px;
				cursor: pointer;
			}

			.hidden {
				display: none;
			}
		</style>
	</head>
	<body>
		<h1>AR –ú–æ–¥–µ–ª—å —Å –§–∏–ª—å—Ç—Ä–æ–º</h1>

		<div id="container">
			<div id="video-container">
				<video id="camera-video" autoplay playsinline muted></video>
			</div>
			<canvas id="renderCanvas"></canvas>
			<img
				class="filter-overlay"
				id="filter1"
				src="./assets/ice-1.png"
				alt="–§–∏–ª—å—Ç—Ä"
			/>
			<img
				class="filter-overlay"
				id="filter2"
				src="./assets/ice-4.png"
				alt="–§–∏–ª—å—Ç—Ä"
			/>

			<div class="ar-instruction" id="ar-instruction">
				–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –∏ –∫–æ—Å–Ω–∏—Ç–µ—Å—å —ç–∫—Ä–∞–Ω–∞
			</div>

			<div class="ar-controls" id="ar-controls">
				<div class="ar-btn" id="ar-rotate">‚Üª</div>
				<div class="ar-btn" id="ar-scale">‚äï</div>
				<div class="ar-btn" id="ar-exit">‚úï</div>
			</div>
		</div>

		<div class="controls">
			<button id="switch-camera">üì∑ –ö–∞–º–µ—Ä–∞</button>
			<button id="screenshot">üì∏ –°–Ω–∏–º–æ–∫</button>
			<button id="ar-button">üöÄ AR</button>
		</div>

		<div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

		<!-- –¢–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
		<script>
			// ===== –£–ü–†–û–©–ï–ù–ù–´–ô –ò –°–¢–ê–ë–ò–õ–¨–ù–´–ô –ö–û–î =====
			let scene, camera, renderer, model
			let videoStream = null
			let filterSwitched = false
			let isARMode = false
			let currentCamera = 'environment'

			// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
			const elements = {
				video: document.getElementById('camera-video'),
				canvas: document.getElementById('renderCanvas'),
				filter1: document.getElementById('filter1'),
				filter2: document.getElementById('filter2'),
				switchBtn: document.getElementById('switch-camera'),
				screenshotBtn: document.getElementById('screenshot'),
				arButton: document.getElementById('ar-button'),
				status: document.getElementById('status'),
				arInstruction: document.getElementById('ar-instruction'),
				arControls: document.getElementById('ar-controls'),
			}

			// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
			async function init() {
				try {
					console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...')

					// 1. –°–æ–∑–¥–∞–µ–º Three.js —Å—Ü–µ–Ω—É
					createScene()

					// 2. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
					await startCamera()

					// 3. –°–æ–∑–¥–∞–µ–º –º–æ–¥–µ–ª—å
					createModel()

					// 4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
					setupEvents()

					// 5. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
					animate()

					elements.status.textContent =
						'–ì–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –¥–ª—è —Å–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–∞.'
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞:', error)
					elements.status.textContent = '–û—à–∏–±–∫–∞: ' + error.message
				}
			}

			// ===== THREE.JS –°–¶–ï–ù–ê =====
			function createScene() {
				// –°—Ü–µ–Ω–∞
				scene = new THREE.Scene()

				// –ö–∞–º–µ—Ä–∞
				const aspect =
					elements.container.clientWidth / elements.container.clientHeight
				camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 100)
				camera.position.set(0, 1, 3)

				// –†–µ–Ω–¥–µ—Ä–µ—Ä
				renderer = new THREE.WebGLRenderer({
					canvas: elements.canvas,
					alpha: true,
					antialias: true,
				})
				renderer.setSize(
					elements.container.clientWidth,
					elements.container.clientHeight
				)
				renderer.setClearColor(0x000000, 0)

				// –û—Å–≤–µ—â–µ–Ω–∏–µ
				const light1 = new THREE.AmbientLight(0xffffff, 1)
				scene.add(light1)

				const light2 = new THREE.DirectionalLight(0xffffff, 1)
				light2.position.set(5, 10, 5)
				scene.add(light2)
			}

			// ===== –ö–ê–ú–ï–†–ê –£–°–¢–†–û–ô–°–¢–í–ê =====
			async function startCamera() {
				try {
					// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫
					if (videoStream) {
						videoStream.getTracks().forEach(track => track.stop())
					}

					elements.status.textContent = '–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...'

					const constraints = {
						video: {
							facingMode: currentCamera,
							width: { ideal: 1280 },
							height: { ideal: 720 },
						},
						audio: false,
					}

					videoStream = await navigator.mediaDevices.getUserMedia(constraints)
					elements.video.srcObject = videoStream

					// –ñ–¥–µ–º –ø–æ–∫–∞ –≤–∏–¥–µ–æ –Ω–∞—á–Ω–µ—Ç –∏–≥—Ä–∞—Ç—å
					await new Promise(resolve => {
						elements.video.onloadedmetadata = () => {
							elements.video.play().then(resolve)
						}
					})

					console.log('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error)
					throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É')
				}
			}

			// ===== –°–û–ó–î–ê–ù–ò–ï –ú–û–î–ï–õ–ò =====
			function createModel() {
				// –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –º–æ–¥–µ–ª—å –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
				const geometry = new THREE.ConeGeometry(0.3, 0.6, 8)
				const material = new THREE.MeshPhongMaterial({
					color: 0x2196f3,
					shininess: 100,
				})

				model = new THREE.Mesh(geometry, material)
				model.position.set(0, -0.5, 0)
				scene.add(model)
			}

			// ===== –°–û–ë–´–¢–ò–Ø =====
			function setupEvents() {
				// –°–º–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –∫–ª–∏–∫—É
				elements.container.addEventListener('click', e => {
					if (!filterSwitched && e.target === elements.canvas) {
						filterSwitched = true
						elements.filter1.style.opacity = '0'
						elements.filter2.style.opacity = '1'
						elements.container.style.cursor = 'default'
					}
				})

				// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
				elements.switchBtn.addEventListener('click', () => {
					currentCamera =
						currentCamera === 'environment' ? 'user' : 'environment'
					startCamera()
				})

				// –°–∫—Ä–∏–Ω—à–æ—Ç
				elements.screenshotBtn.addEventListener('click', takeScreenshot)

				// AR —Ä–µ–∂–∏–º
				elements.arButton.addEventListener('click', () => {
					if (isARMode) {
						exitAR()
					} else {
						startAR()
					}
				})

				// –ö–æ–Ω—Ç—Ä–æ–ª—ã AR
				document.getElementById('ar-rotate').addEventListener('click', () => {
					if (model) {
						model.rotation.y += Math.PI / 4
					}
				})

				document.getElementById('ar-scale').addEventListener('click', () => {
					if (model) {
						const scale =
							model.scale.x === 0.5 ? 1 : model.scale.x === 1 ? 2 : 0.5
						model.scale.set(scale, scale, scale)
					}
				})

				document.getElementById('ar-exit').addEventListener('click', exitAR)

				// –†–µ—Å–∞–π–∑ –æ–∫–Ω–∞
				window.addEventListener('resize', onResize)
			}

			// ===== AR –†–ï–ñ–ò–ú =====
			function startAR() {
				if (!('xr' in navigator)) {
					alert(
						'AR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n‚Ä¢ Chrome –Ω–∞ Android\n‚Ä¢ Safari –Ω–∞ iOS\n\n–¢–∞–∫–∂–µ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –ø–æ HTTPS.'
					)
					return
				}

				// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É AR
				navigator.xr
					.isSessionSupported('immersive-ar')
					.then(supported => {
						if (supported) {
							enterAR()
						} else {
							alert('AR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.')
						}
					})
					.catch(() => {
						alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É AR.')
					})
			}

			function enterAR() {
				isARMode = true

				// –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
				elements.video.style.display = 'none'
				elements.filter1.style.display = 'none'
				elements.filter2.style.display = 'none'

				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏ –∫–æ–Ω—Ç—Ä–æ–ª—ã
				elements.arInstruction.style.display = 'block'
				elements.arControls.style.display = 'flex'

				// –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É AR
				elements.arButton.textContent = 'üõë –í—ã—Ö–æ–¥ –∏–∑ AR'

				// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
				if (videoStream) {
					videoStream.getTracks().forEach(track => track.stop())
					videoStream = null
				}

				elements.status.textContent =
					'AR —Ä–µ–∂–∏–º: –∫–æ—Å–Ω–∏—Ç–µ—Å—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–æ–¥–µ–ª–∏'

				// –ó–∞–ø—É—Å–∫–∞–µ–º AR —Å–µ—Å—Å–∏—é
				navigator.xr
					.requestSession('immersive-ar', {
						requiredFeatures: ['hit-test'],
						optionalFeatures: ['dom-overlay'],
						domOverlay: { root: document.body },
					})
					.then(session => {
						console.log('AR —Å–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞')

						// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–µ—Ä –¥–ª—è XR
						renderer.xr.enabled = true
						renderer.xr.setSession(session)

						// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –≤ AR
						session.addEventListener('select', event => {
							console.log('–ö–ª–∏–∫ –≤ AR')
							// –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
						})

						// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
						session.addEventListener('end', () => {
							console.log('AR —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞')
							exitAR()
						})
					})
					.catch(error => {
						console.error('–û—à–∏–±–∫–∞ AR —Å–µ—Å—Å–∏–∏:', error)
						exitAR()
						alert('–û—à–∏–±–∫–∞ AR: ' + error.message)
					})
			}

			function exitAR() {
				isARMode = false

				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
				elements.video.style.display = 'block'
				elements.filter1.style.display = 'block'
				elements.filter2.style.display = 'block'

				// –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏ –∫–æ–Ω—Ç—Ä–æ–ª—ã
				elements.arInstruction.style.display = 'none'
				elements.arControls.style.display = 'none'

				// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É AR
				elements.arButton.textContent = 'üöÄ AR'

				// –í—ã—Ö–æ–¥–∏–º –∏–∑ XR —Å–µ—Å—Å–∏–∏
				if (renderer.xr.getSession()) {
					renderer.xr.getSession().end()
					renderer.xr.enabled = false
				}

				// –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
				setTimeout(() => {
					startCamera()
				}, 100)

				elements.status.textContent = 'AR —Ä–µ–∂–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω'
			}

			// ===== –°–ö–†–ò–ù–®–û–¢ =====
			function takeScreenshot() {
				// –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
				const controls = document.querySelector('.controls')
				const arControls = document.getElementById('ar-controls')
				const arInstruction = document.getElementById('ar-instruction')

				const controlsHidden = controls.style.visibility
				const arControlsHidden = arControls.style.visibility
				const arInstructionHidden = arInstruction.style.visibility

				controls.style.visibility = 'hidden'
				arControls.style.visibility = 'hidden'
				arInstruction.style.visibility = 'hidden'

				setTimeout(() => {
					const canvas = elements.canvas
					const link = document.createElement('a')
					link.download = `model-${Date.now()}.png`
					link.href = canvas.toDataURL('image/png')
					link.click()

					// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤
					controls.style.visibility = controlsHidden
					arControls.style.visibility = arControlsHidden
					arInstruction.style.visibility = arInstructionHidden

					elements.status.textContent = '–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!'
					setTimeout(() => {
						elements.status.textContent = '–ì–æ—Ç–æ–≤–æ'
					}, 2000)
				}, 100)
			}

			// ===== –ê–ù–ò–ú–ê–¶–ò–Ø =====
			function animate() {
				requestAnimationFrame(animate)

				// –í—Ä–∞—â–∞–µ–º –º–æ–¥–µ–ª—å
				if (model && !isARMode) {
					model.rotation.y += 0.01
				}

				// –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ü–µ–Ω—É
				if (renderer && scene && camera) {
					renderer.render(scene, camera)
				}
			}

			// ===== –†–ï–°–ê–ô–ó =====
			function onResize() {
				const container = document.getElementById('container')
				const width = container.clientWidth
				const height = container.clientHeight

				if (camera && renderer) {
					camera.aspect = width / height
					camera.updateProjectionMatrix()
					renderer.setSize(width, height)
				}
			}

			// ===== –û–ß–ò–°–¢–ö–ê =====
			function cleanup() {
				if (videoStream) {
					videoStream.getTracks().forEach(track => track.stop())
				}
			}

			// ===== –ó–ê–ü–£–°–ö =====
			// –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', init)
			} else {
				init()
			}

			// –û—á–∏—â–∞–µ–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
			window.addEventListener('beforeunload', cleanup)
		</script>
	</body>
</html>

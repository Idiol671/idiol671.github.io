<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>3D –ú–æ–¥–µ–ª—å —Å –§–∏–ª—å—Ç—Ä–æ–º</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: sans-serif;
				background: #000;
				color: white;
				height: 100vh;
				display: flex;
				flex-direction: column;
				align-items: center;
				padding: 20px;
			}

			h1 {
				margin: 10px 0;
				text-align: center;
				font-size: 22px;
			}

			#container {
				position: relative;
				width: 100%;
				max-width: 400px;
				height: 60vh;
				border-radius: 20px;
				overflow: hidden;
				background: #111;
			}

			#video-container {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 1;
			}

			#camera-video {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}

			#canvas-container {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 2;
			}

			#renderCanvas {
				width: 100%;
				height: 100%;
				display: block;
			}

			.filter {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: 3;
				mix-blend-mode: screen;
				pointer-events: none;
				opacity: 1;
				transition: opacity 0.3s;
			}

			#filter2 {
				opacity: 0;
			}

			.controls {
				margin-top: 20px;
				display: flex;
				gap: 10px;
			}

			button {
				background: rgba(255, 255, 255, 0.1);
				border: 1px solid rgba(255, 255, 255, 0.3);
				color: white;
				padding: 10px 20px;
				border-radius: 25px;
				cursor: pointer;
				font-size: 14px;
			}

			#ar-button {
				background: #007aff;
				border-color: #007aff;
			}

			#status {
				margin-top: 10px;
				text-align: center;
				color: #aaa;
				font-size: 14px;
				min-height: 20px;
			}

			.hidden {
				display: none !important;
			}
		</style>
	</head>
	<body>
		<h1>3D –ú–æ–¥–µ–ª—å —Å –§–∏–ª—å—Ç—Ä–æ–º</h1>

		<div id="container">
			<div id="video-container">
				<video id="camera-video" autoplay playsinline muted></video>
			</div>
			<div id="canvas-container">
				<canvas id="renderCanvas"></canvas>
			</div>
			<img class="filter" id="filter1" src="./assets/ice-1.png" alt="–§–∏–ª—å—Ç—Ä" />
			<img class="filter" id="filter2" src="./assets/ice-4.png" alt="–§–∏–ª—å—Ç—Ä" />
		</div>

		<div class="controls">
			<button id="switch-camera">üì∑ –ö–∞–º–µ—Ä–∞</button>
			<button id="screenshot">üì∏ –°–Ω–∏–º–æ–∫</button>
			<button id="ar-button" class="hidden">üöÄ AR</button>
		</div>

		<div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

		<!-- –¢–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–π Three.js -->
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
		<script>
			// ===== –ü–†–û–°–¢–û–ô –ò –°–¢–ê–ë–ò–õ–¨–ù–´–ô –ö–û–î =====
			let scene, camera, renderer, model, mixer
			let videoStream = null
			let isFilterChanged = false
			let currentCamera = 'environment'
			let arSupported = false

			// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
			const elements = {
				container: document.getElementById('container'),
				video: document.getElementById('camera-video'),
				canvas: document.getElementById('renderCanvas'),
				filter1: document.getElementById('filter1'),
				filter2: document.getElementById('filter2'),
				switchBtn: document.getElementById('switch-camera'),
				screenshotBtn: document.getElementById('screenshot'),
				arButton: document.getElementById('ar-button'),
				status: document.getElementById('status'),
			}

			// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
			async function init() {
				try {
					console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===')

					// 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É AR
					checkARSupport()

					// 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Three.js
					initThreeJS()

					// 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
					await startCamera()

					// 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å
					loadModel()

					// 5. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
					setupEvents()

					// 6. –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–Ω–¥–µ—Ä
					animate()

					elements.status.textContent =
						'–ì–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –¥–ª—è —Å–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–∞.'
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error)
					elements.status.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message
				}
			}

			// ===== –ü–†–û–í–ï–†–ö–ê –ü–û–î–î–ï–†–ñ–ö–ò AR =====
			function checkARSupport() {
				// –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –µ—Å–ª–∏ –Ω–∞ iOS/Android –∏ –µ—Å—Ç—å –∫–∞–º–µ—Ä–∞
				const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
				const hasGetUserMedia = !!navigator.mediaDevices?.getUserMedia

				arSupported = isMobile && hasGetUserMedia

				if (arSupported) {
					elements.arButton.classList.remove('hidden')
					console.log('AR —Ä–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ')
				}
			}

			// ===== THREE.JS =====
			function initThreeJS() {
				// –°—Ü–µ–Ω–∞
				scene = new THREE.Scene()

				// –ö–∞–º–µ—Ä–∞
				const aspect =
					elements.container.clientWidth / elements.container.clientHeight
				camera = new THREE.PerspectiveCamera(50, aspect, 0.1, 100)
				camera.position.set(0, 0.5, 2)

				// –†–µ–Ω–¥–µ—Ä–µ—Ä
				renderer = new THREE.WebGLRenderer({
					canvas: elements.canvas,
					alpha: true,
					antialias: true,
				})
				renderer.setSize(
					elements.container.clientWidth,
					elements.container.clientHeight
				)
				renderer.setClearColor(0x000000, 0)

				// –û—Å–≤–µ—â–µ–Ω–∏–µ
				const light1 = new THREE.AmbientLight(0xffffff, 1)
				scene.add(light1)

				const light2 = new THREE.DirectionalLight(0xffffff, 1)
				light2.position.set(1, 2, 3)
				scene.add(light2)
			}

			// ===== –ö–ê–ú–ï–†–ê –£–°–¢–†–û–ô–°–¢–í–ê =====
			async function startCamera() {
				try {
					// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫
					if (videoStream) {
						videoStream.getTracks().forEach(track => track.stop())
					}

					elements.status.textContent = '–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...'

					// –ü—Ä–æ–±—É–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
					let constraints = {
						video: {
							facingMode: currentCamera,
							width: { ideal: 1280 },
							height: { ideal: 720 },
						},
						audio: false,
					}

					videoStream = await navigator.mediaDevices.getUserMedia(constraints)
					elements.video.srcObject = videoStream

					// –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ
					await new Promise(resolve => {
						elements.video.onloadedmetadata = () => {
							elements.video.play().then(resolve)
						}
					})

					console.log('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error)
					throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É')
				}
			}

			// ===== –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò =====
			function loadModel() {
				// –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –º–æ–¥–µ–ª—å –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
				const geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3)
				const material = new THREE.MeshStandardMaterial({
					color: 0x2196f3,
					emissive: 0x0a3d62,
					emissiveIntensity: 0.5,
				})

				model = new THREE.Mesh(geometry, material)
				model.position.set(0, -0.3, 0)
				scene.add(model)

				elements.status.textContent = '–ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞'
			}

			// ===== –°–û–ë–´–¢–ò–Ø =====
			function setupEvents() {
				// –°–º–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –∫–ª–∏–∫—É
				elements.container.addEventListener('click', () => {
					if (!isFilterChanged) {
						isFilterChanged = true
						elements.filter1.style.opacity = '0'
						elements.filter2.style.opacity = '1'
						elements.container.style.cursor = 'default'
					}
				})

				// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
				elements.switchBtn.addEventListener('click', () => {
					currentCamera =
						currentCamera === 'environment' ? 'user' : 'environment'
					startCamera()
				})

				// –°–∫—Ä–∏–Ω—à–æ—Ç
				elements.screenshotBtn.addEventListener('click', takeScreenshot)

				// AR —Ä–µ–∂–∏–º (–ø—Ä–æ—Å—Ç–æ–π)
				elements.arButton.addEventListener('click', () => {
					alert(
						'–î–ª—è AR —Ä–µ–∂–∏–º–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ Chrome –Ω–∞ Android –∏–ª–∏ Safari –Ω–∞ iOS –ø–æ HTTPS —Å—Å—ã–ª–∫–µ'
					)
				})

				// –†–µ—Å–∞–π–∑ –æ–∫–Ω–∞
				window.addEventListener('resize', onResize)
			}

			// ===== –°–ö–†–ò–ù–®–û–¢ =====
			function takeScreenshot() {
				const tempCanvas = document.createElement('canvas')
				tempCanvas.width = elements.canvas.width
				tempCanvas.height = elements.canvas.height
				const ctx = tempCanvas.getContext('2d')

				// –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω
				ctx.fillStyle = '#000'
				ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height)

				// –í–∏–¥–µ–æ
				if (elements.video.videoWidth > 0) {
					ctx.drawImage(
						elements.video,
						0,
						0,
						tempCanvas.width,
						tempCanvas.height
					)
				}

				// 3D –º–æ–¥–µ–ª—å
				ctx.drawImage(elements.canvas, 0, 0)

				// –§–∏–ª—å—Ç—Ä
				const activeFilter =
					elements.filter1.style.opacity === '1'
						? elements.filter1
						: elements.filter2
				ctx.globalCompositeOperation = 'screen'
				ctx.drawImage(activeFilter, 0, 0, tempCanvas.width, tempCanvas.height)

				// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
				const link = document.createElement('a')
				link.download = `3d-photo-${Date.now()}.png`
				link.href = tempCanvas.toDataURL('image/png')
				link.click()

				// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
				elements.status.textContent = '–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!'
				setTimeout(() => {
					elements.status.textContent = '–ì–æ—Ç–æ–≤–æ!'
				}, 2000)
			}

			// ===== –ê–ù–ò–ú–ê–¶–ò–Ø =====
			function animate() {
				requestAnimationFrame(animate)

				// –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
				if (model) {
					model.rotation.x += 0.005
					model.rotation.y += 0.01
				}

				renderer.render(scene, camera)
			}

			// ===== –†–ï–°–ê–ô–ó =====
			function onResize() {
				const width = elements.container.clientWidth
				const height = elements.container.clientHeight

				camera.aspect = width / height
				camera.updateProjectionMatrix()
				renderer.setSize(width, height)
			}

			// ===== –û–ß–ò–°–¢–ö–ê =====
			function cleanup() {
				if (videoStream) {
					videoStream.getTracks().forEach(track => track.stop())
				}
			}

			// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
			window.addEventListener('load', init)
			window.addEventListener('beforeunload', cleanup)
		</script>
	</body>
</html>

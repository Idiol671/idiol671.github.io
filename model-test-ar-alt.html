<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AR –ú–æ–¥–µ–ª—å –õ–æ—à–∞–¥–∏</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: Arial, sans-serif;
				background: #000;
				color: white;
				height: 100vh;
				overflow: hidden;
			}

			#ui {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				z-index: 1000;
				padding: 20px;
				text-align: center;
				pointer-events: none;
			}

			#status {
				font-size: 16px;
				color: #fff;
				text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
			}

			#container {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
			}

			#camera-video {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				object-fit: cover;
			}

			#renderCanvas {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				display: block;
			}

			.filter-overlay {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				mix-blend-mode: screen;
				pointer-events: none;
				opacity: 1;
				transition: opacity 0.3s;
			}

			#filter2 {
				opacity: 0;
			}

			#controls {
				position: fixed;
				bottom: 20px;
				left: 0;
				right: 0;
				display: flex;
				justify-content: center;
				gap: 10px;
				z-index: 1000;
			}

			.btn {
				background: rgba(0, 0, 0, 0.7);
				border: 2px solid white;
				color: white;
				padding: 12px 20px;
				border-radius: 25px;
				font-size: 16px;
				cursor: pointer;
				pointer-events: auto;
				transition: background 0.2s;
			}

			.btn:hover {
				background: rgba(0, 0, 0, 0.9);
			}

			#ar-btn {
				background: #007aff;
				border-color: #007aff;
				font-weight: bold;
			}

			.ar-instruction {
				position: fixed;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: rgba(0, 0, 0, 0.8);
				color: white;
				padding: 20px;
				border-radius: 10px;
				text-align: center;
				z-index: 1001;
				display: none;
				max-width: 90%;
				pointer-events: none;
			}

			.hidden {
				display: none !important;
			}
		</style>
	</head>
	<body>
		<div id="ui">
			<div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
		</div>

		<div id="container">
			<video id="camera-video" autoplay playsinline muted></video>
			<canvas id="renderCanvas"></canvas>
			<img
				class="filter-overlay"
				id="filter1"
				src="./assets/ice-1.png"
				alt="–§–∏–ª—å—Ç—Ä"
			/>
			<img
				class="filter-overlay"
				id="filter2"
				src="./assets/ice-4.png"
				alt="–§–∏–ª—å—Ç—Ä"
			/>
		</div>

		<div id="controls">
			<button class="btn" id="camera-btn">üì∑ –ö–∞–º–µ—Ä–∞</button>
			<button class="btn" id="screenshot-btn">üì∏ –°–Ω–∏–º–æ–∫</button>
			<button class="btn" id="ar-btn" style="display: none">üöÄ AR</button>
		</div>

		<div class="ar-instruction" id="ar-instruction">
			–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å<br />
			–∏ –∫–æ—Å–Ω–∏—Ç–µ—Å—å —ç–∫—Ä–∞–Ω–∞ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–æ–¥–µ–ª–∏
		</div>

		<!-- Three.js -->
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>

		<script>
			// –ü—Ä–æ—Å—Ç–∞—è –∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
			console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...')

			let scene, camera, renderer, model, mixer
			let videoStream = null
			let filterChanged = false
			let cameraFacingMode = 'environment'
			let arSession = null
			let isARMode = false
			let reticle = null

			// DOM —ç–ª–µ–º–µ–Ω—Ç—ã
			const status = document.getElementById('status')
			const video = document.getElementById('camera-video')
			const canvas = document.getElementById('renderCanvas')
			const filter1 = document.getElementById('filter1')
			const filter2 = document.getElementById('filter2')
			const cameraBtn = document.getElementById('camera-btn')
			const screenshotBtn = document.getElementById('screenshot-btn')
			const arBtn = document.getElementById('ar-btn')
			const arInstruction = document.getElementById('ar-instruction')

			// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É AR
			async function checkARSupport() {
				if (!('xr' in navigator)) {
					console.log('WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è')
					return false
				}

				try {
					const supported = await navigator.xr.isSessionSupported(
						'immersive-ar'
					)
					console.log('AR –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:', supported)
					return supported
				} catch (e) {
					console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ AR:', e)
					return false
				}
			}

			// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Three.js
			function initThreeJS() {
				try {
					scene = new THREE.Scene()

					camera = new THREE.PerspectiveCamera(
						60,
						window.innerWidth / window.innerHeight,
						0.1,
						100
					)
					camera.position.set(0, 1.5, 3)

					renderer = new THREE.WebGLRenderer({
						canvas: canvas,
						alpha: true,
						antialias: true,
					})
					renderer.setSize(window.innerWidth, window.innerHeight)
					renderer.setPixelRatio(window.devicePixelRatio)
					renderer.setClearColor(0x000000, 0)

					// –ü—Ä–æ—Å—Ç–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ
					const light = new THREE.AmbientLight(0xffffff, 1)
					scene.add(light)

					const dirLight = new THREE.DirectionalLight(0xffffff, 1)
					dirLight.position.set(5, 10, 5)
					scene.add(dirLight)

					console.log('Three.js –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
					return true
				} catch (e) {
					console.error('–û—à–∏–±–∫–∞ Three.js:', e)
					return false
				}
			}

			// –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
			function loadModel() {
				return new Promise(resolve => {
					const loader = new THREE.GLTFLoader()

					loader.load(
						'./assets/model/Horse_animation.gltf',
						gltf => {
							console.log('–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞')
							model = gltf.scene
							model.scale.set(0.3, 0.3, 0.3)
							model.position.set(0, 0, 0)
							scene.add(model)

							if (gltf.animations && gltf.animations.length) {
								mixer = new THREE.AnimationMixer(model)
								mixer.clipAction(gltf.animations[0]).play()
							}

							status.textContent = '–ì–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –¥–ª—è —Å–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–∞'
							resolve()
						},
						progress => {
							const percent = Math.round(
								(progress.loaded / progress.total) * 100
							)
							status.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${percent}%`
						},
						error => {
							console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:', error)
							createSimpleModel()
							resolve()
						}
					)
				})
			}

			// –ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏
			function createSimpleModel() {
				const geometry = new THREE.BoxGeometry(1, 1, 1)
				const material = new THREE.MeshBasicMaterial({ color: 0xff0000 })
				model = new THREE.Mesh(geometry, material)
				scene.add(model)
				status.textContent = '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å'
			}

			// –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
			async function startCamera() {
				try {
					if (videoStream) {
						videoStream.getTracks().forEach(track => track.stop())
					}

					status.textContent = '–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...'

					const constraints = {
						video: {
							facingMode: cameraFacingMode,
							width: { ideal: 1280 },
							height: { ideal: 720 },
						},
						audio: false,
					}

					videoStream = await navigator.mediaDevices.getUserMedia(constraints)
					video.srcObject = videoStream

					await new Promise(resolve => {
						video.onloadedmetadata = () => {
							video.play().then(resolve)
						}
					})

					video.style.display = 'block'
					console.log('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error)
					video.style.display = 'none'
					status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É'
				}
			}

			// –ó–∞–ø—É—Å–∫ AR —Ä–µ–∂–∏–º–∞
			async function startAR() {
				if (!('xr' in navigator)) {
					alert('AR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º')
					return
				}

				try {
					status.textContent = '–ó–∞–ø—É—Å–∫ AR...'

					// –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º AR —Å–µ—Å—Å–∏—é
					arSession = await navigator.xr.requestSession('immersive-ar', {
						requiredFeatures: ['hit-test'],
					})

					// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é
					await renderer.xr.setSession(arSession)

					// –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ AR —Ä–µ–∂–∏–º
					isARMode = true
					video.style.display = 'none'
					arInstruction.style.display = 'block'

					// –°–æ–∑–¥–∞–µ–º —Ä–µ—Ç–∏–∫—É–ª –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–µ–π
					createReticle()

					// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º hit test
					const session = renderer.xr.getSession()
					const refSpace = await session.requestReferenceSpace('viewer')
					const hitTestSource = await session.requestHitTestSource({
						space: refSpace,
					})

					// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–æ–¥–µ–ª–∏
					session.addEventListener('select', () => {
						placeModelInAR(hitTestSource, refSpace)
					})

					// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
					session.addEventListener('end', () => {
						endAR()
					})

					status.textContent = 'AR –∞–∫—Ç–∏–≤–µ–Ω. –ö–æ—Å–Ω–∏—Ç–µ—Å—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏'
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ AR:', error)
					status.textContent = '–û—à–∏–±–∫–∞ AR: ' + error.message
					alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å AR. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.')
				}
			}

			// –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Ç–∏–∫—É–ª–∞
			function createReticle() {
				if (reticle) {
					scene.remove(reticle)
				}

				const geometry = new THREE.RingGeometry(0.1, 0.15, 32)
				const material = new THREE.MeshBasicMaterial({
					color: 0xffffff,
					transparent: true,
					opacity: 0.8,
				})

				reticle = new THREE.Mesh(geometry, material)
				reticle.matrixAutoUpdate = false
				reticle.visible = false
				scene.add(reticle)
			}

			// –†–∞–∑–º–µ—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ AR
			function placeModelInAR(hitTestSource, refSpace) {
				if (!model) return

				const frame = renderer.xr.getFrame()
				const hitTestResults = frame.getHitTestResults(hitTestSource)

				if (hitTestResults.length > 0) {
					const hit = hitTestResults[0]
					const pose = hit.getPose(refSpace)

					if (pose) {
						// –†–∞–∑–º–µ—â–∞–µ–º –º–æ–¥–µ–ª—å
						model.position.set(
							pose.transform.position.x,
							pose.transform.position.y,
							pose.transform.position.z
						)

						model.visible = true
						arInstruction.style.display = 'none'
						reticle.visible = false

						console.log('–ú–æ–¥–µ–ª—å —Ä–∞–∑–º–µ—â–µ–Ω–∞')
					}
				}
			}

			// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ AR —Ä–µ–∂–∏–º–∞
			function endAR() {
				isARMode = false
				arSession = null

				video.style.display = 'block'
				arInstruction.style.display = 'none'

				if (reticle) {
					reticle.visible = false
				}

				if (model) {
					model.visible = true
					model.position.set(0, 0, 0)
				}

				// –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
				setTimeout(() => {
					startCamera()
				}, 100)

				status.textContent = 'AR –∑–∞–≤–µ—Ä—à–µ–Ω'
			}

			// –°–∫—Ä–∏–Ω—à–æ—Ç
			function takeScreenshot() {
				// –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
				const buttons = document.querySelectorAll('.btn')
				buttons.forEach(btn => (btn.style.visibility = 'hidden'))

				setTimeout(() => {
					let dataURL

					if (isARMode) {
						// –í AR —Ä–µ–∂–∏–º–µ
						dataURL = renderer.domElement.toDataURL('image/png')
					} else {
						// –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
						const tempCanvas = document.createElement('canvas')
						tempCanvas.width = canvas.width
						tempCanvas.height = canvas.height
						const ctx = tempCanvas.getContext('2d')

						// –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω
						ctx.fillStyle = '#000'
						ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height)

						// –í–∏–¥–µ–æ
						ctx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height)

						// 3D –º–æ–¥–µ–ª—å
						ctx.drawImage(canvas, 0, 0)

						// –§–∏–ª—å—Ç—Ä
						const activeFilter =
							filter1.style.opacity === '1' ? filter1 : filter2
						ctx.globalCompositeOperation = 'screen'
						ctx.drawImage(
							activeFilter,
							0,
							0,
							tempCanvas.width,
							tempCanvas.height
						)

						dataURL = tempCanvas.toDataURL('image/png')
					}

					// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
					const link = document.createElement('a')
					link.download = `model-${Date.now()}.png`
					link.href = dataURL
					link.click()

					status.textContent = '–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!'
					setTimeout(() => {
						status.textContent = isARMode ? 'AR –∞–∫—Ç–∏–≤–µ–Ω' : '–ì–æ—Ç–æ–≤–æ'
					}, 2000)

					// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏
					buttons.forEach(btn => (btn.style.visibility = 'visible'))
				}, 100)
			}

			// –ê–Ω–∏–º–∞—Ü–∏—è
			function animate() {
				requestAnimationFrame(animate)

				// –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –º–æ–¥–µ–ª–∏
				if (mixer && !isARMode) {
					mixer.update(0.016)
				}

				// –í—Ä–∞—â–µ–Ω–∏–µ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
				if (model && !isARMode) {
					model.rotation.y += 0.005
				}

				// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ—Ç–∏–∫—É–ª–∞ –≤ AR
				if (isARMode && renderer.xr.isPresenting && reticle) {
					const frame = renderer.xr.getFrame()
					const refSpace = renderer.xr.getReferenceSpace()

					// –ü–æ–ª—É—á–∞–µ–º hit test —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
					const hitTestResults = frame.getHitTestResults(
						frame.session.hitTestSources?.[0]
					)

					if (hitTestResults && hitTestResults.length > 0) {
						const hit = hitTestResults[0]
						const pose = hit.getPose(refSpace)

						if (pose) {
							reticle.visible = true
							reticle.matrix.fromArray(pose.transform.matrix)
						}
					} else {
						reticle.visible = false
					}
				}

				renderer.render(scene, camera)
			}

			// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π
			function setupEvents() {
				// –°–º–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞
				canvas.addEventListener('click', () => {
					if (!filterChanged && !isARMode) {
						filterChanged = true
						filter1.style.opacity = '0'
						filter2.style.opacity = '1'
					}
				})

				// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
				cameraBtn.addEventListener('click', () => {
					cameraFacingMode =
						cameraFacingMode === 'environment' ? 'user' : 'environment'
					startCamera()
				})

				// –°–∫—Ä–∏–Ω—à–æ—Ç
				screenshotBtn.addEventListener('click', takeScreenshot)

				// AR —Ä–µ–∂–∏–º
				arBtn.addEventListener('click', startAR)

				// –†–µ—Å–∞–π–∑ –æ–∫–Ω–∞
				window.addEventListener('resize', () => {
					camera.aspect = window.innerWidth / window.innerHeight
					camera.updateProjectionMatrix()
					renderer.setSize(window.innerWidth, window.innerHeight)
				})
			}

			// –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
			async function init() {
				try {
					console.log('–ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...')

					// 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É AR
					const arSupported = await checkARSupport()
					if (arSupported) {
						arBtn.style.display = 'block'
					}

					// 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Three.js
					if (!initThreeJS()) {
						throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Three.js')
					}

					// 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
					await startCamera()

					// 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å
					await loadModel()

					// 5. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
					setupEvents()

					// 6. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
					animate()

					console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ')
				} catch (error) {
					console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error)
					status.textContent = '–û—à–∏–±–∫–∞: ' + error.message
				}
			}

			// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
			window.addEventListener('beforeunload', () => {
				if (videoStream) {
					videoStream.getTracks().forEach(track => track.stop())
				}
				if (arSession) {
					arSession.end()
				}
			})

			// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
			window.addEventListener('load', init)
		</script>
	</body>
</html>

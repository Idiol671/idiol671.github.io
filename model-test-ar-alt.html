<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, viewport-fit=cover"
		/>
		<title>AR –ú–æ–¥–µ–ª—å –õ–æ—à–∞–¥–∏</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
				-webkit-tap-highlight-color: transparent;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
				background: #000;
				color: white;
				width: 100vw;
				height: 100vh;
				overflow: hidden;
				position: fixed;
			}

			.header {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				padding: 20px;
				text-align: center;
				background: rgba(0, 0, 0, 0.7);
				backdrop-filter: blur(10px);
				z-index: 1000;
			}

			h1 {
				font-size: 22px;
				margin: 0;
			}

			#status {
				font-size: 14px;
				color: #aaa;
				margin-top: 5px;
			}

			#container {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
			}

			#camera-video {
				position: absolute;
				width: 100%;
				height: 100%;
				object-fit: cover;
				transform: scaleX(-1);
				z-index: 1;
				display: block;
			}

			#renderCanvas {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 2;
				display: block;
			}

			.filter-overlay {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 3;
				mix-blend-mode: screen;
				pointer-events: none;
				opacity: 1;
				transition: opacity 0.5s;
				display: block;
			}

			#filter2 {
				opacity: 0;
			}

			.controls {
				position: fixed;
				bottom: 30px;
				left: 0;
				right: 0;
				display: flex;
				justify-content: center;
				gap: 15px;
				z-index: 1000;
			}

			button {
				background: rgba(0, 0, 0, 0.8);
				border: 2px solid rgba(255, 255, 255, 0.3);
				color: white;
				padding: 12px 25px;
				border-radius: 50px;
				font-size: 16px;
				cursor: pointer;
				backdrop-filter: blur(10px);
				transition: all 0.2s;
			}

			button:hover,
			button:active {
				background: rgba(255, 255, 255, 0.1);
				border-color: white;
			}

			#ar-button {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				border: none;
				font-weight: 600;
			}

			.ar-overlay {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: 1001;
				display: none;
			}

			.ar-instruction {
				position: absolute;
				top: 100px;
				left: 20px;
				right: 20px;
				background: rgba(0, 0, 0, 0.8);
				color: white;
				padding: 15px;
				border-radius: 15px;
				text-align: center;
				font-size: 16px;
				backdrop-filter: blur(10px);
			}

			.ar-controls {
				position: absolute;
				bottom: 30px;
				left: 0;
				right: 0;
				display: flex;
				justify-content: center;
				gap: 20px;
			}

			.ar-btn {
				width: 60px;
				height: 60px;
				border-radius: 50%;
				background: rgba(0, 0, 0, 0.7);
				border: 2px solid white;
				color: white;
				font-size: 24px;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
			}

			.loading {
				position: fixed;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				font-size: 18px;
				z-index: 1000;
			}

			.error {
				position: fixed;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: rgba(255, 50, 50, 0.9);
				color: white;
				padding: 20px 30px;
				border-radius: 15px;
				text-align: center;
				max-width: 80%;
				display: none;
				z-index: 1000;
			}

			.hidden {
				display: none !important;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1>AR –ú–æ–¥–µ–ª—å –õ–æ—à–∞–¥–∏</h1>
			<div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
		</div>

		<div id="container">
			<video id="camera-video" autoplay playsinline muted></video>
			<canvas id="renderCanvas"></canvas>
			<img
				class="filter-overlay"
				id="filter1"
				src="./assets/ice-1.png"
				alt="–§–∏–ª—å—Ç—Ä"
			/>
			<img
				class="filter-overlay"
				id="filter2"
				src="./assets/ice-4.png"
				alt="–§–∏–ª—å—Ç—Ä"
			/>
		</div>

		<div class="ar-overlay" id="ar-overlay">
			<div class="ar-instruction" id="ar-instruction">
				–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å<br />
				–∏ –∫–æ—Å–Ω–∏—Ç–µ—Å—å —ç–∫—Ä–∞–Ω–∞, —á—Ç–æ–±—ã —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –º–æ–¥–µ–ª—å
			</div>
			<div class="ar-controls" id="ar-controls">
				<div class="ar-btn" id="rotate-btn">‚Üª</div>
				<div class="ar-btn" id="scale-btn">‚äï</div>
				<div class="ar-btn" id="exit-btn">‚úï</div>
			</div>
		</div>

		<div class="controls">
			<button id="switch-camera">üì∑ –ö–∞–º–µ—Ä–∞</button>
			<button id="screenshot">üì∏ –°–Ω–∏–º–æ–∫</button>
			<button id="ar-button" class="hidden">üöÄ AR</button>
		</div>

		<div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
		<div class="error" id="error"></div>

		<!-- Three.js —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π WebXR -->
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/webxr/ARButton.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/webxr/XRControllerModelFactory.min.js"></script>

		<script>
			// ========== –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
			const DEBUG = true

			let scene, camera, renderer, model, mixer
			let videoStream = null
			let isFilterChanged = false
			let isARMode = false
			let arSession = null
			let hitTestSource = null
			let modelPlaced = false
			let currentCamera = 'environment'
			let animationId = null
			let reticle = null

			// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
			const elements = {
				container: null,
				video: null,
				canvas: null,
				filter1: null,
				filter2: null,
				switchBtn: null,
				screenshotBtn: null,
				arButton: null,
				status: null,
				loading: null,
				error: null,
				arOverlay: null,
				arInstruction: null,
				arControls: null,
				rotateBtn: null,
				scaleBtn: null,
				exitBtn: null,
			}

			// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø DOM ==========
			function initDOM() {
				console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DOM...')

				const elementIds = [
					'container',
					'camera-video',
					'renderCanvas',
					'filter1',
					'filter2',
					'switch-camera',
					'screenshot',
					'ar-button',
					'status',
					'loading',
					'error',
					'ar-overlay',
					'ar-instruction',
					'ar-controls',
					'rotate-btn',
					'scale-btn',
					'exit-btn',
				]

				elementIds.forEach(id => {
					const element = document.getElementById(id)
					if (!element) {
						console.error(`–≠–ª–µ–º–µ–Ω—Ç #${id} –Ω–µ –Ω–∞–π–¥–µ–Ω!`)
					}
					elements[id.replace('-', '')] = element
				})

				// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
				if (!elements.container || !elements.canvas) {
					showError('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.')
					throw new Error('DOM elements not found')
				}
			}

			// ========== –û–°–ù–û–í–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
			async function init() {
				try {
					log('=== –ù–ê–ß–ê–õ–û –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ===')

					// 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç—ã
					initDOM()

					// 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Three.js
					initThreeJS()

					// 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
					await startCamera()

					// 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å –ª–æ—à–∞–¥–∏
					await loadModel()

					// 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É AR
					await checkARSupport()

					// 6. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
					setupEvents()

					// 7. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
					startAnimation()

					elements.loading.classList.add('hidden')
					elements.status.textContent =
						'–ì–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –¥–ª—è —Å–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–∞.'

					log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê ===')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error)
					showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message)
				}
			}

			// ========== THREE.JS –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
			function initThreeJS() {
				log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Three.js...')

				// –°—Ü–µ–Ω–∞
				scene = new THREE.Scene()

				// –ö–∞–º–µ—Ä–∞ (–º–∞–ª–µ–Ω—å–∫–∞—è –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–π –º–æ–¥–µ–ª–∏)
				const aspect = window.innerWidth / window.innerHeight
				camera = new THREE.PerspectiveCamera(45, aspect, 0.01, 100)
				camera.position.set(0, 0.3, 1.5)

				// –†–µ–Ω–¥–µ—Ä–µ—Ä
				renderer = new THREE.WebGLRenderer({
					canvas: elements.canvas,
					alpha: true,
					antialias: true,
					preserveDrawingBuffer: true,
				})
				renderer.setSize(window.innerWidth, window.innerHeight)
				renderer.setPixelRatio(window.devicePixelRatio)
				renderer.setClearColor(0x000000, 0)
				renderer.shadowMap.enabled = true
				renderer.shadowMap.type = THREE.PCFSoftShadowMap

				// –í–∫–ª—é—á–∞–µ–º WebXR
				renderer.xr.enabled = true

				// –û—Å–≤–µ—â–µ–Ω–∏–µ
				const ambientLight = new THREE.AmbientLight(0xffffff, 1.0)
				scene.add(ambientLight)

				const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2)
				directionalLight.position.set(2, 4, 5)
				directionalLight.castShadow = true
				scene.add(directionalLight)

				log('Three.js –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
			}

			// ========== –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò –õ–û–®–ê–î–ò ==========
			async function loadModel() {
				return new Promise(resolve => {
					log('–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –ª–æ—à–∞–¥–∏...')
					elements.status.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...'

					const loader = new THREE.GLTFLoader()

					loader.load(
						'./assets/model/Horse_animation.gltf',
						gltf => {
							log('–ú–æ–¥–µ–ª—å –ª–æ—à–∞–¥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞')
							model = gltf.scene

							// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏ (–º–∞–ª–µ–Ω—å–∫–∞—è)
							model.scale.set(0.15, 0.15, 0.15)
							model.position.set(0, -0.5, 0)
							model.rotation.y = Math.PI / 6

							// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ —Ç–µ–Ω–µ–π
							model.traverse(child => {
								if (child.isMesh) {
									child.castShadow = true
									child.receiveShadow = true
									if (child.material) {
										child.material.metalness = 0.1
										child.material.roughness = 0.8
									}
								}
							})

							scene.add(model)

							// –ê–Ω–∏–º–∞—Ü–∏—è
							if (gltf.animations && gltf.animations.length > 0) {
								log(`–ù–∞–π–¥–µ–Ω–æ –∞–Ω–∏–º–∞—Ü–∏–π: ${gltf.animations.length}`)
								mixer = new THREE.AnimationMixer(model)

								// –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∞–Ω–∏–º–∞—Ü–∏—é
								const action = mixer.clipAction(gltf.animations[0])
								action.play()
								mixer.timeScale = 0.7
							}

							elements.status.textContent = '–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞'
							resolve()
						},
						progress => {
							const percent = Math.round(
								(progress.loaded / progress.total) * 100
							)
							elements.status.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${percent}%`
						},
						error => {
							console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:', error)
							showError(
								'–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å –ª–æ—à–∞–¥–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª ./assets/model/Horse_animation.gltf'
							)
							resolve()
						}
					)
				})
			}

			// ========== –ö–ê–ú–ï–†–ê –£–°–¢–†–û–ô–°–¢–í–ê ==========
			async function startCamera() {
				try {
					log('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...')
					elements.status.textContent = '–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...'

					// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫
					if (videoStream) {
						videoStream.getTracks().forEach(track => track.stop())
					}

					const constraints = {
						video: {
							facingMode: currentCamera,
							width: { ideal: 1920 },
							height: { ideal: 1080 },
						},
						audio: false,
					}

					videoStream = await navigator.mediaDevices.getUserMedia(constraints)
					elements.video.srcObject = videoStream

					// –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ
					await new Promise((resolve, reject) => {
						elements.video.onloadedmetadata = () => {
							elements.video.play().then(resolve).catch(reject)
						}
						elements.video.onerror = reject

						// –¢–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º
						setTimeout(() => {
							if (elements.video.readyState < 2) {
								reject(new Error('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ'))
							}
						}, 5000)
					})

					log('–ö–∞–º–µ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∑–∞–ø—É—â–µ–Ω–∞')
					elements.status.textContent = '–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞'
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error)
					elements.video.style.display = 'none'
					elements.container.style.background =
						'linear-gradient(45deg, #000, #222)'
					throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ')
				}
			}

			// ========== –ü–†–û–í–ï–†–ö–ê –ò –ù–ê–°–¢–†–û–ô–ö–ê AR ==========
			async function checkARSupport() {
				if (!('xr' in navigator)) {
					log('WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º')
					return
				}

				try {
					log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ AR...')

					const supported = await navigator.xr.isSessionSupported(
						'immersive-ar'
					)

					if (supported) {
						log('AR –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è!')

						// –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É AR —á–µ—Ä–µ–∑ Three.js
						const arButton = THREE.ARButton.createButton(renderer, {
							requiredFeatures: ['hit-test'],
							optionalFeatures: ['dom-overlay'],
							domOverlay: { root: document.body },
						})

						arButton.id = 'ar-button'
						arButton.textContent = 'üöÄ AR'
						arButton.style.cssText = `
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border: none;
                        color: white;
                        padding: 12px 25px;
                        border-radius: 50px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                    `

						// –ó–∞–º–µ–Ω—è–µ–º –Ω–∞—à—É –∫–Ω–æ–ø–∫—É
						elements.arButton.replaceWith(arButton)
						elements.arButton = arButton

						// –°–æ–±—ã—Ç–∏—è AR
						setupAREvents()
					} else {
						log('AR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ')
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ AR:', error)
					log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ AR')
				}
			}

			function setupAREvents() {
				elements.arButton.addEventListener('click', () => {
					if (isARMode) {
						exitAR()
					} else {
						startAR()
					}
				})
			}

			// ========== AR –†–ï–ñ–ò–ú ==========
			async function startAR() {
				try {
					log('–ó–∞–ø—É—Å–∫ AR —Å–µ—Å—Å–∏–∏...')
					elements.status.textContent = '–ó–∞–ø—É—Å–∫ AR...'

					// –°–æ–∑–¥–∞–µ–º —Ä–µ—Ç–∏–∫—É–ª –¥–ª—è AR
					createReticle()

					// –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ AR —Ä–µ–∂–∏–º
					enterARMode()

					// AR —É–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É Three.js
					// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±—É–¥–µ—Ç –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö —Å–µ—Å—Å–∏–∏
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ AR:', error)
					showError('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ AR: ' + error.message)
					exitAR()
				}
			}

			function createReticle() {
				// –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ä–µ—Ç–∏–∫—É–ª –µ—Å–ª–∏ –µ—Å—Ç—å
				if (reticle) {
					scene.remove(reticle)
				}

				const geometry = new THREE.RingGeometry(0.05, 0.1, 32)
				const material = new THREE.MeshBasicMaterial({
					color: 0xffffff,
					transparent: true,
					opacity: 0.8,
				})

				reticle = new THREE.Mesh(geometry, material)
				reticle.matrixAutoUpdate = false
				reticle.visible = false
				scene.add(reticle)
			}

			function enterARMode() {
				isARMode = true
				modelPlaced = false

				// –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
				elements.video.style.display = 'none'
				elements.filter1.style.display = 'none'
				elements.filter2.style.display = 'none'

				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º AR –æ–≤–µ—Ä–ª–µ–π
				elements.arOverlay.style.display = 'block'

				// –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–µ–ª—å –¥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
				if (model) {
					model.visible = false
					model.scale.set(0.05, 0.05, 0.05) // –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∞—è –¥–ª—è AR
				}

				elements.status.textContent =
					'AR —Ä–µ–∂–∏–º: –Ω–∞–π–¥–∏—Ç–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –∏ –∫–æ—Å–Ω–∏—Ç–µ—Å—å —ç–∫—Ä–∞–Ω–∞'

				log('–í—Ö–æ–¥ –≤ AR —Ä–µ–∂–∏–º')
			}

			function exitAR() {
				isARMode = false

				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
				elements.video.style.display = 'block'
				elements.filter1.style.display = 'block'
				elements.filter2.style.display = 'block'

				// –°–∫—Ä—ã–≤–∞–µ–º AR –æ–≤–µ—Ä–ª–µ–π
				elements.arOverlay.style.display = 'none'

				// –í—ã—Ö–æ–¥–∏–º –∏–∑ XR —Å–µ—Å—Å–∏–∏ –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
				if (renderer.xr.getSession()) {
					renderer.xr.getSession().end()
				}

				// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–æ–¥–µ–ª—å
				if (model) {
					model.visible = true
					model.scale.set(0.15, 0.15, 0.15)
					model.position.set(0, -0.5, 0)
				}

				// –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
				setTimeout(() => {
					startCamera()
				}, 100)

				elements.status.textContent = 'AR —Ä–µ–∂–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω'

				log('–í—ã—Ö–æ–¥ –∏–∑ AR —Ä–µ–∂–∏–º–∞')
			}

			// ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò AR ==========
			function onSessionStart() {
				log('AR —Å–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞')

				// –°–æ–∑–¥–∞–µ–º hit test –∏—Å—Ç–æ—á–Ω–∏–∫
				const session = renderer.xr.getSession()
				const referenceSpace = renderer.xr.getReferenceSpace()

				session
					.requestHitTestSource({ space: referenceSpace })
					.then(source => {
						hitTestSource = source
					})
					.catch(console.error)

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ (–∫–ª–∏–∫/—Ç–∞–ø)
				session.addEventListener('select', onSelect)

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
				session.addEventListener('end', onSessionEnd)
			}

			function onSessionEnd() {
				log('AR —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞')
				hitTestSource = null
				exitAR()
			}

			function onSelect(event) {
				if (!modelPlaced && model && hitTestSource) {
					const frame = event.frame
					const hitTestResults = frame.getHitTestResults(hitTestSource)

					if (hitTestResults.length > 0) {
						const hit = hitTestResults[0]
						const pose = hit.getPose(renderer.xr.getReferenceSpace())

						if (pose) {
							// –†–∞–∑–º–µ—â–∞–µ–º –º–æ–¥–µ–ª—å
							model.position.set(
								pose.transform.position.x,
								pose.transform.position.y,
								pose.transform.position.z
							)

							model.visible = true
							modelPlaced = true

							// –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
							elements.arInstruction.style.display = 'none'

							log('–ú–æ–¥–µ–ª—å —Ä–∞–∑–º–µ—â–µ–Ω–∞ –≤ AR')
						}
					}
				}
			}

			function updateAR(frame) {
				if (!isARMode || !hitTestSource || !reticle) return

				const referenceSpace = renderer.xr.getReferenceSpace()
				const hitTestResults = frame.getHitTestResults(hitTestSource)

				// –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Ç–∏–∫—É–ª
				if (hitTestResults.length > 0 && !modelPlaced) {
					const hit = hitTestResults[0]
					const pose = hit.getPose(referenceSpace)

					reticle.visible = true
					reticle.matrix.fromArray(pose.transform.matrix)
				} else {
					reticle.visible = false
				}
			}

			// ========== –°–û–ë–´–¢–ò–Ø –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï ==========
			function setupEvents() {
				log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π...')

				// –°–º–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞
				elements.container.addEventListener('click', e => {
					if (!isFilterChanged && !isARMode && e.target === elements.canvas) {
						isFilterChanged = true
						elements.filter1.style.opacity = '0'
						elements.filter2.style.opacity = '1'
						elements.container.style.cursor = 'default'
						log('–§–∏–ª—å—Ç—Ä –∏–∑–º–µ–Ω–µ–Ω')
					}
				})

				// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
				elements.switchBtn.addEventListener('click', () => {
					currentCamera =
						currentCamera === 'environment' ? 'user' : 'environment'
					startCamera()
				})

				// –°–∫—Ä–∏–Ω—à–æ—Ç
				elements.screenshotBtn.addEventListener('click', takeScreenshot)

				// AR –∫–æ–Ω—Ç—Ä–æ–ª—ã
				elements.rotateBtn.addEventListener('click', () => {
					if (model && modelPlaced) {
						model.rotation.y += Math.PI / 4
					}
				})

				elements.scaleBtn.addEventListener('click', () => {
					if (model && modelPlaced) {
						const scale =
							model.scale.x === 0.05 ? 0.1 : model.scale.x === 0.1 ? 0.15 : 0.05
						model.scale.set(scale, scale, scale)
					}
				})

				elements.exitBtn.addEventListener('click', exitAR)

				// –†–µ—Å–∞–π–∑ –æ–∫–Ω–∞
				window.addEventListener('resize', onResize)

				// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
				window.addEventListener('error', e => {
					console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', e.error)
					showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + e.message)
				})

				// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∑—ã–≤–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
				if (videoStream) {
					videoStream.getVideoTracks()[0].addEventListener('ended', () => {
						showError('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –æ—Ç–æ–∑–≤–∞–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.')
					})
				}

				log('–°–æ–±—ã—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã')
			}

			// ========== –°–ö–†–ò–ù–®–û–¢ ==========
			function takeScreenshot() {
				if (isARMode) {
					// –í AR —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º WebGL canvas
					const dataUrl = elements.canvas.toDataURL('image/png')
					downloadImage(dataUrl, 'ar-screenshot')
				} else {
					// –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –∫–æ–º–±–∏–Ω–∏—Ä—É–µ–º –≤–∏–¥–µ–æ –∏ 3D
					const tempCanvas = document.createElement('canvas')
					tempCanvas.width = elements.canvas.width
					tempCanvas.height = elements.canvas.height
					const ctx = tempCanvas.getContext('2d')

					// –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω
					ctx.fillStyle = '#000'
					ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height)

					// –í–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã (–∑–µ—Ä–∫–∞–ª—å–Ω–æ–µ)
					if (elements.video.videoWidth > 0) {
						ctx.save()
						ctx.scale(-1, 1)
						ctx.drawImage(
							elements.video,
							-tempCanvas.width,
							0,
							tempCanvas.width,
							tempCanvas.height
						)
						ctx.restore()
					}

					// 3D –º–æ–¥–µ–ª—å
					ctx.drawImage(elements.canvas, 0, 0)

					// –ê–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
					const activeFilter =
						elements.filter1.style.opacity === '1'
							? elements.filter1
							: elements.filter2
					ctx.globalCompositeOperation = 'screen'
					ctx.drawImage(activeFilter, 0, 0, tempCanvas.width, tempCanvas.height)

					const dataUrl = tempCanvas.toDataURL('image/png')
					downloadImage(dataUrl, '3d-model')
				}

				elements.status.textContent = '–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!'
				setTimeout(() => {
					elements.status.textContent = isARMode ? 'AR —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω' : '–ì–æ—Ç–æ–≤–æ'
				}, 2000)
			}

			function downloadImage(dataUrl, filename) {
				const link = document.createElement('a')
				link.download = `${filename}-${Date.now()}.png`
				link.href = dataUrl
				document.body.appendChild(link)
				link.click()
				document.body.removeChild(link)
			}

			// ========== –ê–ù–ò–ú–ê–¶–ò–Ø ==========
			function startAnimation() {
				function animate(time) {
					animationId = requestAnimationFrame(animate)

					// –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –º–æ–¥–µ–ª–∏
					if (mixer) {
						const delta = time ? (time - (mixer._lastTime || 0)) * 0.001 : 0.016
						mixer._lastTime = time
						mixer.update(delta)
					}

					// –í—Ä–∞—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
					if (model && !isARMode) {
						model.rotation.y += 0.005
					}

					// –í AR —Ä–µ–∂–∏–º–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
					if (isARMode && renderer.xr.isPresenting) {
						const frame = renderer.xr.getFrame()
						updateAR(frame)
					}

					// –†–µ–Ω–¥–µ—Ä
					if (renderer && scene && camera) {
						renderer.render(scene, camera)
					}
				}

				animate()
			}

			// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
			function onResize() {
				if (!camera || !renderer) return

				camera.aspect = window.innerWidth / window.innerHeight
				camera.updateProjectionMatrix()
				renderer.setSize(window.innerWidth, window.innerHeight)
			}

			function showError(message) {
				console.error('–û—à–∏–±–∫–∞:', message)
				elements.error.textContent = message
				elements.error.style.display = 'block'
				elements.status.textContent = '–û—à–∏–±–∫–∞'

				// –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
				setTimeout(() => {
					elements.error.style.display = 'none'
				}, 5000)
			}

			function log(message) {
				if (DEBUG) {
					console.log(`[AR App] ${message}`)
				}
			}

			// ========== –û–ß–ò–°–¢–ö–ê ==========
			function cleanup() {
				log('–û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤...')

				if (animationId) {
					cancelAnimationFrame(animationId)
				}

				if (videoStream) {
					videoStream.getTracks().forEach(track => track.stop())
				}

				if (arSession) {
					arSession.end()
				}
			}

			// ========== –ó–ê–ü–£–°–ö ==========
			// –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', init)
			} else {
				init()
			}

			// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
			window.addEventListener('beforeunload', cleanup)
			window.addEventListener('pagehide', cleanup)

			// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è Three.js XR
			window.addEventListener('xrstart', onSessionStart)

			log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏')
		</script>
	</body>
</html>

<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AR –ú–æ–¥–µ–ª—å —Å –§–∏–ª—å—Ç—Ä–æ–º</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: sans-serif;
				background: #000;
				color: white;
				height: 100vh;
				display: flex;
				flex-direction: column;
				align-items: center;
				padding: 20px;
				overflow: hidden;
			}

			h1 {
				margin: 10px 0;
				text-align: center;
				font-size: 22px;
			}

			#container {
				position: relative;
				width: 100%;
				max-width: 400px;
				height: 60vh;
				border-radius: 20px;
				overflow: hidden;
				background: #111;
				margin-top: 10px;
			}

			#camera-video {
				position: absolute;
				width: 100%;
				height: 100%;
				object-fit: cover;
				transform: scaleX(-1); /* –ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ */
				z-index: 1;
				display: block;
			}

			#renderCanvas {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 2;
				display: block;
			}

			.filter {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: 3;
				mix-blend-mode: screen;
				pointer-events: none;
				opacity: 1;
				transition: opacity 0.5s ease;
				display: block;
			}

			#filter2 {
				opacity: 0;
			}

			.controls {
				margin-top: 20px;
				display: flex;
				gap: 10px;
			}

			button {
				background: rgba(255, 255, 255, 0.1);
				border: 1px solid rgba(255, 255, 255, 0.3);
				color: white;
				padding: 10px 20px;
				border-radius: 25px;
				cursor: pointer;
				font-size: 14px;
			}

			#ar-button {
				background: #007aff;
				border-color: #007aff;
				font-weight: bold;
			}

			#status {
				margin-top: 10px;
				text-align: center;
				color: #aaa;
				font-size: 14px;
				min-height: 20px;
			}

			.ar-instruction {
				position: absolute;
				top: 20px;
				left: 20px;
				right: 20px;
				background: rgba(0, 0, 0, 0.8);
				color: white;
				padding: 15px;
				border-radius: 10px;
				text-align: center;
				z-index: 1000;
				display: none;
			}

			.hidden {
				display: none;
			}

			.loading {
				position: fixed;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				font-size: 18px;
				z-index: 1000;
			}
		</style>
	</head>
	<body>
		<div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

		<h1>AR –ú–æ–¥–µ–ª—å —Å –§–∏–ª—å—Ç—Ä–æ–º</h1>

		<div id="container">
			<video id="camera-video" autoplay playsinline muted></video>
			<canvas id="renderCanvas"></canvas>
			<img
				class="filter"
				id="filter1"
				src="./assets/ice-1.png"
				alt="–§–∏–ª—å—Ç—Ä 1"
			/>
			<img
				class="filter"
				id="filter2"
				src="./assets/ice-4.png"
				alt="–§–∏–ª—å—Ç—Ä 2"
			/>

			<div class="ar-instruction" id="ar-instruction">
				AR —Ä–µ–∂–∏–º: –Ω–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å
			</div>
		</div>

		<div class="controls">
			<button id="switch-camera">üì∑ –ö–∞–º–µ—Ä–∞</button>
			<button id="screenshot">üì∏ –°–Ω–∏–º–æ–∫</button>
			<button id="ar-button" class="hidden">üöÄ AR</button>
		</div>

		<div id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>

		<!-- –¢–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>

		<script>
			// ===== –ü–†–û–í–ï–†–ï–ù–ù–´–ô –ò –°–¢–ê–ë–ò–õ–¨–ù–´–ô –ö–û–î =====
			let scene, camera, renderer, model
			let videoStream = null
			let isFilterChanged = false
			let isARMode = false
			let currentCamera = 'environment'
			let arSupported = false

			// –î–æ–∂–∏–¥–∞–µ–º—Å—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
			document.addEventListener('DOMContentLoaded', function () {
				// –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
				window.elements = {
					container: document.getElementById('container'),
					video: document.getElementById('camera-video'),
					canvas: document.getElementById('renderCanvas'),
					filter1: document.getElementById('filter1'),
					filter2: document.getElementById('filter2'),
					switchBtn: document.getElementById('switch-camera'),
					screenshotBtn: document.getElementById('screenshot'),
					arButton: document.getElementById('ar-button'),
					status: document.getElementById('status'),
					arInstruction: document.getElementById('ar-instruction'),
					loading: document.getElementById('loading'),
				}

				// –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
				for (let key in window.elements) {
					if (!window.elements[key]) {
						console.error('–ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç:', key)
					}
				}

				// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
				init()
			})

			// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
			async function init() {
				try {
					console.log('=== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===')

					// 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É AR
					await checkARSupport()

					// 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Three.js
					initThreeJS()

					// 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
					await startCamera()

					// 4. –°–æ–∑–¥–∞–µ–º –º–æ–¥–µ–ª—å (–º–∞–ª–µ–Ω—å–∫—É—é)
					createModel()

					// 5. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
					setupEvents()

					// 6. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
					animate()

					// –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
					window.elements.loading.style.display = 'none'
					window.elements.status.textContent =
						'–ì–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –¥–ª—è —Å–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–∞.'

					console.log('=== –ü–†–ò–õ–û–ñ–ï–ù–ò–ï –ó–ê–ü–£–©–ï–ù–û ===')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error)
					window.elements.status.textContent = '–û—à–∏–±–∫–∞: ' + error.message
					window.elements.loading.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'
				}
			}

			// ===== –ü–†–û–í–ï–†–ö–ê AR =====
			async function checkARSupport() {
				// –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
				const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
				const hasCamera = !!navigator.mediaDevices?.getUserMedia

				arSupported = isMobile && hasCamera

				if (arSupported) {
					window.elements.arButton.classList.remove('hidden')
					console.log('AR –∫–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞–Ω–∞ (–º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)')
				}
			}

			// ===== THREE.JS =====
			function initThreeJS() {
				// –£–±–µ–¥–∏–º—Å—è —á—Ç–æ container —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
				if (!window.elements.container) {
					throw new Error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω')
				}

				const width = window.elements.container.clientWidth
				const height = window.elements.container.clientHeight

				console.log('–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:', width, 'x', height)

				// 1. –°—Ü–µ–Ω–∞
				scene = new THREE.Scene()

				// 2. –ö–∞–º–µ—Ä–∞ Three.js - –º–∞–ª–µ–Ω—å–∫–∏–π —É–≥–æ–ª –æ–±–∑–æ—Ä–∞ –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–π –º–æ–¥–µ–ª–∏
				camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 100)
				camera.position.set(0, 0.3, 1.5) // –ë–ª–∏–∂–µ –∏ –≤—ã—à–µ

				// 3. –†–µ–Ω–¥–µ—Ä–µ—Ä
				renderer = new THREE.WebGLRenderer({
					canvas: window.elements.canvas,
					alpha: true,
					antialias: true,
					preserveDrawingBuffer: true,
				})
				renderer.setSize(width, height)
				renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2))
				renderer.setClearColor(0x000000, 0)

				// 4. –û—Å–≤–µ—â–µ–Ω–∏–µ
				const ambientLight = new THREE.AmbientLight(0xffffff, 1)
				scene.add(ambientLight)

				const directionalLight = new THREE.DirectionalLight(0xffffff, 1)
				directionalLight.position.set(1, 2, 3)
				scene.add(directionalLight)
			}

			// ===== –°–û–ó–î–ê–ù–ò–ï –ú–û–î–ï–õ–ò (–ú–ê–õ–ï–ù–¨–ö–û–ô) =====
			function createModel() {
				// –°–æ–∑–¥–∞–µ–º –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫—É—é –º–æ–¥–µ–ª—å
				const group = new THREE.Group()

				// –¢–µ–ª–æ
				const bodyGeometry = new THREE.BoxGeometry(0.15, 0.1, 0.3)
				const bodyMaterial = new THREE.MeshPhongMaterial({
					color: 0x8b4513,
					shininess: 30,
				})
				const body = new THREE.Mesh(bodyGeometry, bodyMaterial)
				body.position.set(0, 0.05, 0)
				group.add(body)

				// –ì–æ–ª–æ–≤–∞
				const headGeometry = new THREE.SphereGeometry(0.06, 16, 16)
				const headMaterial = new THREE.MeshPhongMaterial({
					color: 0x8b4513,
					shininess: 30,
				})
				const head = new THREE.Mesh(headGeometry, headMaterial)
				head.position.set(0, 0.1, 0.2)
				group.add(head)

				// –ù–æ–≥–∏
				const legGeometry = new THREE.CylinderGeometry(0.015, 0.015, 0.15, 8)
				const legMaterial = new THREE.MeshPhongMaterial({
					color: 0x8b4513,
					shininess: 30,
				})

				// –ü–æ–∑–∏—Ü–∏–∏ –Ω–æ–≥
				const legPositions = [
					[-0.06, -0.05, 0.08], // –ø–µ—Ä–µ–¥–Ω—è—è –ª–µ–≤–∞—è
					[0.06, -0.05, 0.08], // –ø–µ—Ä–µ–¥–Ω—è—è –ø—Ä–∞–≤–∞—è
					[-0.06, -0.05, -0.08], // –∑–∞–¥–Ω—è—è –ª–µ–≤–∞—è
					[0.06, -0.05, -0.08], // –∑–∞–¥–Ω—è—è –ø—Ä–∞–≤–∞—è
				]

				legPositions.forEach(pos => {
					const leg = new THREE.Mesh(legGeometry, legMaterial)
					leg.position.set(pos[0], pos[1], pos[2])
					group.add(leg)
				})

				model = group
				model.scale.set(0.8, 0.8, 0.8) // –ú–∞–ª–µ–Ω—å–∫–∏–π –º–∞—Å—à—Ç–∞–±
				model.position.set(0, -0.2, 0) // –ù–∏–∑–∫–æ
				scene.add(model)

				console.log('–ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞ (–º–∞–ª–µ–Ω—å–∫–∞—è)')
			}

			// ===== –ö–ê–ú–ï–†–ê –£–°–¢–†–û–ô–°–¢–í–ê =====
			async function startCamera() {
				try {
					// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫
					if (videoStream) {
						videoStream.getTracks().forEach(track => track.stop())
					}

					window.elements.status.textContent = '–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...'

					const constraints = {
						video: {
							facingMode: currentCamera,
							width: { ideal: 1280 },
							height: { ideal: 720 },
						},
						audio: false,
					}

					videoStream = await navigator.mediaDevices.getUserMedia(constraints)
					window.elements.video.srcObject = videoStream

					// –ñ–¥–µ–º –ø–æ–∫–∞ –≤–∏–¥–µ–æ –Ω–∞—á–Ω–µ—Ç –∏–≥—Ä–∞—Ç—å
					await new Promise(resolve => {
						window.elements.video.onloadedmetadata = () => {
							window.elements.video.play().then(resolve).catch(resolve)
						}
					})

					console.log('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error)
					// –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–æ–Ω
					window.elements.video.style.display = 'none'
					window.elements.container.style.background = '#333'
					throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.')
				}
			}

			// ===== –°–û–ë–´–¢–ò–Ø =====
			function setupEvents() {
				// –°–º–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞
				window.elements.container.addEventListener('click', () => {
					if (!isFilterChanged && !isARMode) {
						isFilterChanged = true
						window.elements.filter1.style.opacity = '0'
						window.elements.filter2.style.opacity = '1'
						window.elements.container.style.cursor = 'default'
						console.log('–§–∏–ª—å—Ç—Ä –∏–∑–º–µ–Ω–µ–Ω')
					}
				})

				// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
				window.elements.switchBtn.addEventListener('click', () => {
					currentCamera =
						currentCamera === 'environment' ? 'user' : 'environment'
					startCamera()
				})

				// –°–∫—Ä–∏–Ω—à–æ—Ç
				window.elements.screenshotBtn.addEventListener('click', takeScreenshot)

				// AR —Ä–µ–∂–∏–º
				window.elements.arButton.addEventListener('click', () => {
					alert(
						'–î–ª—è —Ä–∞–±–æ—Ç—ã AR —Ä–µ–∂–∏–º–∞:\n\n1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ HTTPS\n2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –Ω–∞ Android –∏–ª–∏ Safari –Ω–∞ iOS\n3. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ\n\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–µ localhost)'
					)
				})

				// –†–µ—Å–∞–π–∑ –æ–∫–Ω–∞
				window.addEventListener('resize', onResize)

				// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
				window.addEventListener('error', e => {
					console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', e.error)
					window.elements.status.textContent = '–û—à–∏–±–∫–∞: ' + e.message
				})
			}

			// ===== –°–ö–†–ò–ù–®–û–¢ =====
			function takeScreenshot() {
				// –í—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
				const controls = document.querySelector('.controls')
				const arInstruction = window.elements.arInstruction
				const status = window.elements.status

				const controlsVisible = controls.style.visibility
				const instructionVisible = arInstruction.style.visibility
				const statusVisible = status.style.visibility

				controls.style.visibility = 'hidden'
				arInstruction.style.visibility = 'hidden'
				status.style.visibility = 'hidden'

				setTimeout(() => {
					// –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas
					const tempCanvas = document.createElement('canvas')
					tempCanvas.width = window.elements.canvas.width
					tempCanvas.height = window.elements.canvas.height
					const ctx = tempCanvas.getContext('2d')

					// –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω
					ctx.fillStyle = '#000'
					ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height)

					// –í–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã (–∑–µ—Ä–∫–∞–ª—å–Ω–æ–µ)
					if (window.elements.video.videoWidth > 0) {
						// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
						ctx.save()
						// –û—Ç—Ä–∞–∂–∞–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
						ctx.scale(-1, 1)
						ctx.drawImage(
							window.elements.video,
							-tempCanvas.width,
							0,
							tempCanvas.width,
							tempCanvas.height
						)
						ctx.restore()
					}

					// 3D –º–æ–¥–µ–ª—å
					ctx.drawImage(window.elements.canvas, 0, 0)

					// –ê–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
					const activeFilter =
						window.elements.filter1.style.opacity === '1'
							? window.elements.filter1
							: window.elements.filter2
					ctx.globalCompositeOperation = 'screen'
					ctx.drawImage(activeFilter, 0, 0, tempCanvas.width, tempCanvas.height)

					// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
					const link = document.createElement('a')
					link.download = `model-${Date.now()}.png`
					link.href = tempCanvas.toDataURL('image/png')
					link.click()

					// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
					window.elements.status.textContent = '–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!'
					setTimeout(() => {
						window.elements.status.textContent = '–ì–æ—Ç–æ–≤–æ!'
					}, 2000)

					// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
					controls.style.visibility = controlsVisible
					arInstruction.style.visibility = instructionVisible
					status.style.visibility = statusVisible
				}, 100)
			}

			// ===== –ê–ù–ò–ú–ê–¶–ò–Ø =====
			function animate() {
				requestAnimationFrame(animate)

				// –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
				if (model && !isARMode) {
					model.rotation.y += 0.005
				}

				// –†–µ–Ω–¥–µ—Ä
				if (renderer && scene && camera) {
					renderer.render(scene, camera)
				}
			}

			// ===== –†–ï–°–ê–ô–ó =====
			function onResize() {
				if (!window.elements.container) return

				const width = window.elements.container.clientWidth
				const height = window.elements.container.clientHeight

				if (camera && renderer) {
					camera.aspect = width / height
					camera.updateProjectionMatrix()
					renderer.setSize(width, height)
				}
			}

			// ===== –û–ß–ò–°–¢–ö–ê =====
			function cleanup() {
				if (videoStream) {
					videoStream.getTracks().forEach(track => track.stop())
				}
			}

			// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
			window.addEventListener('beforeunload', cleanup)

			// –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
			let initialized = false
			if (!initialized) {
				initialized = true
			}
		</script>
	</body>
</html>

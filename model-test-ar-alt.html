<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, viewport-fit=cover"
		/>
		<title>AR –ú–æ–¥–µ–ª—å –õ–æ—à–∞–¥–∏</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, sans-serif;
				background: #000;
				color: white;
				height: 100vh;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				overflow: hidden;
			}

			.header {
				text-align: center;
				padding: 20px;
				z-index: 1000;
			}

			h1 {
				font-size: 24px;
				margin-bottom: 10px;
			}

			#status {
				font-size: 14px;
				color: #aaa;
				min-height: 20px;
			}

			#container {
				position: relative;
				width: 100vw;
				height: 100vh;
				overflow: hidden;
			}

			/* –í–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã (—Ç–æ–ª—å–∫–æ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ) */
			#camera-video {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				object-fit: cover;
				z-index: 1;
				display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ */
			}

			/* Canvas –¥–ª—è Three.js */
			#renderCanvas {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				display: block;
				z-index: 2;
			}

			/* –§–∏–ª—å—Ç—Ä—ã (—Ç–æ–ª—å–∫–æ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ) */
			.filter-overlay {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: 3;
				mix-blend-mode: screen;
				pointer-events: none;
				opacity: 1;
				transition: opacity 0.5s ease;
			}

			#filter2 {
				opacity: 0;
			}

			/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
			.controls {
				position: fixed;
				bottom: 30px;
				left: 0;
				right: 0;
				display: flex;
				justify-content: center;
				gap: 15px;
				z-index: 1000;
			}

			button {
				background: rgba(0, 0, 0, 0.7);
				border: 2px solid rgba(255, 255, 255, 0.3);
				color: white;
				padding: 12px 24px;
				border-radius: 50px;
				font-size: 16px;
				cursor: pointer;
				backdrop-filter: blur(10px);
				transition: all 0.2s ease;
			}

			button:hover {
				background: rgba(0, 0, 0, 0.9);
				border-color: white;
			}

			#ar-button {
				background: linear-gradient(135deg, #667eea, #764ba2);
				border: none;
				font-weight: 600;
				box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
			}

			/* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è AR */
			.ar-instruction {
				position: fixed;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: rgba(0, 0, 0, 0.8);
				color: white;
				padding: 20px 30px;
				border-radius: 20px;
				font-size: 18px;
				text-align: center;
				z-index: 1000;
				display: none;
				max-width: 80%;
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.2);
			}

			/* –ö–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è AR */
			.ar-controls {
				position: fixed;
				bottom: 100px;
				left: 0;
				right: 0;
				display: flex;
				justify-content: center;
				gap: 20px;
				z-index: 1000;
				display: none;
			}

			.ar-control-btn {
				width: 60px;
				height: 60px;
				border-radius: 50%;
				background: rgba(0, 0, 0, 0.7);
				border: 2px solid white;
				color: white;
				font-size: 24px;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				transition: all 0.2s ease;
			}

			.ar-control-btn:hover {
				background: rgba(255, 255, 255, 0.2);
				transform: scale(1.1);
			}

			/* –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
			.hidden {
				display: none !important;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1>AR –ú–æ–¥–µ–ª—å –õ–æ—à–∞–¥–∏</h1>
			<div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
		</div>

		<div id="container">
			<video id="camera-video" autoplay playsinline muted></video>
			<canvas id="renderCanvas"></canvas>
			<img
				class="filter-overlay"
				id="filter1"
				src="./assets/ice-1.png"
				alt="–§–∏–ª—å—Ç—Ä"
			/>
			<img
				class="filter-overlay"
				id="filter2"
				src="./assets/ice-4.png"
				alt="–§–∏–ª—å—Ç—Ä"
			/>
		</div>

		<div class="controls">
			<button id="switch-camera">üì∑ –ö–∞–º–µ—Ä–∞</button>
			<button id="screenshot">üì∏ –°–Ω–∏–º–æ–∫</button>
			<button id="ar-button">üöÄ AR –†–µ–∂–∏–º</button>
		</div>

		<div class="ar-instruction" id="ar-instruction">
			–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å<br />
			–∏ –∫–æ—Å–Ω–∏—Ç–µ—Å—å —ç–∫—Ä–∞–Ω–∞, —á—Ç–æ–±—ã —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –º–æ–¥–µ–ª—å
		</div>

		<div class="ar-controls" id="ar-controls">
			<div class="ar-control-btn" id="ar-rotate">‚Üª</div>
			<div class="ar-control-btn" id="ar-scale">‚äï</div>
			<div class="ar-control-btn" id="ar-exit">‚úï</div>
		</div>

		<!-- Three.js –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏ -->
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

		<script>
			// ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
			let scene, camera, renderer, model, mixer
			let videoStream = null
			let isFilterChanged = false
			let currentCamera = 'environment'
			let arSession = null
			let isARMode = false
			let hitTestSource = null
			let modelPlaced = false
			let modelScale = 1
			let modelRotation = 0
			let reticle = null
			let controls = null

			// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
			const elements = {
				video: document.getElementById('camera-video'),
				canvas: document.getElementById('renderCanvas'),
				filter1: document.getElementById('filter1'),
				filter2: document.getElementById('filter2'),
				switchBtn: document.getElementById('switch-camera'),
				screenshotBtn: document.getElementById('screenshot'),
				arButton: document.getElementById('ar-button'),
				status: document.getElementById('status'),
				arInstruction: document.getElementById('ar-instruction'),
				arControls: document.getElementById('ar-controls'),
				arRotateBtn: document.getElementById('ar-rotate'),
				arScaleBtn: document.getElementById('ar-scale'),
				arExitBtn: document.getElementById('ar-exit'),
			}

			// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
			async function init() {
				try {
					console.log('=== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===')

					// 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É AR
					await checkARSupport()

					// 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Three.js
					initThreeJS()

					// 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
					await startCamera()

					// 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å –ª–æ—à–∞–¥–∏
					await loadModel()

					// 5. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
					setupEvents()

					// 6. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
					animate()

					elements.status.textContent =
						'–ì–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –¥–ª—è —Å–º–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä–∞.'
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error)
					elements.status.textContent = '–û—à–∏–±–∫–∞: ' + error.message
				}
			}

			// ========== –ü–†–û–í–ï–†–ö–ê AR ==========
			async function checkARSupport() {
				if (!('xr' in navigator)) {
					console.log('WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è')
					elements.arButton.classList.add('hidden')
					return
				}

				try {
					const supported = await navigator.xr.isSessionSupported(
						'immersive-ar'
					)
					if (supported) {
						console.log('AR –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è')
					} else {
						console.log('AR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è')
						elements.arButton.classList.add('hidden')
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ AR:', error)
					elements.arButton.classList.add('hidden')
				}
			}

			// ========== THREE.JS ==========
			function initThreeJS() {
				// 1. –°—Ü–µ–Ω–∞
				scene = new THREE.Scene()

				// 2. –ö–∞–º–µ—Ä–∞
				camera = new THREE.PerspectiveCamera(
					60,
					window.innerWidth / window.innerHeight,
					0.1,
					100
				)
				camera.position.set(0, 1.5, 3)

				// 3. –†–µ–Ω–¥–µ—Ä–µ—Ä
				renderer = new THREE.WebGLRenderer({
					canvas: elements.canvas,
					alpha: true,
					antialias: true,
					preserveDrawingBuffer: true,
				})
				renderer.setSize(window.innerWidth, window.innerHeight)
				renderer.setPixelRatio(window.devicePixelRatio)
				renderer.setClearColor(0x000000, 0)
				renderer.shadowMap.enabled = true
				renderer.shadowMap.type = THREE.PCFSoftShadowMap

				// 4. –í–∫–ª—é—á–∞–µ–º WebXR
				renderer.xr.enabled = true

				// 5. –û—Å–≤–µ—â–µ–Ω–∏–µ
				const ambientLight = new THREE.AmbientLight(0xffffff, 1.0)
				scene.add(ambientLight)

				const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5)
				directionalLight.position.set(5, 10, 7)
				directionalLight.castShadow = true
				directionalLight.shadow.camera.near = 0.5
				directionalLight.shadow.camera.far = 50
				directionalLight.shadow.mapSize.width = 1024
				directionalLight.shadow.mapSize.height = 1024
				scene.add(directionalLight)

				// 6. –°–æ–∑–¥–∞–µ–º —Ä–µ—Ç–∏–∫—É–ª (—É–∫–∞–∑–∞—Ç–µ–ª—å) –¥–ª—è AR
				createReticle()
			}

			// ========== –°–û–ó–î–ê–ù–ò–ï –†–ï–¢–ò–ö–£–õ–ê –î–õ–Ø AR ==========
			function createReticle() {
				const geometry = new THREE.RingGeometry(0.1, 0.2, 32)
				const material = new THREE.MeshBasicMaterial({
					color: 0xffffff,
					transparent: true,
					opacity: 0.8,
				})
				reticle = new THREE.Mesh(geometry, material)
				reticle.matrixAutoUpdate = false
				reticle.visible = false
				scene.add(reticle)
			}

			// ========== –ó–ê–ì–†–£–ó–ö–ê –ú–û–î–ï–õ–ò –õ–û–®–ê–î–ò ==========
			async function loadModel() {
				return new Promise((resolve, reject) => {
					elements.status.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –ª–æ—à–∞–¥–∏...'

					const loader = new THREE.GLTFLoader()

					loader.load(
						'./assets/model/Horse_animation.gltf',
						gltf => {
							console.log('–ú–æ–¥–µ–ª—å –ª–æ—à–∞–¥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ')
							model = gltf.scene

							// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏
							model.scale.set(0.3, 0.3, 0.3)
							model.position.set(0, -1, 0)
							model.rotation.y = Math.PI / 4

							// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–Ω–µ–π –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
							model.traverse(child => {
								if (child.isMesh) {
									child.castShadow = true
									child.receiveShadow = true

									// –£–ª—É—á—à–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã
									if (child.material) {
										child.material.metalness = 0.1
										child.material.roughness = 0.8
									}
								}
							})

							scene.add(model)

							// –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏
							if (gltf.animations && gltf.animations.length > 0) {
								console.log('–ê–Ω–∏–º–∞—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω—ã:', gltf.animations.length)
								mixer = new THREE.AnimationMixer(model)

								// –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∞–Ω–∏–º–∞—Ü–∏—é
								const action = mixer.clipAction(gltf.animations[0])
								action.play()
								mixer.timeScale = 0.7
							}

							elements.status.textContent = '–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞'
							resolve()
						},
						progress => {
							const percent = Math.round(
								(progress.loaded / progress.total) * 100
							)
							elements.status.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${percent}%`
						},
						error => {
							console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:', error)
							createFallbackModel()
							resolve()
						}
					)
				})
			}

			// ========== –ó–ê–ü–£–°–ö –ö–ê–ú–ï–†–´ –£–°–¢–†–û–ô–°–¢–í–ê ==========
			async function startCamera() {
				try {
					if (videoStream) {
						videoStream.getTracks().forEach(track => track.stop())
					}

					elements.status.textContent = '–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...'

					const constraints = {
						video: {
							facingMode: currentCamera,
							width: { ideal: 1280 },
							height: { ideal: 720 },
						},
						audio: false,
					}

					videoStream = await navigator.mediaDevices.getUserMedia(constraints)
					elements.video.srcObject = videoStream

					await new Promise(resolve => {
						elements.video.onloadedmetadata = () => {
							elements.video.play().then(resolve)
						}
					})

					// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
					elements.video.style.display = 'block'
					console.log('–ö–∞–º–µ—Ä–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∑–∞–ø—É—â–µ–Ω–∞')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', error)
					throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É')
				}
			}

			// ========== AR –†–ï–ñ–ò–ú ==========
			async function startAR() {
				if (!('xr' in navigator)) {
					alert(
						'AR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –Ω–∞ Android –∏–ª–∏ Safari –Ω–∞ iOS.'
					)
					return
				}

				try {
					elements.status.textContent = '–ó–∞–ø—É—Å–∫ AR...'

					// –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º AR —Å–µ—Å—Å–∏—é
					arSession = await navigator.xr.requestSession('immersive-ar', {
						requiredFeatures: ['hit-test'],
						optionalFeatures: ['dom-overlay'],
						domOverlay: { root: document.body },
					})

					// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é –≤ —Ä–µ–Ω–¥–µ—Ä–µ—Ä
					await renderer.xr.setSession(arSession)

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º hit-test
					await initializeHitTest()

					// –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ AR —Ä–µ–∂–∏–º
					enterARMode()

					// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
					arSession.addEventListener('end', onSessionEnd)
					arSession.addEventListener('select', onARSelect)

					console.log('AR —Å–µ—Å—Å–∏—è –∑–∞–ø—É—â–µ–Ω–∞')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ AR:', error)
					elements.status.textContent = '–û—à–∏–±–∫–∞ AR: ' + error.message
				}
			}

			async function initializeHitTest() {
				const session = renderer.xr.getSession()

				// –ü–æ–ª—É—á–∞–µ–º reference space
				const referenceSpace = await session.requestReferenceSpace('viewer')

				// –°–æ–∑–¥–∞–µ–º hit test source
				const hitTestSource = await session.requestHitTestSource({
					space: referenceSpace,
				})

				// –°–æ–∑–¥–∞–µ–º hit test source –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ (–¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è)
				const localSpace = await session.requestReferenceSpace('local')
				const localHitTestSource = await session.requestHitTestSource({
					space: localSpace,
				})

				// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ hit-test
				window.hitTestSource = hitTestSource
				window.localHitTestSource = localHitTestSource
				window.referenceSpace = referenceSpace
				window.localSpace = localSpace
			}

			function enterARMode() {
				isARMode = true
				modelPlaced = false

				// –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
				elements.video.style.display = 'none'
				elements.filter1.style.display = 'none'
				elements.filter2.style.display = 'none'

				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏ –∫–æ–Ω—Ç—Ä–æ–ª—ã
				elements.arInstruction.style.display = 'block'
				elements.arControls.style.display = 'flex'

				// –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–µ–ª—å –¥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
				if (model) {
					model.visible = false
				}

				// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
				if (videoStream) {
					videoStream.getTracks().forEach(track => track.stop())
					videoStream = null
				}

				elements.status.textContent = 'AR —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω'
			}

			function exitARMode() {
				if (arSession) {
					arSession.end()
				}
			}

			function onSessionEnd() {
				isARMode = false
				arSession = null
				modelPlaced = false

				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –∏ —Ñ–∏–ª—å—Ç—Ä—ã
				elements.video.style.display = 'block'
				elements.filter1.style.display = 'block'
				elements.filter2.style.display = 'block'

				// –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏ –∫–æ–Ω—Ç—Ä–æ–ª—ã
				elements.arInstruction.style.display = 'none'
				elements.arControls.style.display = 'none'

				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–µ–ª—å
				if (model) {
					model.visible = true
					model.scale.set(0.3, 0.3, 0.3)
					model.position.set(0, -1, 0)
				}

				// –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
				setTimeout(() => {
					startCamera()
				}, 100)

				elements.status.textContent = 'AR —Ä–µ–∂–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω'
			}

			function onARSelect(event) {
				if (!modelPlaced && model) {
					placeModel(event)
				}
			}

			function placeModel(event) {
				const frame = event.frame
				const referenceSpace = renderer.xr.getReferenceSpace()

				// –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã hit-test
				const hitTestResults = frame.getHitTestResults(
					window.localHitTestSource
				)

				if (hitTestResults.length > 0) {
					const hit = hitTestResults[0]
					const pose = hit.getPose(referenceSpace)

					if (pose) {
						// –†–∞–∑–º–µ—â–∞–µ–º –º–æ–¥–µ–ª—å
						model.position.set(
							pose.transform.position.x,
							pose.transform.position.y,
							pose.transform.position.z
						)

						model.visible = true
						modelPlaced = true
						elements.arInstruction.style.display = 'none'

						console.log('–ú–æ–¥–µ–ª—å —Ä–∞–∑–º–µ—â–µ–Ω–∞ –≤ AR')
					}
				}
			}

			function updateARModel(frame) {
				if (!isARMode || !window.hitTestSource || !reticle) return

				const referenceSpace = renderer.xr.getReferenceSpace()
				const hitTestResults = frame.getHitTestResults(window.hitTestSource)

				if (hitTestResults.length > 0) {
					const hit = hitTestResults[0]
					const pose = hit.getPose(referenceSpace)

					// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ä–µ—Ç–∏–∫—É–ª–∞
					reticle.visible = true
					reticle.matrix.fromArray(pose.transform.matrix)
				} else {
					reticle.visible = false
				}

				// –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –º–æ–¥–µ–ª–∏
				if (mixer && modelPlaced) {
					const time = frame.getPose(referenceSpace).transform.position.x // –ü—Ä–æ—Å—Ç–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
					mixer.update(0.016) // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–µ–ª—å—Ç–∞-—Ç–∞–π–º
				}
			}

			// ========== –°–û–ë–´–¢–ò–Ø ==========
			function setupEvents() {
				// –°–º–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞
				document.addEventListener('click', e => {
					if (!isFilterChanged && !isARMode && e.target === elements.canvas) {
						isFilterChanged = true
						elements.filter1.style.opacity = '0'
						elements.filter2.style.opacity = '1'
					}
				})

				// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
				elements.switchBtn.addEventListener('click', () => {
					currentCamera =
						currentCamera === 'environment' ? 'user' : 'environment'
					startCamera()
				})

				// –°–∫—Ä–∏–Ω—à–æ—Ç
				elements.screenshotBtn.addEventListener('click', takeScreenshot)

				// AR —Ä–µ–∂–∏–º
				elements.arButton.addEventListener('click', startAR)

				// AR –∫–æ–Ω—Ç—Ä–æ–ª—ã
				elements.arRotateBtn.addEventListener('click', () => {
					if (model && modelPlaced) {
						modelRotation += Math.PI / 4
						model.rotation.y = modelRotation
					}
				})

				elements.arScaleBtn.addEventListener('click', () => {
					if (model && modelPlaced) {
						modelScale = modelScale === 1 ? 1.5 : modelScale === 1.5 ? 0.7 : 1
						model.scale.set(
							0.3 * modelScale,
							0.3 * modelScale,
							0.3 * modelScale
						)
					}
				})

				elements.arExitBtn.addEventListener('click', exitARMode)

				// –†–µ—Å–∞–π–∑ –æ–∫–Ω–∞
				window.addEventListener('resize', onResize)

				// –ñ–µ—Å—Ç—ã –¥–ª—è AR
				let touchStartX, touchStartY
				let isTouchingModel = false

				elements.canvas.addEventListener('touchstart', e => {
					if (isARMode && modelPlaced && e.touches.length === 1) {
						touchStartX = e.touches[0].clientX
						touchStartY = e.touches[0].clientY

						// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–æ—Å–Ω—É–ª–∏—Å—å –ª–∏ –º–æ–¥–µ–ª–∏ (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É —ç–∫—Ä–∞–Ω–∞)
						const rect = elements.canvas.getBoundingClientRect()
						const centerX = rect.width / 2
						const centerY = rect.height / 2
						const touchX = e.touches[0].clientX - rect.left
						const touchY = e.touches[0].clientY - rect.top

						// –ï—Å–ª–∏ –∫–∞—Å–∞–Ω–∏–µ —Ä—è–¥–æ–º —Å —Ü–µ–Ω—Ç—Ä–æ–º (–≥–¥–µ –æ–±—ã—á–Ω–æ –º–æ–¥–µ–ª—å)
						if (
							Math.abs(touchX - centerX) < 100 &&
							Math.abs(touchY - centerY) < 100
						) {
							isTouchingModel = true
						}
					}
				})

				elements.canvas.addEventListener('touchmove', e => {
					if (
						isARMode &&
						modelPlaced &&
						isTouchingModel &&
						e.touches.length === 1
					) {
						const touchX = e.touches[0].clientX
						const deltaX = touchX - touchStartX

						// –í—Ä–∞—â–∞–µ–º –º–æ–¥–µ–ª—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–∞–ª—å—Ü–∞
						modelRotation += deltaX * 0.01
						model.rotation.y = modelRotation

						touchStartX = touchX
					}
				})

				elements.canvas.addEventListener('touchend', () => {
					isTouchingModel = false
				})
			}

			// ========== –°–ö–†–ò–ù–®–û–¢ ==========
			function takeScreenshot() {
				if (isARMode) {
					// –í AR —Ä–µ–∂–∏–º–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å WebXR
					const image = renderer.domElement.toDataURL('image/png')
					downloadImage(image, 'ar-model')
				} else {
					// –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –∫–æ–º–±–∏–Ω–∏—Ä—É–µ–º –≤–∏–¥–µ–æ –∏ 3D
					const tempCanvas = document.createElement('canvas')
					tempCanvas.width = elements.canvas.width
					tempCanvas.height = elements.canvas.height
					const ctx = tempCanvas.getContext('2d')

					// –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω
					ctx.fillStyle = '#000'
					ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height)

					// –í–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã
					ctx.drawImage(
						elements.video,
						0,
						0,
						tempCanvas.width,
						tempCanvas.height
					)

					// 3D –º–æ–¥–µ–ª—å
					ctx.drawImage(elements.canvas, 0, 0)

					// –ê–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
					const activeFilter =
						elements.filter1.style.opacity === '1'
							? elements.filter1
							: elements.filter2
					ctx.globalCompositeOperation = 'screen'
					ctx.drawImage(activeFilter, 0, 0, tempCanvas.width, tempCanvas.height)

					const image = tempCanvas.toDataURL('image/png')
					downloadImage(image, '3d-model')
				}

				elements.status.textContent = '–°–Ω–∏–º–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!'
				setTimeout(() => {
					elements.status.textContent = isARMode ? 'AR —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω' : '–ì–æ—Ç–æ–≤–æ'
				}, 2000)
			}

			function downloadImage(dataUrl, filename) {
				const link = document.createElement('a')
				link.download = `${filename}-${Date.now()}.png`
				link.href = dataUrl
				link.click()
			}

			// ========== –ê–ù–ò–ú–ê–¶–ò–Ø ==========
			function animate(time) {
				requestAnimationFrame(animate)

				// –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –º–æ–¥–µ–ª–∏
				if (mixer && !isARMode) {
					const delta = time ? time * 0.001 : 0.016
					mixer.update(delta)
				}

				// –í—Ä–∞—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
				if (model && !isARMode) {
					model.rotation.y += 0.005
				}

				// –í AR —Ä–µ–∂–∏–º–µ –æ–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–µ–ª—å –∏ —Ä–µ—Ç–∏–∫—É–ª
				if (isARMode && renderer.xr.isPresenting) {
					const frame = renderer.xr.getFrame()
					updateARModel(frame)
				}

				renderer.render(scene, camera)
			}

			// ========== –†–ï–°–ê–ô–ó ==========
			function onResize() {
				camera.aspect = window.innerWidth / window.innerHeight
				camera.updateProjectionMatrix()
				renderer.setSize(window.innerWidth, window.innerHeight)
			}

			// ========== –û–ß–ò–°–¢–ö–ê ==========
			function cleanup() {
				if (videoStream) {
					videoStream.getTracks().forEach(track => track.stop())
				}
				if (arSession) {
					arSession.end()
				}
			}

			// ========== –ó–ê–ü–£–°–ö ==========
			window.addEventListener('load', init)
			window.addEventListener('beforeunload', cleanup)
		</script>
	</body>
</html>
